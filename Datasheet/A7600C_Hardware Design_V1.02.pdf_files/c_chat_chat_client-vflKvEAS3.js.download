define(["require","exports","./c_apex-metrics_src_types","./c_csrf","./c_core_notify","./e_file_viewer_edison_shmodel_file_async","./e_edison","./c_core_i18n","./c_tslib","react-dom","react","./c_ncct_manual_assist_util","./c_src_sink_index"],(function(t,e,i,a,s,n,r,o,h,c,d,p,m){"use strict";function g(t){return t&&t.__esModule?t:{default:t}}function l(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var a=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,a.get?a:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var _,u,C,S,T=l(c),E=g(d);e.ChatProviderType=void 0,(_=e.ChatProviderType||(e.ChatProviderType={}))[_.SNAPENGAGE=0]="SNAPENGAGE",_[_.DIALOGUE_CHAT=1]="DIALOGUE_CHAT",_[_.SOLVVY=2]="SOLVVY",i.proto3.util.setEnumType(e.ChatProviderType,"chat.ChatProviderType",[{no:0,name:"SNAPENGAGE"},{no:1,name:"DIALOGUE_CHAT"},{no:2,name:"SOLVVY"}]),e.ProactiveMessageType=void 0,function(t){t[t.DEFAULT=0]="DEFAULT",t[t.MINIMIZED_PROACTIVE=1]="MINIMIZED_PROACTIVE"}(e.ProactiveMessageType||(e.ProactiveMessageType={})),i.proto3.util.setEnumType(e.ProactiveMessageType,"chat.ProactiveMessageType",[{no:0,name:"DEFAULT"},{no:1,name:"MINIMIZED_PROACTIVE"}]),e.ChatInitialState=void 0,(u=e.ChatInitialState||(e.ChatInitialState={}))[u.HIDDEN=0]="HIDDEN",u[u.SHOW_PROVIDER_REACTIVE_BUTTON=1]="SHOW_PROVIDER_REACTIVE_BUTTON",i.proto3.util.setEnumType(e.ChatInitialState,"chat.ChatInitialState",[{no:0,name:"HIDDEN"},{no:1,name:"SHOW_PROVIDER_REACTIVE_BUTTON"}]),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.LEX=1]="LEX",t[t.RASA=2]="RASA"}(C||(C={})),i.proto3.util.setEnumType(C,"chat.DialogueBotProvider",[{no:0,name:"UNKNOWN"},{no:1,name:"LEX"},{no:2,name:"RASA"}]),function(t){t[t.CX_SUPPORT=0]="CX_SUPPORT",t[t.BUSINESS=1]="BUSINESS",t[t.CX_SPECIALIZED=2]="CX_SPECIALIZED",t[t.SCALED_ONBOARDING=3]="SCALED_ONBOARDING"}(S||(S={})),i.proto3.util.setEnumType(S,"chat.DialogueBotType",[{no:0,name:"CX_SUPPORT"},{no:1,name:"BUSINESS"},{no:2,name:"CX_SPECIALIZED"},{no:3,name:"SCALED_ONBOARDING"}]);class v extends i.Message{constructor(t){super(),this.cookieDomain="",this.cookieCampaignName="",this.legacyCookieCampaignName="",i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new v).fromBinary(t,e)}static fromJson(t,e){return(new v).fromJson(t,e)}static fromJsonString(t,e){return(new v).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(v,t,e)}}v.runtime=i.proto3,v.typeName="chat.ChatMetadata",v.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"cookie_domain",kind:"scalar",T:9},{no:2,name:"cookie_campaign_name",kind:"scalar",T:9},{no:3,name:"legacy_cookie_campaign_name",kind:"scalar",T:9}]));class A extends i.Message{constructor(t){super(),this.snapengageIframeOrigin="",i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new A).fromBinary(t,e)}static fromJson(t,e){return(new A).fromJson(t,e)}static fromJsonString(t,e){return(new A).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(A,t,e)}}A.runtime=i.proto3,A.typeName="chat.SnapengageChatMetadata",A.fields=i.proto3.util.newFieldList((()=>[{no:4,name:"snapengage_iframe_origin",kind:"scalar",T:9}]));class O extends i.Message{constructor(t){super(),this.solvvyIframeOrigin="",i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new O).fromBinary(t,e)}static fromJson(t,e){return(new O).fromJson(t,e)}static fromJsonString(t,e){return(new O).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(O,t,e)}}O.runtime=i.proto3,O.typeName="chat.SolvvyChatMetadata",O.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"solvvy_iframe_origin",kind:"scalar",T:9}]));class I extends i.Message{constructor(t){super(),this.chatHmac="",this.email="",this.firstName="",this.lastName="",this.pageLoadTs="",this.pricings=[],this.sessionId="",this.userId="",this.serviceTier="",this.experiments={},this.locale="",this.countryCode="",this.authToken="",i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new I).fromBinary(t,e)}static fromJson(t,e){return(new I).fromJson(t,e)}static fromJsonString(t,e){return(new I).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(I,t,e)}}I.runtime=i.proto3,I.typeName="chat.UserProperties",I.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"chat_hmac",kind:"scalar",T:9},{no:2,name:"email",kind:"scalar",T:9},{no:3,name:"first_name",kind:"scalar",T:9},{no:4,name:"last_name",kind:"scalar",T:9},{no:5,name:"page_load_ts",kind:"scalar",T:9},{no:6,name:"pricings",kind:"scalar",T:9,repeated:!0},{no:7,name:"session_id",kind:"scalar",T:9},{no:8,name:"user_id",kind:"scalar",T:9},{no:9,name:"service_tier",kind:"scalar",T:9},{no:10,name:"experiments",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:11,name:"locale",kind:"scalar",T:9},{no:12,name:"country_code",kind:"scalar",T:9},{no:13,name:"auth_token",kind:"scalar",T:9}]));class f extends i.Message{constructor(t){super(),this.widgetId="",i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new f).fromBinary(t,e)}static fromJson(t,e){return(new f).fromJson(t,e)}static fromJsonString(t,e){return(new f).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(f,t,e)}}f.runtime=i.proto3,f.typeName="chat.SnapengageChatSystemSettings",f.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"widget_id",kind:"scalar",T:9}]));class R extends i.Message{constructor(t){super(),this.name="",this.active=!1,i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new R).fromBinary(t,e)}static fromJson(t,e){return(new R).fromJson(t,e)}static fromJsonString(t,e){return(new R).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(R,t,e)}}R.runtime=i.proto3,R.typeName="chat.DialogueExperiment",R.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"name",kind:"scalar",T:9},{no:2,name:"active",kind:"scalar",T:8}]));class N extends i.Message{constructor(t){super(),this.botProvider=C.UNKNOWN,this.environment="",this.settingsHmac="",this.experiments=[],this.botType=S.CX_SUPPORT,this.proactiveIntent="",this.portaled=!1,i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new N).fromBinary(t,e)}static fromJson(t,e){return(new N).fromJson(t,e)}static fromJsonString(t,e){return(new N).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(N,t,e)}}N.runtime=i.proto3,N.typeName="chat.DialogueChatSystemSettings",N.fields=i.proto3.util.newFieldList((()=>[{no:2,name:"bot_provider",kind:"enum",T:i.proto3.getEnumType(C)},{no:3,name:"environment",kind:"scalar",T:9},{no:4,name:"settings_hmac",kind:"scalar",T:9},{no:5,name:"experiments",kind:"message",T:R,repeated:!0},{no:6,name:"bot_type",kind:"enum",T:i.proto3.getEnumType(S)},{no:7,name:"proactive_intent",kind:"scalar",T:9},{no:8,name:"portaled",kind:"scalar",T:8}]));class P extends i.Message{constructor(t){super(),this.proactiveType=e.ProactiveMessageType.DEFAULT,this.whenToShowControlledByProvider=!1,this.secondsUntilShown=i.protoInt64.zero,this.coolOffPeriodMinutes=i.protoInt64.zero,i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new P).fromBinary(t,e)}static fromJson(t,e){return(new P).fromJson(t,e)}static fromJsonString(t,e){return(new P).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(P,t,e)}}P.runtime=i.proto3,P.typeName="chat.ProactiveSettings",P.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"proactive_type",kind:"enum",T:i.proto3.getEnumType(e.ProactiveMessageType)},{no:2,name:"when_to_show_controlled_by_provider",kind:"scalar",T:8},{no:3,name:"seconds_until_shown",kind:"scalar",T:4},{no:4,name:"cool_off_period_minutes",kind:"scalar",T:4}]));class y extends i.Message{constructor(t){super(),this.widgetId="",i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new y).fromBinary(t,e)}static fromJson(t,e){return(new y).fromJson(t,e)}static fromJsonString(t,e){return(new y).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(y,t,e)}}y.runtime=i.proto3,y.typeName="chat.ChatHmacInput",y.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"widget_id",kind:"scalar",T:9}]));class L extends i.Message{constructor(t){super(),this.campaignId=i.protoInt64.zero,this.versionId=i.protoInt64.zero,this.campaignName="",this.versionName="",this.systemSettings={case:void 0},this.mustHaveAvailableAgents=!1,this.greetingMessage="",this.chatInitialState=e.ChatInitialState.HIDDEN,this.persistenceCookie="",this.deprecatedExperimentNameToLog="",this.deprecatedExperimentVariantToLog="",this.isControl=!1,i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new L).fromBinary(t,e)}static fromJson(t,e){return(new L).fromJson(t,e)}static fromJsonString(t,e){return(new L).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(L,t,e)}}L.runtime=i.proto3,L.typeName="chat.CampaignResult",L.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"campaign_id",kind:"scalar",T:4},{no:2,name:"version_id",kind:"scalar",T:4},{no:3,name:"campaign_name",kind:"scalar",T:9},{no:4,name:"version_name",kind:"scalar",T:9},{no:5,name:"snapengage_chat_system_settings",kind:"message",T:f,oneof:"system_settings"},{no:14,name:"dialogue_chat_system_settings",kind:"message",T:N,oneof:"system_settings"},{no:6,name:"must_have_available_agents",kind:"scalar",T:8},{no:7,name:"proactive_settings",kind:"message",T:P},{no:8,name:"greeting_message",kind:"scalar",T:9},{no:9,name:"chat_initial_state",kind:"enum",T:i.proto3.getEnumType(e.ChatInitialState)},{no:10,name:"persistence_cookie",kind:"scalar",T:9},{no:11,name:"deprecated_experiment_name_to_log",kind:"scalar",T:9},{no:12,name:"deprecated_experiment_variant_to_log",kind:"scalar",T:9},{no:13,name:"is_control",kind:"scalar",T:8},{no:15,name:"chat_hmac_input",kind:"message",T:y}]));class D extends i.Message{constructor(t){super(),i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new D).fromBinary(t,e)}static fromJson(t,e){return(new D).fromJson(t,e)}static fromJsonString(t,e){return(new D).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(D,t,e)}}D.runtime=i.proto3,D.typeName="chat.ChatProviderMetadata",D.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"snapengage",kind:"message",T:A}]));class w extends i.Message{constructor(t){super(),this.resume=!1,this.chatProviderType=e.ChatProviderType.SNAPENGAGE,this.chatProviderMetadata={case:void 0},this.loggingCorrelationId="",this.featureGates={},i.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new w).fromBinary(t,e)}static fromJson(t,e){return(new w).fromJson(t,e)}static fromJsonString(t,e){return(new w).fromJsonString(t,e)}static equals(t,e){return i.proto3.util.equals(w,t,e)}}w.runtime=i.proto3,w.typeName="chat.ChatInitializerProperties",w.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"chat_metadata",kind:"message",T:v},{no:2,name:"user_properties",kind:"message",T:I},{no:3,name:"campaign_result",kind:"message",T:L},{no:4,name:"resume",kind:"scalar",T:8},{no:5,name:"chat_provider_type",kind:"enum",T:i.proto3.getEnumType(e.ChatProviderType)},{no:6,name:"snapengage_chat_metadata",kind:"message",T:A,oneof:"chat_provider_metadata"},{no:10,name:"solvvy_chat_metadata",kind:"message",T:O,oneof:"chat_provider_metadata"},{no:7,name:"logging_correlation_id",kind:"scalar",T:9},{no:8,name:"feature_gates",kind:"map",K:9,V:{kind:"scalar",T:8}},{no:9,name:"provider_metadata",kind:"message",T:D}]));const U=t=>void 0!==t.campaignId,M=t=>"string"==typeof t,V=(t,e)=>!!t&&(U(t)&&U(e)?t.campaignId===e.campaignId:!(!M(t)||!M(e))&&t===e),H=t=>U(t)?t.systemSettings&&"snapengageChatSystemSettings"===t.systemSettings.case?t.systemSettings.value.widgetId:null:t;var b,B;!function(t){t.UNKNOWN="unknown",t.OFFLINE="offline",t.ONLINE="online"}(b||(b={})),function(t){t.START_TRANSFER="startTransfer",t.END_TRANSFER="endTransfer",t.ERROR_ON_TRANSFER="errorOnTransfer"}(B||(B={}));class G{constructor(t){}}class k{constructor(t,e){this.setupChatEnvironment=t=>{},this.startReactiveChat=()=>{},this.startSupportChat=t=>{},this.setCookieBannerInfo=t=>{},this.regsiterVisibilityChangeCallback=t=>{}}}const W={NAMER:["US","CA"],APAC:["AU","BD","KH","C2","FJ","GU","HK","IN","ID","JP","MY","MV","NP","NZ","PK","PH","SG","KR","LK","TW","TH","VN"],EMEA:["AL","DZ","AO","AT","AZ","BH","BY","BE","BA","BW","BG","CM","HR","CY","CZ","DK","EG","EE","ET","FI","FR","GE","DE","GH","GI","GR","HU","IS","IQ","IE","IL","IT","CI","JO","KE","KW","LV","LB","LT","LU","MK","MG","MT","MQ","MU","MD","MC","MA","MZ","NA","NL","NG","NO","OM","PS","PL","PT","QA","RO","RU","RW","SA","SN","RS","SK","SI","ZA","ES","SE","CH","TZ","TN","TR","UG","UA","AE","GB","YE","ZM","ZW"],LATAM:["AG","AN","AR","AW","BB","BO","BR","BS","BZ","CL","CO","CR","CU","DM","DO","EC","GT","GY","HN","HT","JM","KN","LC","MX","NI","PA","PE","PR","PY","SR","SV","TT","UY","VC","VE"]},F={en:"",en_GB:"",da_DK:"dutch",de:"german",es:"spanish, spanish-la",es_ES:"spanish, spanish-es",fr:"french",id:"",it:"italian",ja:"japanese",ko:"korean",ms:"",nb_NO:"norwegian",nl_NL:"dutch",pl:"",pt_BR:"portuguese",ru:"russian",sv_SE:"swedish",th_TH:"thai",zh_CN:"chinese, chinese-sim",zh_TW:"chinese, chinese-trad"},x=t=>{if(void 0!==t)return W.NAMER.indexOf(t)>=0?"namer":W.APAC.indexOf(t)>=0?"apac":W.EMEA.indexOf(t)>=0?"emea":W.LATAM.indexOf(t)>=0?"latam":void 0};class z{constructor(t){}}var q=e.ProactiveMessageType;class J extends z{constructor(t){super(t),this.isLoaded=()=>this._isLoaded,this.requestAgentStatusUpdate=()=>{this.checkChatStatus()},this.showReactiveButton=()=>{this.showSnapEngageIframe(),this.minimizeSnapEngageIframe(),this.onProviderReactiveButtonShownListener(this.chatCampaign)},this.startChat=()=>{this.showSnapEngageIframe(),this.sendMessage("startChatV2")},this.startProactiveChat=()=>{this.showSnapEngageIframe(),this.sendMessage("startProactiveChat")},this.handleProviderDrivenOpen=()=>{this.showSnapEngageIframe()},this.switchCampaign=t=>{this.chatCampaign=t,this.chatId=H(this.chatCampaign),this.sendMessage("switchCampaign")},this.updateHmac=()=>{this.sendMessage("updateHmac")},this.addBottomMargin=()=>{this.iframe&&this.iframe.style.setProperty("transform","translateY(calc(-1 * var(--privacy-consent-banner-height, 0px)))")},this.removeBottomMargin=()=>{this.iframe&&this.iframe.style.removeProperty("transform")},this.initialize=()=>{window.addEventListener("message",this.receiveMessage,!1),s.require_css("/static/metaserver/static/css/business/components/snap_engage-vfldJUS6n.css",(()=>{this.createIframe()}))},this.createIframe=()=>{const t=n.get_uri(),e=r.URI.parse(this.metadata.snapengageIframeOrigin);this.iframe=document.createElement("iframe"),t.setScheme(e.getScheme()),t.setAuthority(e.getAuthority()),this.iframe.src=t.toString(),this.iframe.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-forms"),this.iframe.setAttribute("class","snapengage-iframe"),this.iframe.setAttribute("id",this.iframeId),this.iframe.setAttribute("allowTransparency","true"),this.iframe.setAttribute("title",o.intl.formatMessage({id:"/nsbvt",defaultMessage:"Live chat box"})),this.iframe.addEventListener("load",this.handleIframeLoad);const i=document.querySelector("main");null!==i?i.insertBefore(this.iframe,i.firstChild):(this.iframe.setAttribute("tabindex","1"),document.body.insertBefore(this.iframe,document.body.childNodes[0])),setInterval(this.checkChatStatus,13e4)},this.handleIframeLoad=()=>{this.iFrameLeftStyle=this.iframe&&this.iframe.style.left,this.sendMessage("createSnapEngageScriptV2")},this.showSnapEngageIframe=(t=!1)=>{this.iframe&&(this.iframe.style.display="inline",this.iframe.style.left=this.iFrameLeftStyle,this.isVisible=!0)},this.onCloseChat=t=>{let e,i;this.iframe&&(this.iframe.style.display="none"),this.isVisible=!1,t&&(i=t.type,e="online"===t.agentStatus?b.ONLINE:b.OFFLINE),this.onChatClosedListener(this.chatCampaign,{agentStatus:e,chatType:i})},this.onMinimized=()=>{this.onChatMinimizedListener(this.chatCampaign),this.minimizeSnapEngageIframe()},this.onMaximized=t=>{this.onChatMaximizedListener(this.chatCampaign),this.maximizeSnapEngageIframe(t)},this.minimizeSnapEngageIframe=()=>{this.iframe&&this.isVisible&&(this.iframe.style.width="80px",this.iframe.style.height="80px")},this.maximizeSnapEngageIframe=t=>{if(this.iframe){const e=(t||{}).width,i=(t||{}).height;this.iframe.style.width=e?`${e}px`:"",this.iframe.style.height=i?`${i}px`:""}},this.checkChatStatus=()=>{this.sendMessage("checkChatStatusV2")},this.onOpenProactive=()=>{this.onProviderDrivenOpenProactiveListener(this.chatCampaign)},this.onAgentStatusUpdate=t=>{this.onAgentStatusUpdateListener(this.chatCampaign,t)},this.isValidSource=t=>t.origin===this.metadata.snapengageIframeOrigin,this.onOpen=()=>{this.onChatShownListener(this.chatCampaign)},this.onChatMessageReceived=()=>{},this.onStartChat=()=>{this.onChatStartedListener(this.chatCampaign)},this.onSwitchCampaign=()=>{this.onSwitchCampaignListener(this.chatCampaign)},this.onSnapEngageInitialized=()=>{this._isLoaded=!0,this.onChatLoadListener(this.chatCampaign,!0)},this.buildChatData=()=>{const t=((t,e)=>{const i=[],a=F[t],s=x(e);return void 0!==a&&i.push(a),void 0!==s&&i.push(s),i.join(", ")})(this.userProperties.locale,this.userProperties.countryCode),e=U(this.chatCampaign)&&!this.chatCampaign.isControl&&void 0!==this.chatCampaign.proactiveSettings&&null!==this.chatCampaign.proactiveSettings&&this.chatCampaign.proactiveSettings.whenToShowControlledByProvider;let i,a=!1;return U(this.chatCampaign)&&(i=this.chatCampaign.greetingMessage,this.chatCampaign.proactiveSettings&&(a=this.chatCampaign.proactiveSettings.proactiveType===q.MINIMIZED_PROACTIVE)),{FirstName:this.userProperties.firstName,LastName:this.userProperties.lastName,Email:this.userProperties.email,locale:this.userProperties.locale,SessionID:this.userProperties.sessionId,Country:this.userProperties.countryCode,pricing:this.userProperties.pricings.join(),user_id:this.userProperties.userId,pageLoadTs:this.userProperties.pageLoadTs,chatHmac:this.userProperties.chatHmac,authToken:this.userProperties.authToken,ncct:"",serviceTier:this.userProperties.serviceTier,tags:t,phoneSupportForPlusUsers:this.userProperties.experiments.phoneSupportForPlusUsers,supportExperimentShowOnboardingNumber:this.userProperties.experiments.supportExperimentShowOnboardingNumber,supportExperimentHideEmailOption:this.userProperties.experiments.supportExperimentHideEmailOption,supportExperimentBasic36HourSla:this.userProperties.experiments.supportExperimentBasic36HourSla,phoneSupportForProfessionalUsers:this.userProperties.experiments.phoneSupportForProfessionalUsers,supportExperimentProfessionalPhoneSupportedLanguages:this.userProperties.experiments.supportExperimentProfessionalPhoneSupportedLanguages,cxChatbotName:"",allowProactive:e,greetingMessage:i,minimizedProactive:a}},this.receiveMessage=t=>{this.isValidSource(t)&&("SnapEngageInitialized"===t.data.message_type?this.onSnapEngageInitialized():"UpdateChatStatus"===t.data.message_type?this.onAgentStatusUpdate(t.data.online):"Close"===t.data.message_type?this.onCloseChat(t.data):"Minimize"===t.data.message_type?this.onMinimized():"Maximize"===t.data.message_type?this.onMaximized(t.data.rect):"OpenProactive"===t.data.message_type?this.onOpenProactive():"StartChat"===t.data.message_type?this.onStartChat():"Open"===t.data.message_type?this.onOpen():"EndProactiveChat"===t.data.message_type?this.onCloseChat():"ChatMessageReceived"===t.data.message_type?this.onChatMessageReceived():"onSwitchCampaign"===t.data.message_type&&this.onSwitchCampaign())},this.sendMessage=t=>{const e={message_type:t,chatId:this.chatId,chatData:this.chatData};this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage(e,this.metadata.snapengageIframeOrigin)},this._isLoaded=!1,this.chatCampaign=t.campaignResult,this.metadata=t.metadata,this.userProperties=t.userProperties,this.onAgentStatusUpdateListener=t.onAgentStatusUpdate,this.onChatLoadListener=t.onChatLoadStatusUpdate,this.onChatShownListener=t.onChatShown,this.onChatStartedListener=t.onChatStarted,this.onChatClosedListener=t.onChatClosed,this.onSwitchCampaignListener=t.onSwitchCampaign,this.onProviderDrivenOpenProactiveListener=t.onProviderDrivenOpenProactive,this.onProviderReactiveButtonShownListener=t.onProviderReactiveButtonShown,this.onChatMinimizedListener=t.onChatMinimized,this.onChatMaximizedListener=t.onChatMaximized,this.isVisible=!1,this.iframeId="snapengage-iframe",this.chatData=this.buildChatData(),this.chatId=H(this.chatCampaign),this.initialize()}}class K extends G{constructor(t){super(t),this.DEFAULT_WIDGET_ID="d5c1efed-d0ef-4fca-8c7d-faff398ad272",this.getDefaultChatIdentifier=()=>this.DEFAULT_WIDGET_ID,this.loadChatIfNecessary=t=>{V(this.currentChatCampaign,t)?this.handler.isLoaded()&&this.onChatLoadStatusUpdate(this.currentChatCampaign,!0):this.handler.switchCampaign(t)},this.onSwitchCampaign=t=>{const e=this.currentChatCampaign;this.currentChatCampaign=t,this.onChatLoadStatusUpdate(e,!1),this.onAgentStatusUpdateListener(e,b.UNKNOWN),this.onChatLoadStatusUpdate(t,!0),this.handler.requestAgentStatusUpdate()},this.requestAgentStatusUpdate=t=>{if(!V(this.currentChatCampaign,t))throw new Error("Requesting agent status for a chat campaign that is not loaded");this.handler.requestAgentStatusUpdate()},this.showProviderReactiveChatButton=()=>{this.handler.showReactiveButton()},this.handleProviderDrivenOpen=()=>{this.handler.handleProviderDrivenOpen()},this.startChat=(t,e)=>{if(!V(this.currentChatCampaign,t))throw new Error("Requesting to start chat for a chat campaign that is not loaded");e?this.handler.startProactiveChat():this.handler.startChat()},this.updateHmac=()=>{this.handler.updateHmac()},this.addBottomMargin=()=>{this.handler.addBottomMargin()},this.removeBottomMargin=()=>{this.handler.removeBottomMargin()},this.onAgentStatusUpdate=(t,e)=>{this.onAgentStatusUpdateListener(t,e?b.ONLINE:b.OFFLINE)},this.handleTransferEvent=t=>{},this.onAgentStatusUpdateListener=t.onAgentStatusUpdate,this.onChatLoadStatusUpdate=t.onChatLoadStatusUpdate,this.onChatShown=t.onChatShown,this.onChatStarted=t.onChatStarted,this.onChatClosed=t.onChatClosed,this.onProviderDrivenOpenProactive=t.onProviderDrivenOpenProactive,this.onProviderReactiveButtonShown=t.onProviderReactiveButtonShown,this.metadata=t.metadata,this.userProperties=t.userProperties,this.onChatMinimized=t.onChatMinimized,this.onChatMaximized=t.onChatMaximized,t.chatCampaign?(this.currentChatCampaign=t.chatCampaign,this.handler=this.createHandler(t.chatCampaign)):(this.currentChatCampaign=this.DEFAULT_WIDGET_ID,this.handler=this.createHandler(this.DEFAULT_WIDGET_ID))}createHandler(t){return new J({campaignResult:t,metadata:this.metadata,userProperties:this.userProperties,onAgentStatusUpdate:this.onAgentStatusUpdate,onChatLoadStatusUpdate:this.onChatLoadStatusUpdate,onChatShown:this.onChatShown,onChatStarted:this.onChatStarted,onChatClosed:this.onChatClosed,onProviderDrivenOpenProactive:this.onProviderDrivenOpenProactive,onProviderReactiveButtonShown:this.onProviderReactiveButtonShown,onSwitchCampaign:this.onSwitchCampaign,onChatMinimized:this.onChatMinimized,onChatMaximized:this.onChatMaximized})}}var Z;e.DialogueActionType=void 0,(Z=e.DialogueActionType||(e.DialogueActionType={})).INIT_PROVIDER="DIALOGUE/INIT_PROVIDER",Z.SET_TRANSFER_PROPS="DIALOGUE/SET_TRANSFER_PROPS",Z.START_TRANSFER="DIALOGUE/START_TRANSFER",Z.END_CHAT="DIALOGUE/END_CHAT",Z.GET_CHAT="DIALOGUE/GET_CHAT",Z.TOGGLE_CHAT_WINDOW="DIALOGUE/TOGGLE_CHAT_WINDOW",Z.TOGGLE_REACTIVE_BUTTON="DIALOGUE/TOGGLE_REACTIVE_BUTTON",Z.TOGGLE_END_CHAT_MODAL="DIALOGUE/TOGGLE_END_CHAT_MODAL",Z.TOGGLE_TRANSFER_MODAL="DIALOGUE/TOGGLE_TRANSFER_MODAL",Z.SET_LOGGING_ID="DIALOGUE/SET_LOGGING_ID",Z.SET_GREETING_MESSAGE="DIALOGUE/SET_GREETING_MESSAGE",Z.SET_FATAL_ERROR_MESSAGE="DIALOGUE/SET_FATAL_ERROR_MESSAGE",Z.DISABLE_CHAT="DIALOGUE/DISABLE_CHAT",Z.ADD_MESSAGE="DIALOGUE/ADD_MESSAGE",Z.UPDATE_CURRENT_MESSAGE="DIALOGUE/UPDATE_CURRENT_MESSAGE",Z.UPDATE_SURVEY_RESPONSE="DIALOGUE/UPDATE_SURVEY_RESPONSE",Z.CLICK_LINK="DIALOGUE/CLICK_LINK",Z.RESTART_CHAT="DIALOGUE/RESTART_CHAT";const j={cx_support:S.CX_SUPPORT,cx_specialized:S.CX_SPECIALIZED,business:S.BUSINESS,scaled_onboarding:S.SCALED_ONBOARDING},X=t=>{switch(t[".tag"]){case"lex":return C.LEX;case"rasa":return C.RASA;default:return C.UNKNOWN}},Y=t=>{const e=Object.keys(j).find((e=>j[e]===t));if(!e)throw new Error("invalid bot type");return{".tag":e}},Q=t=>{switch(t){case C.LEX:return{".tag":"lex"};case C.RASA:return{".tag":"rasa"};default:return{".tag":"unknown"}}},$=E.default.lazy((()=>h.__awaiter(void 0,void 0,void 0,(function*(){const{Dialogue:e}=yield new Promise((function(e,i){t(["./c_chat_dialogue"],e,i)}));return{default:e}})))),tt=()=>E.default.createElement(E.default.Fragment,null),et=t=>E.default.createElement(E.default.Suspense,{fallback:E.default.createElement(tt,null)},E.default.createElement($,Object.assign({},t)));class it extends G{constructor(i){var a,s;super(i),this.DEFAULT_ID="chatbot",this.isReady=!1,this.setup=()=>h.__awaiter(this,void 0,void 0,(function*(){const e=new Promise((function(e,i){t(["./c_dialogue_reducers_index"],e,i)})).then((({createAppRootStore:t})=>{this.initialiseReduxStore(t),this.loadChat()})),i=new Promise((function(e,i){t(["./c_dialogue_actions_chat_actions"],e,i)})).then((function(t){return t.chat_actions_esnext}));yield Promise.all([e,i]),i.then((t=>{this.chatActions=t;const e={text:this.campaign.greetingMessage,sender:"bot"};this.callWhenReady((()=>{this.action(this.chatActions.getChat(this.stoneSettings,e,Number(this.campaign.campaignId)))})),this.isReady=!0,this.onReadyCallbacks.forEach((t=>{t()}))})),this.onChatLoadStatusListener(this.campaign,!0)})),this.initialiseReduxStore=t=>{this.store=t(this);const i=(t=>{const e={};return t.forEach((t=>{const i=t.name;e[i]=t.active})),e})(this.settings.experiments);this.store.dispatch({type:e.DialogueActionType.INIT_PROVIDER,settings:this.stoneSettings,userProperties:this.userProperties,experiments:i,campaignId:Number(this.campaign.campaignId)})},this.action=t=>{t(this.store.dispatch,this.store.getState)},this.transferToNewCampaign=t=>{t.chatProviderType===e.ChatProviderType.SNAPENGAGE&&this.onSwitchProviderWithNewCampaign(t,this.campaign)},this.handleTransferEvent=t=>{var e,i;if(t===B.START_TRANSFER);else if(t===B.END_TRANSFER){const{providerState:t}=this.store.getState(),a=null===(e=t.savedTransferProps)||void 0===e?void 0:e.campaignResult;let s;if(a){const{campaignName:t,versionName:e,campaignId:i}=a;s=`chatbot_transfer_${i}`,this.logAsync("transfer",{campaignName:t,versionName:e,campaignId:Number(i)})}this.action(this.chatActions.endChat({},this.stoneSettings,!1,s)),null===(i=this.getRootElement())||void 0===i||i.remove()}else t===B.ERROR_ON_TRANSFER&&this.addMessage({text:"Sorry, I wasn't able to transfer you.",sender:"bot"})},this.onReactiveButtonShown=()=>{this.onProviderReactiveButtonShownListener(this.campaign)},this.addMessage=(t,i=!1)=>{this.callWhenReady((()=>{this.store.dispatch({type:e.DialogueActionType.ADD_MESSAGE,message:t,awaitingResponse:i})}))},this.addBottomMargin=()=>{const t=this.getRootElement();t&&t.style.setProperty("transform","translateY(calc(-1 * var(--privacy-consent-banner-height, 0px)))")},this.removeBottomMargin=()=>{const t=this.getRootElement();t&&t.style.removeProperty("transform")},this.callWhenReady=t=>{this.isReady?t():this.onReadyCallbacks.push(t)},this.getRootElement=()=>document.getElementById("dialogue-chat-root"),this.getLogger=()=>h.__awaiter(this,void 0,void 0,(function*(){if(this.logger)return this.logger;const{DialogueEventsLogger:e}=yield new Promise((function(e,i){t(["./c_chat_dialogue_logging"],e,i)}));return this.logger=new e,this.logger})),this.logAsync=(t,e={})=>h.__awaiter(this,void 0,void 0,(function*(){(yield this.getLogger()).logEvent(t,e)})),this.settings=(null===(a=i.chatCampaign)||void 0===a?void 0:a.systemSettings).value,this.stoneSettings=(s=this.settings,{bot_provider:Q(s.botProvider),bot_type:Y(s.botType),environment:s.environment,settings_hmac:s.settingsHmac,proactive_intent:s.proactiveIntent,portaled:s.portaled}),this.campaign=i.chatCampaign,this.userProperties=i.userProperties,this.onReadyCallbacks=[],this.onAgentStatusUpdateListener=i.onAgentStatusUpdate,this.onChatLoadStatusListener=i.onChatLoadStatusUpdate,this.onChatShownListener=i.onChatShown,this.onChatStartedListener=i.onChatStarted,this.onChatClosedListener=i.onChatClosed,this.onChatMinimizedListener=i.onChatMinimized,this.onChatMaximizedListener=i.onChatMaximized,this.onProviderDrivenOpenProactive=i.onProviderDrivenOpenProactive,this.onProviderReactiveButtonShownListener=i.onProviderReactiveButtonShown,this.onSwitchProviderWithNewCampaign=i.onSwitchProviderWithNewCampaign,this.hasLoaded=!1,this.setup().catch((t=>h.__awaiter(this,void 0,void 0,(function*(){var e;(yield this.getLogger()).logError("provider_init",{userId:null===(e=i.userProperties)||void 0===e?void 0:e.userId,error:t.toString()})}))))}getDefaultChatIdentifier(){return this.DEFAULT_ID}loadChatIfNecessary(t){}requestAgentStatusUpdate(t){this.onAgentStatusUpdateListener(t,b.ONLINE)}showProviderReactiveChatButton(){this.callWhenReady((()=>{this.action(this.chatActions.toggleReactiveButton(!0))}))}handleProviderDrivenOpen(){}startChat(t,e){this.callWhenReady((()=>{this.action(this.chatActions.openChat(e))}))}updateHmac(){}onChatStarted(){this.onChatStartedListener(this.campaign)}onChatClosed(){this.onChatClosedListener(this.campaign,{})}onChatMinimized(){this.onChatMinimizedListener(this.campaign)}onChatMaximized(){this.onChatMaximizedListener(this.campaign)}onChatShown(t){this.onChatShownListener(t||this.campaign)}loadChat(){return h.__awaiter(this,void 0,void 0,(function*(){if(!this.getRootElement()){const t=document.createElement("div");t.setAttribute("id","dialogue-chat-root"),document.body.appendChild(t)}this.hasLoaded||(T.render(E.default.createElement(et,{store:this.store,portaled:this.settings.portaled}),this.getRootElement()),this.hasLoaded=!0)}))}}const at=new class{constructor(){this.getChatProvider=(t,i)=>{if(t===e.ChatProviderType.SNAPENGAGE)return new K(i);if(t===e.ChatProviderType.DIALOGUE_CHAT)return new it(i);throw new Error(`Unknown chat provider type ${t}`)}}};var st,nt,rt,ot,ht,ct;!function(t){t.INITIALIZED="initialized",t.IMPRESSION_FAILED="impression_failed",t.CLICK="click",t.IMPRESSION="impression",t.INTERACT="interact",t.DISMISSED="dismissed",t.CLOSE="close",t.ERROR="error",t.TRANSFER="transfer"}(st||(st={})),function(t){t.CONTROL_VERSION="control_version",t.NO_ONLINE_AGENTS="no_online_agents",t.NOT_ENOUGH_TIME_ON_PAGE="not_enough_time_on_page",t.CHAT_IS_NOT_ALLOWED="chat_is_not_allowed",t.CHAT_IS_NOT_INITIALIZED="chat_is_not_initialized",t.ANOTHER_CHAT_STARTED="another_chat_started",t.COOLOFF_PERIOD="COOLOFF_PERIOD"}(nt||(nt={})),function(t){t.CHAT_ICON="chat_icon",t.PROACTIVE_CHAT="proactive_chat",t.RESUMED_CHAT="resumed_chat",t.REACTIVE_CHAT="reactive_chat"}(rt||(rt={})),function(t){t.UNKNOWN="unknown",t.RESUMED_CHAT="resumed_chat",t.PROACTIVE_CHAT="proactive_chat",t.REACTIVE_CHAT="reactive_chat",t.TRANSFERRED_CHAT="transferred_chat"}(ot||(ot={})),function(t){t.ATTEMPT_TO_START_UNINITIALIZED_CHAT="attempt_to_start_uninitialized_chat",t.CHAT_STARTED_FROM_UNKNOWN_SOURCE="chat_started_from_unknown_source",t.ATTEMPT_START_PROACTIVE_CHAT_WITHOUT_MESSAGE="attempt_start_proactive_chat_without_message"}(ht||(ht={})),function(t){t.DEFAULT="default",t.HIVE_VORTEX_COMBO="hive_vortex_combo"}(ct||(ct={}));class dt{constructor(t,e){this.category="megaphone-events_v0_5",this.user_id=-1,this.team_id=-1,this.entity_id=-1,this.version_id=-1,this.node_id="-1",this.parent_correlation_id="none",this.parent_event_id="none",this.external_tag="none",this.location="none",this.platform="WEB",this.surface_screen_height=-1,this.surface_screen_width=-1,this.event_details={},e&&(this.category=e),["user_id","team_id","entity_type","entity_id","version_id","node_id","event_id","event_name","correlation_id","parent_correlation_id","parent_event_id","external_tag","location","platform","surface_screen_height","surface_screen_width","event_details"].map((e=>{t.hasOwnProperty(e)&&void 0!==t[e]&&(this[e]=t[e])})),this.event_id||(this.event_id=m.InsecureUUID.v4()),Object.seal(this)}}class pt{constructor(t){this.logger=t}logEvent(t,e,i){const a={entity_type:"chat",event_name:t,correlation_id:e.correlationId,event_id:i,user_id:this.toNumber(e.userId),entity_id:this.toNumber(e.campaignId),version_id:this.toNumber(e.versionId),platform:e.platform,event_details:this.getEventDetails(t,e)};this.logger.log(new dt(a))}toNumber(t,e=-1){return null==t||""===t?e:"string"==typeof t?parseInt(t,10):"number"==typeof t?t:t.toNumber()}getEventDetails(t,e){const i=Object.assign({},e.eventDetails);let a=e.widgetId;return e.eventDetails.widgetOverride&&(a=e.eventDetails.widgetOverride),i.widget_id=a,i}}const mt=new n.HiveLogger,gt=new n.VortexComboLogger;const lt=new class{getChatLogger(t=ct.DEFAULT){const e=t===ct.HIVE_VORTEX_COMBO?gt:mt;return new pt(e)}},_t="MegaphoneChatCooloff";var ut,Ct;!function(t){t[t.NOT_SHOWN=0]="NOT_SHOWN",t[t.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_LOAD=1]="TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_LOAD",t[t.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_AGENT_STATUS_UPDATE=2]="TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_AGENT_STATUS_UPDATE",t[t.REQUESTED_PROVIDER_TO_SHOW_REACTIVE_BUTTON=3]="REQUESTED_PROVIDER_TO_SHOW_REACTIVE_BUTTON",t[t.SHOWING_PROVIDER_REACTIVE_BUTTON=4]="SHOWING_PROVIDER_REACTIVE_BUTTON",t[t.SHOWING_CHAT=5]="SHOWING_CHAT",t[t.TO_START_ON_LOAD=6]="TO_START_ON_LOAD",t[t.TO_START_ON_AGENT_STATUS_UPDATE=7]="TO_START_ON_AGENT_STATUS_UPDATE",t[t.REQUESTED_PROVIDER_TO_START_CHAT=8]="REQUESTED_PROVIDER_TO_START_CHAT",t[t.CHAT_ONGOING=9]="CHAT_ONGOING"}(ut||(ut={})),function(t){t[t.REACTIVE=0]="REACTIVE",t[t.PROACTIVE=1]="PROACTIVE",t[t.RESUME=2]="RESUME",t[t.TRANSFER=3]="TRANSFER",t[t.PROVIDER_DRIVEN_PROACTIVE=4]="PROVIDER_DRIVEN_PROACTIVE"}(Ct||(Ct={}));class St extends k{constructor(t,i,s){super(t,i),this.setupChatEnvironment=t=>{if(this._isSetup)return;if(t.featureGates.enable_vortex_logger&&(this.logger=this.loggerFactory.getChatLogger(ct.HIVE_VORTEX_COMBO)),!this.shouldAllowChat())return;if(this.initProperties=t,this.setupTime=new Date,this.hasFirstLoadOccured=!1,this.state={lifecycleState:ut.NOT_SHOWN,hasShownAChat:!1,interactedWithChat:!1,cookieBannerState:{isVisible:!1}},!t.chatMetadata)throw new Error("Did not provide chat metadata.");if(this.metadata=t.chatMetadata,!t.userProperties)throw new Error("Did not provide user properties.");const i=this.getChatProviderMetadata(t),a=t.campaignResult;if(this.setupProvider(a,i,t.userProperties,t.chatProviderType),a&&a.isControl)this.setupControlLogging(a);else{const i=a&&a.chatInitialState===e.ChatInitialState.SHOW_PROVIDER_REACTIVE_BUTTON;if(t.resume){const t=this.chatCampaignWrapper||this.defaultChatWrapper;this.deprecatedLogChatAction("chat_persistence",H(t.chatCampaign)),this.intializeStartingChat(t,Ct.RESUME)}else this.setupProactivePropertiesIfNeeded(),i&&(this.attemptToShowProviderReactiveChatButton(),this.deprecatedMaybeLogExperiment(a));this.deferredStartChatCallback&&this.deferredStartChatCallback()}window.addEventListener("beforeunload",(()=>{this.maybeLogImpressionFailedOnUnload()}))},this.startReactiveChat=()=>{if(!this.isSetup())return void this.deferStartChat();if(this.logEvent(st.CLICK,{source:"startReactiveChat"}),!this.shouldAllowChat())return void this.logEvent(st.IMPRESSION_FAILED,{failed_reason:nt.CHAT_IS_NOT_ALLOWED});if(this.logAndRaiseIfNotSetup(),!this.canStartChat())return;let t=this.chatCampaignWrapper;const e=t&&U(t.chatCampaign)&&t.chatCampaign.isControl;if(!this.chatCampaignWrapper||e)return t=this.defaultChatWrapper,this.deprecatedLogChatAction("chat_initiated",H(t.chatCampaign)),void this.intializeStartingChat(t,Ct.REACTIVE);this.deprecatedLogChatAction("chat_initiated",H(t.chatCampaign)),this.intializeStartingChat(this.chatCampaignWrapper,Ct.REACTIVE)},this.startSupportChat=t=>{this.isSetup()?(this.logEvent(st.CLICK,{source:"startSupportChat",widgetOverride:t}),this.shouldAllowChat()?(this.logAndRaiseIfNotSetup(),this.canStartChat()&&(this.supportChatWrapper={chatCampaign:t,chatCampaignState:this.getInitialChatCampaignState()},p.isNCCTChat(t)&&n.WebRequest$2({url:"/team/admin/engaged_chat",data:{chatId:t}}),this.deprecatedLogChatAction("support_chat_initiated",t),this.intializeStartingChat(this.supportChatWrapper,Ct.REACTIVE))):this.logEvent(st.IMPRESSION_FAILED,{failed_reason:nt.CHAT_IS_NOT_ALLOWED,widgetOverride:t})):this.deferStartChat(t)},this.isSetup=()=>this._isSetup,this.setCookieBannerInfo=t=>{this.state.cookieBannerState={isVisible:t},this.adjustProviderMarginOnStateChange()},this.regsiterVisibilityChangeCallback=t=>{this.onVisibilityChangeCallbacks.push(t)},this.deferStartChat=t=>{this.deferredStartChatCallback=()=>{t?this.startSupportChat(t):this.startReactiveChat()}},this.updateChatVisibility=t=>{this.onVisibilityChangeCallbacks.forEach((e=>e(t)))},this.adjustProviderMarginOnStateChange=()=>{this.state.cookieBannerState.isVisible?this.state.lifecycleState===ut.CHAT_ONGOING||this.state.lifecycleState===ut.SHOWING_CHAT?this.provider.removeBottomMargin():this.provider.addBottomMargin():this.provider.removeBottomMargin()},this.modifyLifecycleState=t=>{this.state.lifecycleState=t,this.adjustProviderMarginOnStateChange()},this.logAndRaiseIfNotSetup=()=>{if(!this._isSetup)throw this.logEvent(st.IMPRESSION_FAILED,{failed_reason:nt.CHAT_IS_NOT_INITIALIZED}),this.logError(ht.ATTEMPT_TO_START_UNINITIALIZED_CHAT),new Error("Started chat without being initialized")},this.setupProvider=(t,e,i,a)=>{const s={chatCampaign:t,metadata:e,userProperties:i,onAgentStatusUpdate:this.onAgentStatusUpdate,onChatLoadStatusUpdate:this.onChatLoadStatusUpdate,onChatShown:this.onChatShown,onChatStarted:this.onChatStarted,onChatClosed:this.onChatClosed,onChatMinimized:this.onChatMinimized,onChatMaximized:this.onChatMaximized,onProviderDrivenOpenProactive:this.onProviderDrivenOpenProactive,onProviderReactiveButtonShown:this.onProviderReactiveButtonShown,onSwitchProviderWithNewCampaign:this.onSwitchProviderWithNewCampaign};t&&(this.chatCampaignWrapper={chatCampaign:t,chatCampaignState:this.getInitialChatCampaignState()}),this.provider=this.getChatProvider(a,s),this.defaultChatWrapper={chatCampaign:this.provider.getDefaultChatIdentifier(),chatCampaignState:this.getInitialChatCampaignState()},this._isSetup=!0},this.attemptToShowProviderReactiveChatButton=()=>{const t=this.chatCampaignWrapper;t&&U(t.chatCampaign)&&(this.state.campaign=t.chatCampaign,this.state.source_type=Ct.REACTIVE,t.chatCampaignState.isLoaded?U(t.chatCampaign)&&t.chatCampaign.mustHaveAvailableAgents?this.attemptToShowReactiveButtonChatThatMustHaveAgents(t):this.requestProviderToShowProviderReactiveButton():this.requestProviderToLoadChatToShowProviderReactiveButton(t))},this.requestProviderToShowProviderReactiveButton=()=>{this.modifyLifecycleState(ut.REQUESTED_PROVIDER_TO_SHOW_REACTIVE_BUTTON),this.provider.showProviderReactiveChatButton();const t=this.chatCampaignWrapper||this.defaultChatWrapper;this.deprecatedLogChatAction("minimized_chat_initiated",H(t.chatCampaign))},this.requestProviderToGetAgentStatusUpdateToShowProviderReactiveButton=t=>{this.modifyLifecycleState(ut.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_AGENT_STATUS_UPDATE),this.provider.requestAgentStatusUpdate(t.chatCampaign)},this.requestProviderToLoadChatToShowProviderReactiveButton=t=>{this.modifyLifecycleState(ut.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_LOAD),this.provider.loadChatIfNecessary(t.chatCampaign)},this.canStartChat=()=>{const t=this.state.lifecycleState;return t===ut.NOT_SHOWN||t===ut.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_LOAD||t===ut.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_AGENT_STATUS_UPDATE||t===ut.REQUESTED_PROVIDER_TO_SHOW_REACTIVE_BUTTON||t===ut.SHOWING_PROVIDER_REACTIVE_BUTTON},this.intializeStartingChat=(t,e)=>{this.state.source_type=e,this.state.campaign=t.chatCampaign,this.attemptToStartChat(t)},this.attemptToStartChat=t=>{const e=this.state.source_type,i=e===Ct.PROACTIVE||e===Ct.PROVIDER_DRIVEN_PROACTIVE;t.chatCampaignState.isLoaded?i&&U(t.chatCampaign)&&t.chatCampaign.mustHaveAvailableAgents?this.attemptToStartChatThatMustHaveAgents(t,e===Ct.PROVIDER_DRIVEN_PROACTIVE):e===Ct.PROVIDER_DRIVEN_PROACTIVE?this.requestProviderToHandleProviderDrivenOpen():this.requestProviderToStartChat(t):this.requestProviderToLoadChatToStartChat(t)},this.requestProviderToHandleProviderDrivenOpen=()=>{this.provider.handleProviderDrivenOpen(),this.modifyLifecycleState(ut.SHOWING_CHAT)},this.requestProviderToStartChat=t=>{this.modifyLifecycleState(ut.REQUESTED_PROVIDER_TO_START_CHAT),this.provider.startChat(t.chatCampaign,this.state.source_type===Ct.PROACTIVE)},this.requestProviderToGetAgentStatusUpdateToStartChat=t=>{this.modifyLifecycleState(ut.TO_START_ON_AGENT_STATUS_UPDATE),this.provider.requestAgentStatusUpdate(t.chatCampaign)},this.setupProactivePropertiesIfNeeded=()=>{const t=this.chatCampaignWrapper;if(!t||!U(t.chatCampaign))return;const e=t.chatCampaign,i=e.proactiveSettings;if(!i||i.whenToShowControlledByProvider||e.isControl)return;if(!e.greetingMessage)return void this.logError(ht.ATTEMPT_START_PROACTIVE_CHAT_WITHOUT_MESSAGE);const a=this.readProactiveChatCooloffCookie();if(a)return void this.logEvent(st.IMPRESSION_FAILED,{failed_reason:nt.COOLOFF_PERIOD,debug_info:a},e);const s=1e3*Number(i.secondsUntilShown);setTimeout((()=>{this.state.hasShownAChat||this.state.campaign&&this.state.campaign!==e?this.logEvent(st.IMPRESSION_FAILED,{failed_reason:nt.ANOTHER_CHAT_STARTED},e):this.intializeStartingChat(t,Ct.PROACTIVE)}),s)},this.setupControlLogging=t=>{const e=t.proactiveSettings,i=()=>{let e=nt.CONTROL_VERSION;this.readProactiveChatCooloffCookie()?e=nt.COOLOFF_PERIOD:this.state.campaign&&this.state.campaign!==t?e=nt.ANOTHER_CHAT_STARTED:this.chatCampaignWrapper&&this.chatCampaignWrapper.chatCampaignState.agentStatus!==b.ONLINE&&U(this.chatCampaignWrapper.chatCampaign)&&this.chatCampaignWrapper.chatCampaign.mustHaveAvailableAgents&&(e=nt.NO_ONLINE_AGENTS),this.logEvent(st.IMPRESSION_FAILED,{failed_reason:e},t)};if(!e)return void i();const a=1e3*Number(e.secondsUntilShown);setTimeout(i,a),setTimeout((()=>this.deprecatedMaybeLogExperiment(t)),a)},this.getPersistenceCookie=t=>U(t)?t.persistenceCookie:`SNAPENGAGE:${t}`,this.setChatVisibleCookie=t=>{if(!this.metadata)return;const e=this.getPersistenceCookie(t),i=this.getLegacyCampaignIdentifierToCookieStr(t);i&&a.Cookies.create(this.metadata.legacyCookieCampaignName,i,.084,this.metadata.cookieDomain),a.Cookies.create(this.metadata.cookieCampaignName,e,1,this.metadata.cookieDomain)},this.maybeSetProactiveChatCooloffCookie=(t,e)=>{if(this.metadata&&t===Ct.PROACTIVE&&e&&U(e.chatCampaign)&&e.chatCampaign.proactiveSettings&&e.chatCampaign.proactiveSettings.coolOffPeriodMinutes){const t=e.chatCampaign,i=(new Date).getTime(),s=`${t.campaignId}:${t.versionId}:${i}`,n=Number(t.proactiveSettings.coolOffPeriodMinutes)/1440;a.Cookies.create(_t,s,n,this.metadata.cookieDomain)}},this.readProactiveChatCooloffCookie=()=>a.Cookies.read(_t),this.getInitialChatCampaignState=()=>({isLoaded:!1,agentStatus:b.UNKNOWN}),this.getWrapperFromIdentifier=t=>this.chatCampaignWrapper&&V(this.chatCampaignWrapper.chatCampaign,t)?this.chatCampaignWrapper:V(this.defaultChatWrapper.chatCampaign,t)?this.defaultChatWrapper:this.supportChatWrapper&&V(this.supportChatWrapper.chatCampaign,t)?this.supportChatWrapper:void 0,this.getLegacyCampaignIdentifierToCookieStr=t=>U(t)?"snapengageChatSystemSettings"===t.systemSettings.case?t.systemSettings.value.widgetId:null:t,this.legacyToggleOutsideChatVisibilityOnAgentStatusUpdate=t=>{this.modifyVisibility("[data-snap-engage-visibility]",!1),t===b.ONLINE?this.modifyVisibility('[data-snap-engage-visibility="online"]',!0):this.modifyVisibility('[data-snap-engage-visibility="offline"]',!0)},this.modifyVisibility=(t,e)=>{const i=e?"inline":"none",a=document.querySelectorAll(t);for(let t=0;t<a.length;t++){const e=a[t];e instanceof HTMLElement&&(e.style.display=i)}},this.onAgentStatusUpdate=(t,e)=>{const i=V(this.state.campaign,t),a=this.state.lifecycleState,s=a===ut.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_AGENT_STATUS_UPDATE&&i,n=a===ut.TO_START_ON_AGENT_STATUS_UPDATE&&i,r=this.getWrapperFromIdentifier(t);void 0!==r&&(r.chatCampaignState.agentStatus=e,this.legacyToggleOutsideChatVisibilityOnAgentStatusUpdate(e),s?this.attemptToShowProviderReactiveChatButton():n&&this.attemptToStartChat(r))},this.onChatLoadStatusUpdate=(t,e)=>{if(!this.hasFirstLoadOccured&&e){this.hasFirstLoadOccured=!0;const e=((new Date).valueOf()-this.setupTime.valueOf()).toString();this.logEvent(st.INITIALIZED,{init_latency_ms:e}),this.deprecatedLogChatAction("snapengage_loaded",H(t),{total_time:e})}const i=V(this.state.campaign,t),a=this.state.lifecycleState,s=a===ut.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_LOAD&&i,n=a===ut.TO_START_ON_LOAD&&i,r=this.getWrapperFromIdentifier(t);void 0!==r&&(r.chatCampaignState.isLoaded=e,e&&this.provider.requestAgentStatusUpdate(t),s?this.attemptToShowProviderReactiveChatButton():n&&this.attemptToStartChat(r))},this.onProviderReactiveButtonShown=()=>{this.state.lifecycleState===ut.REQUESTED_PROVIDER_TO_SHOW_REACTIVE_BUTTON&&(this.modifyLifecycleState(ut.SHOWING_PROVIDER_REACTIVE_BUTTON),this.logEvent(st.IMPRESSION,{impression_type:rt.CHAT_ICON}))},this.onProviderDrivenOpenProactive=t=>{this.chatCampaignWrapper&&V(this.chatCampaignWrapper.chatCampaign,t)&&(this.state.hasShownAChat||(this.logEvent(st.IMPRESSION,{impression_type:rt.PROACTIVE_CHAT}),this.deprecatedMaybeLogExperiment(t),this.deprecatedLogChatAction("proactive_chat_opened",H(t)),this.canStartChat()&&this.intializeStartingChat(this.chatCampaignWrapper,Ct.PROVIDER_DRIVEN_PROACTIVE))),this.updateChatVisibility(!0)},this.onChatShown=t=>{this.state.lifecycleState!==ut.SHOWING_PROVIDER_REACTIVE_BUTTON&&this.state.lifecycleState!==ut.REQUESTED_PROVIDER_TO_START_CHAT||V(this.state.campaign,t),this.modifyLifecycleState(ut.SHOWING_CHAT),this.state.campaign=t,this.state.hasShownAChat=!0,this.state.source_type===Ct.RESUME?(this.provider.updateHmac(),this.state.interactedWithChat=!0,this.logEvent(st.IMPRESSION,{impression_type:rt.RESUMED_CHAT})):this.state.source_type!==Ct.REACTIVE||this.impressionLogged||this.logEvent(st.IMPRESSION,{impression_type:rt.REACTIVE_CHAT}),this.updateChatVisibility(!0)},this.onChatStarted=t=>{const e=this.state.source_type;if(void 0!==e){let i;this.state.interactedWithChat=!0;let a=ot.UNKNOWN;e===Ct.RESUME?(i="chat_persistence_init",a=ot.RESUMED_CHAT):e===Ct.PROACTIVE||e===Ct.PROVIDER_DRIVEN_PROACTIVE?(i="proactive_chat_initiated",a=ot.PROACTIVE_CHAT,p.isNCCTChat(H(t))&&n.WebRequest$2({url:"/team/admin/engaged_chat",data:{chatId:H(t)}})):e===Ct.REACTIVE?(i="reactive_chat_initiated",a=ot.REACTIVE_CHAT):e===Ct.TRANSFER&&(a=ot.TRANSFERRED_CHAT),this.logEvent(st.INTERACT,{interaction_type:a}),void 0!==i&&this.deprecatedLogChatAction(i,H(t))}else this.logError(ht.CHAT_STARTED_FROM_UNKNOWN_SOURCE);this.setChatVisibleCookie(t),this.modifyLifecycleState(ut.CHAT_ONGOING)},this.onChatClosed=(t,e)=>{let i;this.handleCookieOnClosed(this.state.source_type,this.chatCampaignWrapper);let a=b.UNKNOWN;void 0!==e.agentStatus&&(i=e.agentStatus===b.ONLINE?"online":"offline",a=e.agentStatus===b.ONLINE?b.ONLINE:b.OFFLINE),this.deprecatedLogChatAction("snapengage_chat_close",H(t),{type:e.chatType,agent_status:i});const s=this.state.interactedWithChat?st.CLOSE:st.DISMISSED;this.logEvent(s,{agents_status:a,chat_form_type:e.chatType}),this.updateChatVisibility(!1),this.resetChatState()},this.onChatMinimized=t=>{this.updateChatVisibility(!1),this.modifyLifecycleState(ut.SHOWING_PROVIDER_REACTIVE_BUTTON)},this.onChatMaximized=t=>{this.updateChatVisibility(!0),this.modifyLifecycleState(ut.SHOWING_CHAT)},this.onSwitchProviderWithNewCampaign=(t,e)=>{const i=this.provider;let a;i.handleTransferEvent(B.START_TRANSFER);try{const e=this.getChatProviderMetadata(t);if(!t.userProperties)throw new Error("User properties cannot be empty");this.setupProvider(t.campaignResult,e,t.userProperties,t.chatProviderType),a=t.campaignResult}catch(t){return void i.handleTransferEvent(B.ERROR_ON_TRANSFER)}this.logEvent(st.TRANSFER,{},a),this.onChatLoadStatusUpdate(e,!1),this.onAgentStatusUpdate(e,b.UNKNOWN),this.resetChatState(),this.provider.requestAgentStatusUpdate(a),i.handleTransferEvent(B.END_TRANSFER),this.setChatVisibleCookie(a),this.intializeStartingChat(this.chatCampaignWrapper,Ct.TRANSFER)},this.getChatProviderMetadata=t=>{let i;if("snapengageChatMetadata"===t.chatProviderMetadata.case)i=t.chatProviderMetadata.value;else if(t.chatProviderType!==e.ChatProviderType.DIALOGUE_CHAT)throw new Error("No provider metadata provided");return i},this.maybeLogImpressionFailedOnUnload=()=>{if(!this.impressionLogged){const t=(new Date).valueOf()-this.setupTime.valueOf();this.logEvent(st.IMPRESSION_FAILED,{failed_reason:nt.NOT_ENOUGH_TIME_ON_PAGE,time_on_page_ms:t.toString()})}},this.logEvent=(t,e,i)=>{t!==st.IMPRESSION&&t!==st.IMPRESSION_FAILED||(this.impressionLogged=!0),this.logger.logEvent(t,this.createEventData(e,i))},this.logError=t=>{this.logEvent(st.ERROR,{error_type:t})},this.createEventData=(t,e)=>{let i="-1",s=-1,n=-1,r="";if(this.initProperties.userProperties&&(i=this.initProperties.userProperties.userId),e)s=Number(e.campaignId),n=Number(e.versionId),r="snapengageChatSystemSettings"===e.systemSettings.case&&e.systemSettings.value.widgetId||"";else{const t=this.chatCampaignWrapper||this.defaultChatWrapper;t&&(r=H(t.chatCampaign)||"",U(t.chatCampaign)&&(s=Number(t.chatCampaign.campaignId),n=Number(t.chatCampaign.versionId)))}return t.chat_session_id||(t.chat_session_id=a.Cookies.read("SnapABugChatSession")||""),{userId:i,campaignId:s,versionId:n,widgetId:r,correlationId:this.initProperties.loggingCorrelationId,platform:"WEB",eventDetails:t}},this.loggerFactory=s,this.logger=s.getChatLogger(),this.getChatProvider=t,this.shouldAllowChat=i,this._isSetup=!1,this.onVisibilityChangeCallbacks=[]}attemptToShowReactiveButtonChatThatMustHaveAgents(t){const e=t.chatCampaignState.agentStatus;e===b.UNKNOWN?this.requestProviderToGetAgentStatusUpdateToShowProviderReactiveButton(t):e===b.OFFLINE?(this.deprecatedLogChatAction("chat_agent_must_be_online_but_was_offline",H(t.chatCampaign)),this.logEvent(st.IMPRESSION_FAILED,{failed_reason:nt.NO_ONLINE_AGENTS}),this.resetChatState()):this.requestProviderToShowProviderReactiveButton()}attemptToStartChatThatMustHaveAgents(t,e){const i=t.chatCampaignState.agentStatus;i===b.UNKNOWN?this.requestProviderToGetAgentStatusUpdateToStartChat(t):i===b.OFFLINE?(this.logEvent(st.IMPRESSION_FAILED,{failed_reason:nt.NO_ONLINE_AGENTS}),this.resetChatState()):e?this.requestProviderToHandleProviderDrivenOpen():this.requestProviderToStartChat(t)}requestProviderToLoadChatToStartChat(t){this.modifyLifecycleState(ut.TO_START_ON_LOAD),this.provider.loadChatIfNecessary(t.chatCampaign)}handleCookieOnClosed(t,e){this.metadata&&(a.Cookies.delete(this.metadata.cookieCampaignName),a.Cookies.delete(this.metadata.legacyCookieCampaignName),this.maybeSetProactiveChatCooloffCookie(t,e))}deprecatedLogChatAction(t,e,i){if(!e)return;const a={chat_widget_id:e,url:n.get_href()},s=Object.assign(Object.assign({},a),i);n.TeamsWebActionsLogger.log(t,s),n.getAMPWebLogger().logEventCount("chat_events",t,{chat_widget_id:e})}deprecatedMaybeLogExperiment(t){if(!U(t))return;const{deprecatedExperimentNameToLog:e,deprecatedExperimentVariantToLog:i}=t}resetChatState(){this.modifyLifecycleState(ut.NOT_SHOWN),this.state.campaign=void 0,this.state.source_type=void 0,this.state.interactedWithChat=!1}}const Tt=new St(at.getChatProvider,(()=>top===window),lt);var Et=Object.freeze({__proto__:null,ChatClientSingleton:Tt,get ChatStartSourceType(){return Ct},_ChatClientSingleton:St,moduleInit:function(t){const e=r.unmarshalProto(t,w);Tt.setupChatEnvironment(e)}});e.CampaignResult=L,e.ChatInitializerProperties=w,e.ChatMetadata=v,e.ProactiveSettings=P,e.SnapengageChatMetadata=A,e.SnapengageChatSystemSettings=f,e.UserProperties=I,e.chat_client_esnext=Et,e.convertStoneSettingsToProto=t=>{const e=(t.experiments||[]).map((t=>new R(t)));return new N({botProvider:X(t.bot_provider),botType:(i=t.bot_type,j[i[".tag"]]),environment:t.environment,settingsHmac:t.settings_hmac,experiments:e,proactiveIntent:t.proactive_intent});var i}}));
//# sourceMappingURL=c_chat_chat_client.js-vflBMw_cO.map
