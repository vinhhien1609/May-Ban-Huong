define(["exports","react","./e_file_viewer_edison_shmodel_file_async","./c_pap-events_docsend_click_docsend_hub_entry_button","./c_annotations_view_layer_utils","./c_core_i18n","./c_tslib","./e_edison","./c_apex-metrics_src_types","./e_core_exception","./c_core_exception_info","./c_lodash-es_lodash","./c_core_notify","react-dom","metaserver/static/js/modules/constants/env","./c_src_sink_index","metaserver/static/js/modules/constants/viewer","./c_core_xhr","./c_csrf","./c_init_data_runtime","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/file_viewer_configuration","metaserver/static/js/modules/constants/file_viewer_feature_experiments","metaserver/static/js/modules/constants/fingerprintjs_constants","metaserver/static/js/modules/constants/sharing","./c_security_util","metaserver/static/js/modules/constants/login_and_register","metaserver/static/js/modules/constants/pdf_editing","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/contacts","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/unity","metaserver/static/js/modules/constants/files_spa","metaserver/static/js/langpack"],(function(t,e,n,o,i,a,s,r,h,c,l,d,g,u,m,p,_,f,y,v,x,b,w,R,C,M,A,L,D,E,j,S,k,N,T,P,z){"use strict";function B(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,o.get?o:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var O=B(e);n.injectInternalStyle("/static/js/file_viewer/comments2/annotations/conductor_layer/conductor_layer.module.out-vflVaLXx_.css",(t=>"._sc-annotation-conductor-layer_niric_1{bottom:0;cursor:auto;left:0;position:absolute;right:0;top:0}._sc-annotation-conductor-layer__can-create_niric_10{cursor:crosshair;pointer-events:all}._sc-annotation-conductor-layer__can-create_niric_10 img,._sc-annotation-conductor-layer__is-creating-rnd_niric_21{-webkit-user-select:none;user-select:none}"));const I="_sc-annotation-conductor-layer_niric_1";var F;!function(t){t[t.None=0]="None",t[t.Text=1]="Text",t[t.Link=2]="Link",t[t.Creation=3]="Creation"}(F||(F={}));const K=8;function U(t,e,o){const i=o?function(t,e){const n=t.x+t.width-e.width,o=t.y+t.height-e.height;return{x:Math.min(n,e.x),y:Math.min(o,e.y),width:e.width,height:e.height}}(e,t):function(t,e){const o=t.x+t.width,i=t.y+t.height,a=t.x,s=t.y,r={x:n.normalizeValue(e.x,a,o),y:n.normalizeValue(e.y,s,i)},h=n.normalizeValue(e.x+e.width,a,o),c=n.normalizeValue(e.y+e.height,s,i);return{x:r.x,y:r.y,width:h-r.x,height:c-r.y}}(e,t);return function(t,e){let{x:n,y:o,width:i,height:a}=t;const s=n+i,r=o+a,h=e.x+e.width,c=e.y+e.height;return i<=K&&s+K>h&&(n=s-K,i=K),a<=K&&r+K>c&&(o=r-K,a=K),{x:n,y:o,width:i,height:a}}(i,e)}n.injectInternalStyle("/static/js/file_viewer/comments2/annotations/creation_layer/creation_layer.module.out-vfl3PAEQU.css",(t=>"._highlight-creation-layer_303xa_1{bottom:0;left:0;position:absolute;right:0;top:0}._highlight-creation-layer_303xa_1 a::selection,._highlight-creation-layer_303xa_1 p::selection{background:var(--dig-color__highlight__yellow)}._add-annotation-highlight-button_303xa_14{background-color:var(--color__inverse__elevated__background);box-sizing:border-box;color:var(--color__inverse__standard__text);margin-left:-4px;opacity:0;padding:4px;position:absolute;transition:opacity .1s ease-in-out,margin 0ms ease-in-out .4s;z-index:1000}._add-annotation-highlight-button__visible_303xa_26{margin-left:0;opacity:1;pointer-events:all;transition:opacity .15s ease-in-out,margin .15s ease-in-out}._annotation-rectangle-creation-layer_303xa_33{bottom:0;left:0;position:absolute;right:0;top:0}._annotation-rectangle-creation-draft_303xa_41{border:3px solid var(--color__attention__text);box-sizing:border-box;cursor:all-scroll;height:100px;left:0;pointer-events:all;position:absolute;top:0;width:100px}._annotation-handle-v2_303xa_53{background:var(--color__core__secondary);border:1px solid var(--color__core__accent);border-radius:50%}._annotation-edge_303xa_61,._annotation-handle-v2_303xa_53{background-clip:padding-box;position:absolute}._highlight-segment-draft_303xa_66{background:var(--dig-color__highlight__yellow);box-sizing:border-box;opacity:.5;pointer-events:none;position:absolute}"));class q extends O.PureComponent{get className(){return n.cx("_highlight-creation-layer_303xa_1")}render(){const{className:t}=this,{highlight:e}=this.props;return O.createElement("div",{className:t},this.props.children,e&&{highlight:e}.highlight.map(((t,e)=>O.createElement("div",{key:`sc-annotation-highlight-draft-${e}`,style:n.toRectangleStyle(t),className:"_highlight-segment-draft_303xa_66"}))))}}q.displayName="AnnotationHighlightCreationLayer";class H extends O.PureComponent{constructor(t){super(t),this.requestId=null,this.updateStyles=()=>{this.setState(((t,e)=>(this.requestId=null,{style:e.style})))},this.state={style:t.style}}componentWillUnmount(){this.requestId&&cancelAnimationFrame(this.requestId)}componentDidUpdate(){this.requestId||(this.requestId=requestAnimationFrame(this.updateStyles))}render(){return O.Children.only(this.props.children(this.state.style))}}var V,X;H.displayName="RafStyle",function(t){t.TopLeft="topLeft",t.TopRight="topRight",t.BottomLeft="bottomLeft",t.BottomRight="bottomRight"}(V||(V={})),function(t){t.Top="top",t.Bottom="bottom",t.Left="left",t.Right="right"}(X||(X={}));const Y="drag";var $;!function(t){t[t.Ignore=0]="Ignore",t[t.NotExceeded=1]="NotExceeded",t[t.Exceeded=2]="Exceeded"}($||($={}));function G(t){return 0===t.button}function W({x:t,y:e,width:n,height:o},{deltaX:i,deltaY:a},s){switch(s){case Y:return{x:t+i,y:e+a,width:n,height:o};case V.BottomRight:return{x:i<-n?t+(n+i):t,y:a<-o?e+(o+a):e,width:Math.abs(n+i),height:Math.abs(o+a)};case V.BottomLeft:return{x:i>n?t+n:t+i,y:a<-o?e+(o+a):e,width:Math.abs(n-i),height:Math.abs(o+a)};case V.TopRight:return{x:i<-n?t+(n+i):t,y:a>o?e+o:e+a,width:Math.abs(n+i),height:Math.abs(o-a)};case V.TopLeft:return{x:i>n?t+n:t+i,y:a>o?e+o:e+a,width:Math.abs(n-i),height:Math.abs(o-a)};case X.Left:return{x:i>n?t+n:t+i,y:e,width:Math.abs(n-i),height:o};case X.Right:return{x:i<-n?t+(n+i):t,y:e,width:Math.abs(n+i),height:o};case X.Top:return{x:t,y:a>o?e+o:e+a,width:n,height:Math.abs(o-a)};case X.Bottom:return{x:t,y:a<-o?e+(o+a):e,width:n,height:Math.abs(o+a)}}}function J(t){const e="-5px",n="6px",o="0",i={bottom:o,top:o,left:o,right:o};switch(t){case X.Top:return Object.assign(Object.assign({},i),{top:e,height:n,bottom:void 0,cursor:"n-resize"});case X.Left:return Object.assign(Object.assign({},i),{left:e,width:n,right:void 0,cursor:"w-resize"});case X.Bottom:return Object.assign(Object.assign({},i),{bottom:e,height:n,top:void 0,cursor:"s-resize"});case X.Right:return Object.assign(Object.assign({},i),{right:e,width:n,left:void 0,cursor:"e-resize"})}}function Q(t){const e={width:"12px",height:"12px"},n="-7px";switch(t){case V.TopLeft:return Object.assign(Object.assign({},e),{top:n,left:n,cursor:"nw-resize"});case V.TopRight:return Object.assign(Object.assign({},e),{top:n,right:n,cursor:"ne-resize"});case V.BottomLeft:return Object.assign(Object.assign({},e),{bottom:n,left:n,cursor:"sw-resize"});case V.BottomRight:return Object.assign(Object.assign({},e),{bottom:n,right:n,cursor:"se-resize"})}}const Z="_annotation-handle-v2_303xa_53",tt="_annotation-edge_303xa_61",et={[V.TopLeft]:Z,[V.TopRight]:Z,[V.BottomLeft]:Z,[V.BottomRight]:Z,[X.Top]:tt,[X.Right]:tt,[X.Bottom]:tt,[X.Left]:tt},nt={[V.TopLeft]:Q(V.TopLeft),[V.TopRight]:Q(V.TopRight),[V.BottomLeft]:Q(V.BottomLeft),[V.BottomRight]:Q(V.BottomRight),[X.Top]:J(X.Top),[X.Left]:J(X.Left),[X.Right]:J(X.Right),[X.Bottom]:J(X.Bottom)};function ot(t){const{x:e,y:n,width:o,height:i}=t;return{transform:`translate(${e}px, ${n}px)`,width:o,height:i}}const it=t=>t.preventDefault();class at extends O.PureComponent{constructor(t){super(t),this.state={clickThreshold:$.NotExceeded,internalPlacement:null},this.ref=null,this.rectangleRef=null,this.onDeltaStart=(t,e,n=!1)=>{if(G(t)){this.disableDragSelect();const{clientX:o,clientY:i}=t,a=this.rectangleRef,s={x:o,y:i},r=n?Object.assign(Object.assign({},s),{width:0,height:0}):a&&function({top:t,left:e,width:n,height:o}){return{x:e,y:t,width:n,height:o}}(a.getBoundingClientRect());r&&(this.attachListeners(),this.props.onRectChangeStart(n),this.setState({resizeDragMeta:{originPoint:s,deltaMovement:e,originRect:r}}))}},this.onDeltaChange=t=>{const{resizeDragMeta:e,clickThreshold:n}=this.state;if(!e||!this.rectCanChange(t))return;const{clientX:o,clientY:i}=t,{originPoint:a,deltaMovement:s,originRect:r}=e,h=function(t,{x:e,y:n}){return{deltaX:e-t.x,deltaY:n-t.y}}(a,{x:o,y:i});n===$.NotExceeded?(this.setState({clickThreshold:$.Exceeded}),this.props.onRectChange(W(r,h,s),"drag"===s,!0)):this.props.onRectChange(W(r,h,s),"drag"===s)},this.onDeltaEnd=()=>{this.state.clickThreshold===$.NotExceeded&&this.props.clearPlacement(),document.removeEventListener("selectstart",it),this.removeListeners(),this.props.onRectChangeEnd(),this.setState({resizeDragMeta:void 0,clickThreshold:$.Ignore})},this.onRectangleMouseDown=t=>{t.currentTarget===t.target&&this.onDeltaStart(t,Y)},this.setRef=t=>{this.ref=t},this.setRectangleRef=t=>{this.rectangleRef=t},this.onLayerMouseDown=t=>{const e=t.target,n=function(t){const e=t.target.tagName.toUpperCase();return"P"===e||"TEXT"===e}(t)||function(t){return"A"===t.target.tagName}(t),o=this.rectangleRef&&this.rectangleRef.contains(e);n||o||(this.setState({clickThreshold:$.NotExceeded}),this.onDeltaStart(t,V.BottomRight,!0))};this.resizerV2=[X.Top,X.Left,X.Right,X.Bottom,V.TopLeft,V.TopRight,V.BottomLeft,V.BottomRight].map((t=>O.createElement("div",{style:nt[t],key:t,className:et[t],onMouseDown:e=>this.onDeltaStart(e,t)})))}attachListeners(){document.addEventListener("mousemove",this.onDeltaChange,!0),document.addEventListener("mouseup",this.onDeltaEnd)}removeListeners(){document.removeEventListener("mousemove",this.onDeltaChange),document.removeEventListener("mouseup",this.onDeltaEnd)}disableDragSelect(){document.addEventListener("selectstart",it)}rectCanChange(t){const{resizeDragMeta:e,clickThreshold:n}=this.state;return n!==$.NotExceeded||e&&function({x:t,y:e},{clientX:n,clientY:o}){return Math.max(Math.abs(t-n),Math.abs(e-o))>5}(e.originPoint,t)}maybeRenderAnnotationDraft(){const{placement:t}=this.props;return t?O.createElement(H,{style:t},(t=>t?O.createElement(O.Fragment,null,O.createElement("div",{ref:this.setRectangleRef,style:ot(t),className:n.cx("_annotation-rectangle-creation-draft_303xa_41"),onMouseDown:this.onRectangleMouseDown},this.resizerV2),O.createElement(i.AnnotationCutoutOverlay,{placement:t})):null)):null}render(){const{setRef:t,onLayerMouseDown:e}=this;return O.createElement("div",{ref:t,className:"_annotation-rectangle-creation-layer_303xa_33",onMouseDown:e},this.props.children,this.maybeRenderAnnotationDraft())}}at.displayName="AnnotationRectangleCreationLayer";class st extends O.PureComponent{constructor(t){super(t),this.mouseDownSurface=F.None,this.hasMouseMoved=!1,this.layerRef=null,this.onDragStart=t=>{this.props.canCreateRectangle&&t.preventDefault()},this.onKeyDown=t=>{const e=this.state.internalAnnotation;if(!e||"rnd"!==e.type)return;let n=!1;"Enter"===t.key?(this.onRectChangeEnd(),n=!0):"ArrowUp"===t.key?(this.onArrowKey(0,-1,t.shiftKey),n=!0):"ArrowDown"===t.key?(this.onArrowKey(0,1,t.shiftKey),n=!0):"ArrowLeft"===t.key?(this.onArrowKey(-1,0,t.shiftKey),n=!0):"ArrowRight"===t.key&&(this.onArrowKey(1,0,t.shiftKey),n=!0),n&&(t.stopImmediatePropagation(),t.preventDefault())},this.onMouseMove=t=>{const{annotation:e}=this.props,n=0===(void 0!==t.buttons?t.buttons:t.nativeEvent.which);this.hasMouseMoved=!0,!n||e||this.onHoverPointChange(i.toPoint(t))},this.onMouseDown=t=>{G(t)&&(this.mouseDownSurface=function(t){return function(t){return"A"===t.target.tagName}(t)?F.Link:function(t){const e=t.target.tagName.toUpperCase();return"P"===e||"TEXT"===e}(t)?F.Text:function(t,e){return t.target.classList.contains(e)}(t,I)||function(t){return"IMG"===t.target.tagName}(t)?F.Creation:F.None}(t),this.hasMouseMoved=!1)},this.onMouseUp=t=>{const{annotation:e,handleClick:n}=this.props;this.hasMouseMoved||this.mouseDownSurface===F.None||(e?this.attemptClearAllAnnotations():n&&n(i.toPoint(t))),this.mouseDownSurface=F.None},this.onHoverPointChange=o.throttle((t=>{const{onHoverPointChange:e}=this.props;e&&e(t)}),50),this.onMouseLeave=()=>{this.onHoverPointChange(void 0)},this.onRectChangeStart=()=>{const{layerSize:t}=this.props;if(this.layerRef&&t){const{left:e,top:n}=this.layerRef.getBoundingClientRect(),{width:o,height:i}=t,a={x:e,y:n,width:o,height:i};return this.setState({layerRect:a}),a}},this.onRectChange=(t,e,o)=>{const{layerRect:i}=this.state;if(i&&this.props.canCreateRectangle){const a=function(t,e){return n.createNormalizedRegion({left:t.x,top:t.y,width:t.width,height:t.height},{left:e.x,top:e.y,width:e.width,height:e.height})}(U(t,i,e),i);o?this.props.onAnnotationChange({type:"rnd",regions:[a]},!0):(this.setState({internalAnnotation:{type:"rnd",regions:[a]}}),this.setLiveFeedback(a,e))}},this.onRectChangeEnd=()=>{var t,e;const{internalAnnotation:n}=this.state;n?(this.props.onAnnotationChange(n,!1),null===(e=(t=this.props).onAnnotationConfirm)||void 0===e||e.call(t)):this.props.canDismiss&&this.props.onAnnotationChange(null,!1),this.setState({layerRect:null})},this.setLayerRef=t=>{t&&(this.layerRef=t,this.layerRef.addEventListener("keydown",this.onKeyDown))},this.attemptClearHighlightPlacement=()=>{this.attemptClearAnnotation("highlight")},this.attemptClearRectanglePlacement=()=>{this.attemptClearAnnotation("rnd")},this.attemptClearAllAnnotations=()=>{this.attemptClearHighlightPlacement(),this.attemptClearRectanglePlacement()},this.attemptClearAnnotation=t=>{const{annotation:e}=this.props;this.annotationIsDismissable&&e&&e.type===t&&this.props.onAnnotationChange(null,!1)},this.state={layerRect:null,internalAnnotation:t.annotation,liveFeedback:""}}get className(){const{canCreateRectangle:t}=this.props;return n.cx(I,{"_sc-annotation-conductor-layer__can-create_niric_10":t,"_sc-annotation-conductor-layer__is-creating-rnd_niric_21":this.state.layerRect})}get rectanglePlacement(){const{layerSize:t}=this.props,{internalAnnotation:e}=this.state;if(e&&"rnd"===e.type){const n=e.regions[0];return i.createPlacementFromNormalizedRegion(n,t.width,t.height)}return null}get highlightPlacement(){const{annotation:t}=this.props;return"highlight"===(null==t?void 0:t.type)?t.regions:null}get annotationIsDismissable(){return null!==this.props.annotation&&this.props.canDismiss}setLiveFeedback(t,e){const n=this.props.intl,o=e?n.formatMessage({id:"Ycv46p",defaultMessage:"Annotation updated with position x: {x}, y: {y}"},{x:Math.round(100*t.x),y:Math.round(100*t.y)}):n.formatMessage({id:"JCBqbG",defaultMessage:"Annotation updated with size width: {width}, height: {height}"},{width:Math.round(100*t.width),height:Math.round(100*t.height)});this.setState({liveFeedback:o})}onArrowKey(t,e,n){const{layerRect:o,internalAnnotation:a}=this.state;if(!o||!a)return;const{x:s,y:r,width:h,height:c}=a.regions[0],{width:l,height:d}=this.props.layerSize,g=.01;let u;u=n?{x:s,y:r,width:h+t*g,height:c+e*g}:{x:s+t*g,y:r+e*g,width:h,height:c};const m=i.createPlacementFromNormalizedRegion(u,l,d,o);this.onRectChange(m,!n)}componentDidUpdate({annotationState:t,annotation:e}){const{annotation:n,annotationState:o,canCreateRectangle:i,onAnnotationChange:a,isActive:s}=this.props;if(null==n&&null!=e)this.setState({internalAnnotation:n});else if(null!=n&&null==e)this.setState({internalAnnotation:n});else if(s&&"annotating-ax"===o&&i&&"annotating-ax"!==t){const t=this.onRectChangeStart();if(t){a({type:"rnd",regions:[{x:0,y:0,width:t.width>500?200/t.width:.2,height:t.height>250?100/t.height:.1}]},!1),this.layerRef.focus()}}}componentWillUnmount(){this.layerRef&&this.layerRef.removeEventListener("keydown",this.onKeyDown)}render(){const{highlightPlacement:t,rectanglePlacement:e,props:n,className:o}=this,{children:i,intl:s,annotationState:r}=n;return O.createElement(a.Provider,{value:s},O.createElement("div",{ref:this.setLayerRef,onMouseDown:this.onMouseDown,onMouseUp:this.onMouseUp,onMouseLeave:this.onMouseLeave,onMouseMove:this.onMouseMove,className:o,onDragStart:this.onDragStart,tabIndex:-1},O.createElement(q,{highlight:t},O.createElement(at,{placement:e,clearPlacement:this.attemptClearRectanglePlacement,onRectChangeStart:this.onRectChangeStart,onRectChange:this.onRectChange,onRectChangeEnd:this.onRectChangeEnd,annotationState:r},i))),O.createElement("div",{style:{opacity:0,position:"absolute"},"aria-live":"polite"},this.state.liveFeedback))}}st.displayName="AnnotationConductorLayer";const rt=t=>{const{dispatch:e,annotationState:o,layer:i,draftAnnotation:a,ui:{scaleFactor:s},children:r,platform:h,isActive:c,handleClick:l,onHoverPointChange:d,handleRegionSelection:g,handleAnnotationConfirm:u}=t,{pluginNavigation:m,fileViewerId:p}=n.useFileViewerContext(),_=O.default.useCallback(((t,e)=>{g(t,e,"pageIndex"in i?i.pageIndex:null)}),[i,g]),f=n.isEditingAnnotation(o);if(O.default.useEffect((()=>{if(f)return()=>{e(n.cancelAnnotating(p))}}),[f,e,m,p]),null==i.dimensions)return O.default.createElement(O.default.Fragment,null,r);const{height:y,width:v}=i.dimensions;return O.default.createElement(O.default.Fragment,null,O.default.createElement(st,{canCreateRectangle:n.isEditingAnnotation(o),canDismiss:!0,annotation:a,onAnnotationChange:_,onAnnotationConfirm:u,handleClick:l,onHoverPointChange:d,layerSize:{height:y*s,width:v*s},intl:h.intl,annotationState:o,isActive:c},r))};rt.displayName="AnnotationConductor",t.AnnotationConductor=rt}));
//# sourceMappingURL=c_comments2_annotations_conductor.js-vflgLxSu8.map
