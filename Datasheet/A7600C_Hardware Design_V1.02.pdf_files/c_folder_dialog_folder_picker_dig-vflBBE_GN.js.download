define(["require","exports","./c_tslib","react","./e_file_viewer_edison_shmodel_file_async","./c_table_columns_file_name_column","./c_spectrum_icon_arrow_index","./c_browse_interface","./c_folder_dialog_constants","./e_edison","./c_core_i18n","./e_core_exception","./c_core_exception_info","./c_ui-icon_line_help"],(function(e,t,a,s,l,r,n,o,i,c,d,u,h,p){"use strict";function _(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(a){if("default"!==a){var s=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(t,a,s.get?s:{enumerable:!0,get:function(){return e[a]}})}})),t.default=e,Object.freeze(t)}var f=_(s);const S=f.memo((e=>{var{path:t,size:s,user:r,useFullPath:n,isForCurrentPath:o,setUrl:i,rootReplacement:c,isBrowseSectionBreadcrumb:d,handleDragEnter:u,handleDragEnd:h}=e,p=a.__rest(e,["path","size","user","useFullPath","isForCurrentPath","setUrl","rootReplacement","isBrowseSectionBreadcrumb","handleDragEnter","handleDragEnd"]);const _=l.normalize(t),S=c||l.Viewer.get_root_name(r),E=l.parent_dirs(_).reverse();E.unshift(""),n&&""!==_&&E.push(_);const m=l.cx("file-breadcrumb-link",{"browse-section-breadcrumb-link":d});return f.createElement(l.Breadcrumb,Object.assign({size:s,isRootOverflow:!0},p),E.map(((e,t)=>{const a=o&&t===E.length-1,s=a?void 0:l.browse_uri_for_fq_path(r,e).toString(),n=a?void 0:function(e,t){return a=>{0===a.button&&(a.altKey||a.ctrlKey||a.metaKey||a.shiftKey)||(a.preventDefault(),t(e))}}(e,i);return f.createElement(l.Breadcrumb.Link,{key:l.filename(e,S),href:s,isCurrentPath:a,onClick:n,className:m,onDragEnter:u?u(E[t]):void 0,onDragEnd:h||void 0},l.getDisplayedFilename(l.filename(e,S)))})))}));S.displayName="FileBreadcrumb";const E=l.Loadable({loader:()=>a.__awaiter(void 0,void 0,void 0,(function*(){const{BoxEmptySpot:t}=yield new Promise((function(t,a){e(["./c_mjs_spot_box-empty"],t,a)}));return t}))}),m=l.Loadable({loader:()=>a.__awaiter(void 0,void 0,void 0,(function*(){const{TargetMissSpot:t}=yield new Promise((function(t,a){e(["./c_mjs_spot_target-miss"],t,a)}));return t}))}),g=l.requireCssWithComponent(E,["/static/metaserver/static/css/dig-illustrations/index.web-vflue6lPZ.css"]),C=l.requireCssWithComponent(m,["/static/metaserver/static/css/dig-illustrations/index.web-vflue6lPZ.css"]);class y{constructor(){this.getAccessLevel=e=>e.icon.endsWith(i.ACCESS_LEVEL.NO_ACCESS)||l.BACKUP_ICONS.includes(e.icon)?i.ACCESS_LEVEL.NO_ACCESS:e.icon.endsWith(i.ACCESS_LEVEL.LIMITED_ACCESS_VAULT)?i.ACCESS_LEVEL.LIMITED_ACCESS_VAULT:e.icon.endsWith(i.ACCESS_LEVEL.LIMITED_ACCESS)||e.read_only?i.ACCESS_LEVEL.LIMITED_ACCESS:i.ACCESS_LEVEL.ACCESS,this.convertJsonFolderToFolder=e=>{const{path:t,icon:a,has_subdirs:s,contained_ns:l}=e,r=this.getAccessLevel(e),n=r===i.ACCESS_LEVEL.LIMITED_ACCESS_VAULT||r===i.ACCESS_LEVEL.ACCESS||r===i.ACCESS_LEVEL.LIMITED_ACCESS&&this.canSelectReadonly,o=r===i.ACCESS_LEVEL.LIMITED_ACCESS_VAULT||r===i.ACCESS_LEVEL.ACCESS||r===i.ACCESS_LEVEL.LIMITED_ACCESS&&(this.canSelectReadonly||s);return{path:t,isReadOnly:e.read_only,icon:a,hasSubfolders:s,isSelectable:n&&(!e.is_encrypted||this.canSelectEncrypted),isClickable:o&&(!e.is_encrypted||this.canSelectEncrypted),nsId:l,isLockedVaultFolder:r===i.ACCESS_LEVEL.LIMITED_ACCESS_VAULT&&e.read_only,isEncrypted:"folder_team_encrypted_32"===a||"folder_team_encrypted"===a}},this.cachedFolders=new Map}setProps(e,t,a,s,l){this.apiClient=e,this.user=t,this.canSelectReadonly=a,this.canSelectEncrypted=s,this.onDataLoaded=l}fetchFolderData(e){return a.__awaiter(this,void 0,void 0,(function*(){const t=yield this.apiClient.getFolderContents(this.user.id,e);if(this.onDataLoaded&&this.onDataLoaded(e),!t)return[];const a=t.map(this.convertJsonFolderToFolder),s=this.user.cdm_tmf_path&&l.paths_are_equal(e,"/")?[...a.filter((e=>l.paths_are_equal(e.path,this.user.cdm_tmf_path))),...a.filter((e=>!l.paths_are_equal(e.path,this.user.cdm_tmf_path)))]:a;return this.cachedFolders.set(l.normalize(e).toLowerCase(),s),s}))}fetchInstantFolderContents(e){const t=l.normalize(e);return this.cachedFolders.get(t.toLowerCase())}fetchFolderContents(e){return a.__awaiter(this,void 0,void 0,(function*(){const t=l.normalize(e);return this.fetchInstantFolderContents(e)||this.fetchFolderData(t)}))}}const F=r.createManagedTable(r.useFlexLayout,r.useKeyboarding);const v=({size:e})=>{const t=d.intl.formatMessage({id:"BAyazl",defaultMessage:"This is the only folder there is."});return f.default.createElement(d.Provider,{value:d.intl},f.default.createElement("div",{className:l.cx("folder-picker__empty-message","u-font-center",{"u-pad-top-xl":"small"!==e})},f.default.createElement(g,null),"small"===e?f.default.createElement("span",null,t):f.default.createElement("h2",{className:"u-pad-top-l"},t)))};v.displayName="EmptyMessage";const b=()=>f.default.createElement("div",{className:"folder-picker__error"},f.default.createElement(C,null),f.default.createElement("span",null,d.intl.formatMessage({id:"UIh+KT",defaultMessage:"Something went wrong on our end.  Please reload and try again."}))),L=()=>{const e=d.intl.formatMessage({id:"G09nql",defaultMessage:"Loading your foldersâ€¦"});return f.default.createElement(d.Provider,{value:d.intl},f.default.createElement("div",{className:"folder-picker-dig-loading "},f.default.createElement(l.Spinner,{"aria-valuetext":e,size:"xsmall"}),f.default.createElement("span",{className:"folder-picker-dig-loading-label"},e)))};class k{constructor(){this.appendReactableData=e=>{const t=[];return e.forEach(((e,a)=>{t.push(Object.assign(Object.assign({},e),{title:l.Emstring.em_snippet(l.filename(e.path),i.MAX_FOLDER_NAME_LENGTH),uniqueKey:""+e.nsId,isFolder:!0,isShared:!1,extension:"",path:e.path,index:a,isSelected:!1}))})),t},this.getDisplayableFolderList=e=>a.__awaiter(this,void 0,void 0,(function*(){const t=yield x.fetchFolderContents(e);return this.appendReactableData(t)})),this.getInstantDisplayableFolderList=e=>{const t=x.fetchInstantFolderContents(e);if(t)return this.appendReactableData(t)},this.getSingleCachedFolder=e=>{const t=this.getInstantDisplayableFolderList(l.parent_dir(e));let a=null;return null==t||t.some((t=>!!l.paths_are_equal(t.path,e)&&(a=t,!0))),a},this.getSingleFolder=e=>a.__awaiter(this,void 0,void 0,(function*(){let t=this.getInstantDisplayableFolderList(l.parent_dir(e));t||(t=yield this.getDisplayableFolderList(l.parent_dir(e)));let a=null;return null==t||t.some((t=>!!l.paths_are_equal(t.path,e)&&(a=t,!0))),a}))}}class w{constructor(){this.selectedIndex=0,this.prevKeyScope="",this.claimFocusAfterNavigate=!1,this.keysActive=!1,this.updateFolderData=e=>{this.folderData=e},this.handleChoice=()=>{if(!this.folderData[this.selectedIndex].isClickable)return;this.claimFocusAfterNavigate=!0;const e=this.folderData[this.selectedIndex];this.handleFolderChoice(e)},this.setupKeyboardShortcuts=()=>{this.changedFocusedFolder(),this.keysActive||(this.keysActive=!0,this.prevKeyScope=l.key.getScope(),this.prevKeyScope!==i.KEY_SCOPE&&l.key.setScope(i.KEY_SCOPE),l.key("up",i.KEY_SCOPE,(()=>{this.selectedIndex=this.selectedIndex-1,this.changedFocusedFolder()})),l.key("down",i.KEY_SCOPE,(()=>{this.selectedIndex=this.selectedIndex+1,this.changedFocusedFolder()})),l.key("left",i.KEY_SCOPE,(()=>{this.claimFocusAfterNavigate=!0,this.changedFocusedFolder(),this.goToParent()})),l.key("right",i.KEY_SCOPE,this.handleChoice),l.key("space",i.KEY_SCOPE,this.handleChoice),l.key("enter",i.KEY_SCOPE,(()=>{this.changedFocusedFolder(),this.handleChoice(),void 0!==this.onSuccess&&this.onSuccess()})))},this.cleanupKeyboardShortcuts=()=>{this.keysActive=!1,l.key.clearScope(i.KEY_SCOPE),this.prevKeyScope&&l.key.setScope(this.prevKeyScope),l.key.resetFilter()},this.setFocus=()=>{if(!this.claimFocusAfterNavigate)return;const e=document.querySelector(".folder-picker-container table tr");e&&(e.setAttribute("tabindex","-1"),e.focus()),this.claimFocusAfterNavigate=!1}}}const A=(e,t,a)=>{let s,l,r,n,o=!1;const{onFolderSelected:i,user:c,canSelectReadonly:d}=t;let u;e&&"/"!==e.path?(u=e.path,s=e.isLockedVaultFolder,l=e.nsId,o=e.isSelectable,r=e.isReadOnly,n=e.isEncrypted):(u="",r="view"===c.user_root_permissions,o=!c.is_cdm_member&&!c.is_tmr_member||!r||d,l=c.root_ns_id,n=!1),o||t.forceFolderSelectedCallback?i({path:u,nsId:l,predictionId:a,isLockedVaultFolder:s,isReadOnly:r,isEncrypted:n}):i({})},I=()=>{const e=d.intl.formatMessage({id:"oDXE4c",defaultMessage:"Based on previous activity and file type"});return f.default.createElement(l.Tooltip,{title:e},f.default.createElement(l.IconButton,{variant:"transparent"},f.default.createElement(l.UIIcon,{src:p.HelpLine,className:"icon-help","aria-label":e})))};I.displayName="SuggestionHeaderTooltip";const D=()=>{const e=d.intl.formatMessage({id:"qdhuuB",defaultMessage:"Suggested location"});return f.default.createElement("span",null,e,f.default.createElement(I,null))};D.displayName="SuggestionHeaderText";const N=e=>{const t=l.parent_dir(e.path),a=l.paths_are_equal(t,"/")?e.rootName:t.slice(1),s=d.intl.formatMessage({id:"R7F8Tb",defaultMessage:"in {location}"},{location:a});return f.default.createElement("a",{href:"#",className:"suggestion_parent",onClick:t=>{t.stopPropagation(),e.handleClick()}},s)};N.displayName="FolderSuggestionLocation";class P{constructor(e,t,s){this.fetch=()=>a.__awaiter(this,void 0,void 0,(function*(){try{const e=yield this.fetchFolderSuggestion(this.user.id);this.onFetch(e)}catch(e){const t=e.raw?e.raw.responseBody:"Received error response from folder suggestion API";u.reportException({err:new Error(t),tags:["folder_suggestion"],severity:h.SEVERITY.NONCRITICAL})}})),this.fetchFolderSuggestion=e,this.user=t,this.onFetch=s}}const T=e=>{const[t,a]=s.useState(""),n={uniqueKey:e.path,title:l.filename(e.path),isFolder:!0,icon:t};let o="",c=!1;s.useEffect((()=>{O.getSingleFolder(e.path).then((e=>{null!==e&&a(e.icon)}))}),[e.path]);const d=f.default.createElement(N,{path:l.parent_dir(e.path),handleClick:e.handleLocationClick,rootName:e.rootName});let u="folder-suggestion-location";return e.selected&&(u+=" folder-suggestion-location-selected"),f.default.createElement("div",{className:"folder-suggestion-dig",onFocus:()=>{c||(c=!0,o=l.key.getScope(),o!==i.SUGGESTED_LOCATION_KEY_SCOPE&&l.key.setScope(i.SUGGESTED_LOCATION_KEY_SCOPE),e.handleLocationClick())},onBlur:()=>{l.key.clearScope(i.SUGGESTED_LOCATION_KEY_SCOPE),o&&l.key.setScope(o),l.key.resetFilter()}},f.default.createElement(D,null),f.default.createElement("span",{role:"button",className:u,onClick:e.handleClick},f.default.createElement(r.FileNameCell,{file:n,subTitle:d})))};let x,O,M,R;T.displayName="FolderSuggestionDisplay";const K=e=>{var t;const[i,u]=s.useState(null!==(t=e.initialPath)&&void 0!==t?t:"/"),h=s.useRef(""),[p,_]=s.useState([]),E=s.useRef(!1),m=e.size||"standard",{showEmptyFolders:g,onError:C,onFolderSelected:I,onRowClicked:D}=e,[N,K]=s.useState(void 0),[V,q]=s.useState(!1),B=s.useMemo((()=>{return t=e.currentUserPath,[{id:"filename",Cell:({row:{original:e}})=>f.default.createElement(r.FileNameCell,{file:e}),accessor:e=>e.title,width:300},{id:"current_folder_token",Cell:({row:{original:{path:e}}})=>e===t?f.default.createElement(l.AccessoryBadge,null,d.intl.formatMessage({id:"dNc7Si",defaultMessage:"Current folder"})):null,width:void 0},{id:"drilldown_arrow",accessor:e=>e.hasSubfolders?f.default.createElement(n.IconArrow,{name:"right"}):"",width:void 0}];var t}),[e.currentUserPath]),U=s.useCallback((t=>{const a={user:e.user,canSelectReadonly:e.canSelectReadonly,canSelectEncrypted:e.canSelectEncrypted,onFolderSelected:I,forceFolderSelectedCallback:e.forceFolderSelectedCallback};null==D||D(t.path,t.index,!1),t.hasSubfolders||g||(h.current=t.path),u(t.path),A(t,a)}),[e.user,e.canSelectReadonly,e.canSelectEncrypted,e.forceFolderSelectedCallback,I,D,g]),z=s.useCallback(((t,s)=>a.__awaiter(void 0,void 0,void 0,(function*(){u(t),q(null!=s);const a={user:e.user,canSelectReadonly:e.canSelectReadonly,canSelectEncrypted:e.canSelectEncrypted,onFolderSelected:e.onFolderSelected,forceFolderSelectedCallback:e.forceFolderSelectedCallback};O.getSingleFolder(t).then((e=>{A(e,a,s)}))}))),[e.user,e.canSelectReadonly,e.canSelectEncrypted,e.onFolderSelected,e.forceFolderSelectedCallback]);s.useMemo((()=>{x=new y,O=new k,M=new w,M.goToParent=()=>{},M.onSuccess=e.onSuccess,M.changedFocusedFolder=()=>{q(!1)}}),[e.onSuccess]),s.useMemo((()=>{x.setProps(e.apiClient,e.user,e.canSelectReadonly,e.canSelectEncrypted,e.onDataLoaded)}),[e.apiClient,e.user,e.canSelectReadonly,e.canSelectEncrypted,e.onDataLoaded]),s.useEffect((()=>{(()=>{const e=new Image;e.src=c.static_url("/static/metaserver/static/images/illustration_catalog/dropbox_somethings_not_working-vfl2QXPxi.png"),e.srcset=c.static_url("/static/metaserver/static/images/illustration_catalog/dropbox_somethings_not_working@2x-vflkcbmXv.png")+" 2x"})()}),[]),s.useEffect((()=>{e.apiClient.fetchFolderSuggestion&&(R=new P(e.apiClient.fetchFolderSuggestion,e.user,(t=>{var a,s;const{path:l,prediction_id:r,suggest_id:n}=t;if(l){const t={path:l,predictionId:r};null===(s=e.onFetchFolderSuggestionSuccess)||void 0===s||s.call(e,[t],n),K(t)}else null===(a=e.onFetchFolderSuggestionSuccess)||void 0===a||a.call(e,[],n)})),R.fetch())}),[e.apiClient.fetchFolderSuggestion,e.user,e.onFetchFolderSuggestionSuccess]),s.useEffect((()=>{M.goToParent=()=>{z(l.parent_dir(h.current))}}),[z]),s.useEffect((()=>{M.handleFolderChoice=U}),[U]),s.useEffect((()=>{M.onSuccess=e.onSuccess}),[e.onSuccess]),s.useEffect((()=>{M.updateFolderData(p),M.selectedIndex=0,M.setFocus()}),[p]),s.useEffect((()=>{const e=()=>a.__awaiter(void 0,void 0,void 0,(function*(){let e=yield O.getDisplayableFolderList(i);0!=e.length||l.paths_are_equal(i,"/")||g||(e=yield O.getDisplayableFolderList(l.parent_dir(i))),h.current=i,_(e),z(i)}));(()=>{const t=O.getInstantDisplayableFolderList(i),a=O.getSingleCachedFolder(i);if(h.current&&void 0!==t&&t.length<1&&!l.paths_are_equal(i,"/"))h.current=i;else if(!h.current||!1!==(null==a?void 0:a.hasSubfolders)||g||l.paths_are_equal(i,"/")){if(t)return h.current=i,void _(t);try{I({isLoading:!0}),e()}catch(e){s=e,null==C||C(s),I({}),E.current=!0}var s}else h.current=i})()}),[i,C,I,g]);const Y=s.useRef(!1);e.initialPath&&!Y.current&&(Y.current=!0,z(e.initialPath));const j=()=>i!==h.current;let G,W=null;if(E.current)G=f.default.createElement(b,null);else if(j())G=f.default.createElement(L,null);else if(j()||p.length>0){const t=o.get_browse_root_name(e.user);void 0!==N&&(W=f.default.createElement(T,{path:N.path,handleClick:()=>{var t;null===(t=e.onFolderSuggestionClick)||void 0===t||t.call(e,N),z(N.path,N.predictionId)},handleLocationClick:()=>{var t;null===(t=e.onFolderSuggestionLocationClick)||void 0===t||t.call(e,N),z(l.parent_dir(N.path),N.predictionId)},rootName:t,selected:V})),G=f.default.createElement("div",{className:"folder-picker-container folder-picker-dig-container",onFocus:M.setupKeyboardShortcuts,onBlur:M.cleanupKeyboardShortcuts},f.default.createElement(F,{isSelectable:!0,columns:B,data:p,showHeader:!1,getPropsForRow:e=>({disabled:!e.isClickable,onClick:()=>{U(e)},filename:e.title,className:e.isClickable?"":"not-clickable"})}))}else G=f.default.createElement(v,{size:m});return f.default.createElement(d.Provider,{value:d.intl},W,f.default.createElement("div",{className:"folder-picker-dig__breadcrumbs"},f.default.createElement("h1",{className:"ax-visually-hidden"},l.filename(h.current)),f.default.createElement(S,{useFullPath:!0,isForCurrentPath:!0,user:e.user,setUrl:t=>{var a;null===(a=e.onBreadcrumbClicked)||void 0===a||a.call(e,t),z(t)},path:h.current,size:"small"})),G)};K.displayName="FolderPickerTableNoCss";const V=l.requireCssWithComponent(K,["/static/metaserver/static/css/browse/browse-vfl5S35bk.css","/static/metaserver/static/css/react/folder_picker-vflkuYDwD.css","/static/metaserver/static/css/scooter/scooter-scoped-vflcqLzQ9.css","/static/metaserver/static/css/dig-components/index.web-vfleuI413.css","/static/typescript/component_libraries/dig-experimental/src/index.web-vflMgkV3K.css"]);t.FolderPicker=V}));
//# sourceMappingURL=c_folder_dialog_folder_picker_dig.js-vflpEboCN.map
