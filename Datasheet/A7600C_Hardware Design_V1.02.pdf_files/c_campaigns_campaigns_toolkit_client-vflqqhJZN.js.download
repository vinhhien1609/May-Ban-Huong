define(["require","exports","./c_tslib","react","./c_init_data_runtime","./e_file_viewer_edison_shmodel_file_async","./e_core_exception","./c_core_exception_info","./c_campaigns_types","./c_campaigns_utils_logging","./c_campaigns_history_utils","./c_apex-metrics_src_types","./c_campaigns_utils_pap_logging","./c_lodash-es_lodash","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","./e_edison","./c_core_i18n","./c_src_sink_index","metaserver/static/js/langpack","./c_core_notify","react-dom","metaserver/static/js/modules/constants/env","metaserver/static/js/modules/constants/viewer","./c_core_xhr","./c_csrf","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/file_viewer_configuration","metaserver/static/js/modules/constants/file_viewer_feature_experiments","metaserver/static/js/modules/constants/fingerprintjs_constants","metaserver/static/js/modules/constants/sharing","./c_security_util","metaserver/static/js/modules/constants/login_and_register","metaserver/static/js/modules/constants/pdf_editing","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/contacts","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/unity","metaserver/static/js/modules/constants/files_spa"],(function(e,t,a,n,i,s,o,r,c,l,m,u,g,d,p,_,v,f,h,E,C,S,P,b,O,w,A,T,q,I,D,L,y,N,j,R,x,M,F,k){"use strict";function V(e){return e&&e.__esModule?e:{default:e}}var G=V(n);const U={filterFunction:()=>{const e="previews_logged_out_download_modal",t=new Date,a=t.getTime()+864e5,n=s.LocalStorage.get(e);return(!n||t.getTime()>n)&&(s.LocalStorage.set(e,a),!0)},campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.POST_DOWNLOAD_KEY_EXPIRED},B={filterFunction:({campaignProps:e,contextData:t})=>{const a=null==t?void 0:t.ungatedDropboxAiVariant;return"CONTROL"!==a&&"OFF"!==a&&(l.logCampaignQualifyEvent(s.CampaignsToolkitEvents.CAMPAIGN_QUALIFY,e),!0)},campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.VARIANT_MISMATCH},Q={filterFunction:({contextData:e})=>Object.keys(e.fileExts).every((e=>{const t=s.ExtensionCategories[e];return"VIDEO"===t||"AUDIO"===t||"IMAGE"===t||"pdf"===e})),campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.INELIGIBLE_FILE_TYPE},H={filterFunction:({contextData:e})=>{const t=m.hasEventInHistory(c.CampaignEvents.SHARE_MODAL_SETTINGS_OPENED,e);return t&&m.removeEventFromHistory(c.CampaignEvents.SHARE_MODAL_SETTINGS_OPENED,e),t},campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.HAS_OPENED_SHARE_SETTINGS},Y={filterFunction:()=>!u.is_mobile_or_tablet(),campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.MOBILE_DEVICE},W={filterFunction:({campaignProps:e})=>{const{campaign_id:t,version_id:a}=e.campaign;let n="UNKNOWN";return 7128===t&&(14935===a?n="ON":14936===a&&(n="CONTROL")),g.OALogger.logToProEvents(s.LVEFeatureActivationEvents.LVE_FEATURE_ACTIVATION_QUALIFY,{experiment:"core_act_lightweight_video_editing_feature_activation",campaignId:t,versionId:a,variantName:n}),l.logCampaignQualifyEvent(s.CampaignsToolkitEvents.CAMPAIGN_QUALIFY,e),"ON"===n},campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.CONTROL_VARIANT},J={filterFunction:({campaignProps:e})=>{const{campaign:t}=e,{campaign_id:a,version_id:n}=t;return(6971===a||8093===a)&&(l.logCampaignQualifyEvent(s.CampaignsToolkitEvents.CAMPAIGN_QUALIFY,e),15807===n||15806===n)},campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.CONTROL_VARIANT},z=({campaignProps:e,contextData:t})=>t.isFolderOrganizable,K={filterFunction:z,campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.CONTROL_VARIANT},$={filterFunction:z,campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.CONTROL_VARIANT},X={filterFunction:({campaignProps:e,contextData:t})=>{const a=e.campaign.campaign_id,n=null==t?void 0:t.loggedOutAcquisitionPagesPromoModalVariant;return!!("V1"===n&&7948===a||"V2"===n&&8107===a)&&(l.logCampaignQualifyEvent(s.CampaignsToolkitEvents.CAMPAIGN_QUALIFY,e),!0)},campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.VARIANT_MISMATCH},Z={6113:[Y,H,Q],6855:[U],6971:[J],8093:[J],7128:[W],7565:[K],7729:[$],7948:[X],8107:[X],8619:[{filterFunction:({campaignProps:e,contextData:t})=>{const{campaign_id:a,version_id:n}=e.campaign;return 8619===a&&(16131===n||16658===n||17328===n||17329===n||17336===n||17478===n)},campaignDisqualifiedReason:c.CampaignDisqualifiedReasonEnum.VARIANT_MISMATCH}],9373:[B]};const ee=s.Loadable({loader:()=>new Promise((function(t,a){e(["./c_campaign_formats_banner_campaign_banner"],t,a)})).then((({CampaignBannerConversionComponent:e})=>e))}),te=s.Loadable({loader:()=>new Promise((function(t,a){e(["./c_campaign_formats_menu_campaign_menu_item"],t,a)})).then((({CampaignMenuItemConversionComponent:e})=>e))}),ae=s.Loadable({loader:()=>new Promise((function(t,a){e(["./c_campaign_formats_modal_campaign_modal"],t,a)})).then((({CampaignModalConversionComponent:e})=>e))}),ne=s.Loadable({loader:()=>new Promise((function(t,a){e(["./c_campaign_formats_snackbar_campaign_snackbar"],t,a)})).then((({CampaignSnackbarConversionComponent:e})=>e))}),ie=s.Loadable({loader:()=>new Promise((function(t,a){e(["./c_campaign_formats_tooltip_campaign_tooltip"],t,a)})).then((({CampaignTooltip:e})=>e))}),se=s.Loadable({loader:()=>new Promise((function(t,a){e(["./c_campaign_formats_dialog_campaign_dialog"],t,a)})).then((({CampaignDialog:e})=>e))}),oe=s.Loadable({loader:()=>new Promise((function(t,a){e(["./c_campaign_formats_link_campaign_link"],t,a)})).then((({CampaignLink:e})=>e))}),re=s.Loadable({loader:()=>new Promise((function(t,a){e(["./c_campaign_formats_link_bubble_campaign_link_bubble"],t,a)})).then((({CampaignLinkBubble:e})=>e))}),ce=s.Loadable({loader:()=>new Promise((function(t,a){e(["./c_campaign_formats_action_choice_modal"],t,a)})).then((({ActionChoiceModalConversionComponent:e})=>e))}),le=s.Loadable({loader:()=>new Promise((function(t,a){e(["./c_campaign_formats_pulsar_campaign_pulsar"],t,a)})).then((({CampaignPulsar:e})=>e))}),me=s.Loadable({loader:()=>a.__awaiter(void 0,void 0,void 0,(function*(){return new Promise((function(t,a){e(["./c_custom_campaigns_onboarding_survey_modal_campaign_onboarding_survey_modal"],t,a)})).then((({OnboardingSurveyModal:e})=>e))}))}),ue=s.Loadable({loader:()=>a.__awaiter(void 0,void 0,void 0,(function*(){return new Promise((function(t,a){e(["./c_custom_campaigns_checkout_modal"],t,a)})).then((({CheckoutModal:e})=>e))}))}),ge=s.Loadable({loader:()=>a.__awaiter(void 0,void 0,void 0,(function*(){return new Promise((function(t,a){e(["./c_custom_campaigns_lmo_modal"],t,a)})).then((({LeoMigrationOnboardingModal:e})=>e))}))}),de=s.Loadable({loader:()=>a.__awaiter(void 0,void 0,void 0,(function*(){return new Promise((function(t,a){e(["./c_learning_center2"],t,a)})).then((({LearningCenterWithCampaign:e,prefetchLearningCenterData:t})=>(t(),e)))}))}),pe=s.Loadable({loader:()=>a.__awaiter(void 0,void 0,void 0,(function*(){return new Promise((function(t,a){e(["./c_custom_campaigns_mid_trial_modal"],t,a)})).then((({MidTrialModal:e})=>e))}))}),_e=e=>{const{isPreview:t,campaign:a}=e;return n.useEffect((()=>t?()=>{}:(s.campaignsEmitter.emit(a.campaign_name,Object.assign({isEnabled:!0},e)),()=>{s.campaignsEmitter.emit(a.campaign_name,Object.assign({isEnabled:!1},e))})),[e]),t?G.default.createElement("div",null,G.default.createElement("p",null,"Preview is not supported for this component."),G.default.createElement("a",{href:"https://dropbox-kms.atlassian.net/wiki/spaces/BC/pages/900346067/Campaigns+API+v2"},"Please visit here for more information.")):null};_e.displayName="EventEmitterFormat";const ve=({activeCampaignContent:e,isPreview:t})=>{if(!t)return null;const a="custom_campaign_format"===(null==e?void 0:e[".tag"])?e.custom_campaign_id:null;return G.default.createElement("p",null,"There is no component configured for custom campaign ID ",null!=a?a:"(empty)")};ve.displayName="NoMatchingCampaignFormat";const fe=({isPreview:e,error:t})=>e?G.default.createElement(G.default.Fragment,null,G.default.createElement("p",null,"The arguments to the custom campaign are not valid JSON."),G.default.createElement("p",null,"The error is: ",t.message)):null;fe.displayName="InvalidCampaignArgsFormat";const he=e=>{const{activeCampaignContent:t}=e;if("custom_campaign_format"!==(null==t?void 0:t[".tag"]))return G.default.createElement(ve,Object.assign({},e));let a={};if(t.args)try{a=JSON.parse(t.args)}catch(t){const a=Object.assign(Object.assign({},e),{error:t});return G.default.createElement(fe,Object.assign({},a))}const n=Object.assign(Object.assign({},e),{args:a});switch(t.custom_campaign_id){case"event_emitter":return G.default.createElement(_e,Object.assign({},n));case"onboarding_survey_modal":return G.default.createElement(me,Object.assign({},n));case"checkout_modal":return G.default.createElement(ue,Object.assign({},n));case"lmo_modal":return G.default.createElement(ge,Object.assign({},n));case"whats_new_modal":return G.default.createElement(de,Object.assign({},n));case"mid_trial_modal":return G.default.createElement(pe,Object.assign({},n));default:return G.default.createElement(ve,Object.assign({},n))}};he.displayName="CustomCampaignLoader";const Ee=e=>{var t,a;const n=e.currentSequenceStep;let i;if(n){const s=null===(a=null===(t=e.campaign.sequence)||void 0===t?void 0:t.nodes)||void 0===a?void 0:a[n];s&&(i=s.content)}else i=e.campaign.content;const s=Object.assign(Object.assign({},e),{activeCampaignContent:i}),o=null==i?void 0:i[".tag"];if(!o)return null;const r=`${e.campaign.campaign_id}-${n}`;switch(o){case"banner_campaign_format":return G.default.createElement(ee,Object.assign({key:r},s));case"custom_campaign_format":return G.default.createElement(he,Object.assign({key:r},s));case"menu_item_campaign_format":return G.default.createElement(te,Object.assign({key:r},s));case"snackbar_campaign_format":return G.default.createElement(ne,Object.assign({key:r},s));case"modal_campaign_format":return G.default.createElement(ae,Object.assign({key:r},s));case"tooltip_campaign_format":return G.default.createElement(ie,Object.assign({key:r},s));case"dialog_campaign_format":return G.default.createElement(se,Object.assign({key:r},s));case"link_campaign_format":return G.default.createElement(oe,Object.assign({key:r},s));case"link_bubble_campaign_format":return G.default.createElement(re,Object.assign({key:r},s));case"action_choice_modal_campaign_format":return G.default.createElement(ce,Object.assign({key:r},s));case"pulsar_campaign_format":return G.default.createElement(le,Object.assign({key:r},s));default:return null}},Ce=({slotId:e,wrapperClassName:t,initialState:a={campaignProps:void 0,contextData:void 0,filters:void 0,loggingParams:void 0}})=>{const[{campaignProps:i,contextData:o,filters:r,loggingParams:c},m]=n.useState(a),u=n.useMemo((()=>((e,t,a)=>{var n;if(!t)return!1;if(!(null==e?void 0:e.length))return!0;if(t.currentSequenceStep&&t.currentSequenceStep!==(null===(n=t.campaign.sequence)||void 0===n?void 0:n.root))return!0;const i={campaignProps:t,contextData:a};for(const a of e)if(!a.filterFunction(i))return l.logCampaignQualifyEvent(s.CampaignsToolkitEvents.CAMPAIGN_DISQUALIFY,t,a.campaignDisqualifiedReason),!1;return!0})(r,i,o)),[i,o,r]);if(n.useEffect((()=>{const t=({data:e}={data:{}})=>{m((t=>{const a=void 0===(null==e?void 0:e.campaign)?t.campaignProps:null==e?void 0:e.campaign,n=a===t.campaignProps?t.filters:function(e=-1){return Z[e]||[]}(null==a?void 0:a.campaign.campaign_id);return{campaignProps:a,contextData:void 0===(null==e?void 0:e.context)?t.contextData:null==e?void 0:e.context,filters:n,loggingParams:void 0===(null==e?void 0:e.loggingParams)?t.loggingParams:null==e?void 0:e.loggingParams}}))};return s.campaignsEmitter.on(e,t),()=>{s.campaignsEmitter.off(e,t)}}),[e]),n.useEffect((()=>{const e=()=>{m(a)};return s.campaignsEmitter.on(s.CLEAR_ALL_CAMPAIGNS,e),()=>{s.campaignsEmitter.off(s.CLEAR_ALL_CAMPAIGNS,e)}}),[a]),i&&u){const e=Object.assign(Object.assign({},i),{contextData:o,loggingParams:c});return t?G.default.createElement("div",{className:t},G.default.createElement(Ee,Object.assign({},e))):G.default.createElement(Ee,Object.assign({},e))}return null};Ce.displayName="CampaignSlot";const Se=()=>G.default.createElement(Ce,{slotId:"fullscreen_overlay"});class Pe{}const be={".tag":"prompt"},Oe={".tag":"toolkit"},we=be,Ae=[be,Oe];class Te{constructor(e){this.category="web-orchestration_client_events",this.user_id=null,this.session_id=null,this.action=null,this.action_value=null,this.extras={},["timestamp","user_id","session_id","is_success","queued_client","queued_time","started_time","finish_time","action","action_value","extras","orchestration_state"].map((t=>{e.hasOwnProperty(t)&&void 0!==e[t]&&(this[t]=e[t])})),Object.seal(this)}}class qe{constructor(e){this.hiveLogger=e||new s.HiveLogger}queuedClientToString(e){return"string"!=typeof e?e[".tag"]:e}logSuccessEvent(e,t){const a={timestamp:Date.now(),is_success:!0,queued_client:this.queuedClientToString(e.queuedClient),queued_time:e.enqueueTime,started_time:e.executionStartTime,finish_time:e.finishTime,extras:{},orchestration_state:JSON.stringify(t)};e.action&&(a.action=e.action),e.actionValue&&(a.action_value=e.actionValue.toString()),this.hiveLogger.log(new Te(a))}logErrorEvent(e,t,a){const n={};a&&(n.error_msg=a.message,o.reportException({err:a,tags:["enqueueFetch","campaigns","campaigns_orchestration"],severity:r.SEVERITY.NONCRITICAL,exc_extra:{queuedClient:this.queuedClientToString(e.queuedClient),enqueueTime:e.enqueueTime,startTime:e.executionStartTime,endTime:e.finishTime}}));const i={timestamp:Date.now(),is_success:!1,queued_client:this.queuedClientToString(e.queuedClient),queued_time:e.enqueueTime,started_time:e.executionStartTime,finish_time:e.finishTime,extras:n,orchestration_state:JSON.stringify(t)};e.action&&(i.action=e.action),e.actionValue&&(i.action_value=e.actionValue.toString()),this.hiveLogger.log(new Te(i))}logStateTransformEvent(e,t){const a=Date.now(),n={timestamp:a,is_success:!0,queued_client:e,queued_time:a,started_time:a,finish_time:a,extras:{},orchestration_state:JSON.stringify(t)};this.hiveLogger.log(new Te(n))}}class Ie extends Pe{constructor(e=!0,t){super(),this.isFirstCall=!0,this.queue=[],this.state={campaigns_shown:[]},this.campaignsShownStash=[],this.activePromise=void 0,this.inRollout=e,this.logger=t||new qe}getOrchestrationState(){return this.state}clearToolkitCampaignsFromState(){void 0!==this.state.campaigns_shown&&(this.state.campaigns_shown=this.getShownCampaignsByLoadMethod(be)),this.logger.logStateTransformEvent("clearToolkitCampaignsFromState",this.state)}stashPromptShownCampaigns(){void 0!==this.state.campaigns_shown&&this.campaignsShownStash.push(this.getShownCampaignsByLoadMethod(be)),this.state.campaigns_shown=this.getShownCampaignsByLoadMethod(Oe),this.logger.logStateTransformEvent("stashPromptShownCampaigns",this.state)}popStashedPromptShownCampaigns(){const e=this.campaignsShownStash.pop();void 0!==e&&(this.state.campaigns_shown=e),this.logger.logStateTransformEvent("popStashedPromptShownCampaigns",this.state)}getShownCampaignsByLoadMethod(e){return void 0!==this.state.campaigns_shown?this.state.campaigns_shown.filter((t=>t.load_method===e)):[]}registerShownCampaigns(e,t){var a;if(t===we&&"wait"===(null===(a=this.activePromise)||void 0===a?void 0:a.queuedClient)){const e=this.activePromise;e.parentResolve(),this.closePromise(e),this.logger.logSuccessEvent(e,this.state)}const n=e.filter((e=>{var t;return void 0===(null===(t=this.state.campaigns_shown)||void 0===t?void 0:t.find((t=>e.campaign_id===t.campaign_id)))}));this.state.campaigns_shown=[...n,...this.state.campaigns_shown?this.state.campaigns_shown:[]]}enqueueFetch(e,t,a,n=!0,i){var s;if(!this.inRollout)return t();if(!this.isValidLoadMethod(e))return Promise.reject(new Error(`Unsupported load method: ${e[".tag"]}`));if(e===we){if("wait"===(null===(s=this.activePromise)||void 0===s?void 0:s.queuedClient)){const n=this.activePromise;n.parentResolve();const s=new Promise(((n,s)=>{this.enqueueAtStart(e,t,n,s,i,a)}));return this.closePromise(n),this.logger.logSuccessEvent(n,this.state),s}}else n&&this.isFirstCall&&void 0!==we&&this.waitForPrioritizedClient();return this.isFirstCall=!1,new Promise(((n,s)=>{this.enqueue(e,t,n,s,i,a),this.dequeue()}))}buildPromiseMetadata(e,t,a,n,i,o=(()=>[])){const r={queuedClient:e,promiseBuilder:t,parentResolve:a,parentReject:n,conversionFunction:o,enqueueTime:Date.now(),action:null,actionValue:null};return(null==i?void 0:i.action)?(r.action=s.CAMPAIGN_EVENT,r.actionValue=i.action):(null==i?void 0:i.page)&&(r.action=s.PAGE_LOADED,r.actionValue=i.page),r}waitForPrioritizedClient(){return new Promise(((e,t)=>{this.enqueue("wait",(()=>new Promise(((e,t)=>{setTimeout(e,2e3)}))),e,t),this.dequeue()}))}enqueueAtStart(e,t,a,n,i,s=(()=>[])){const o=this.buildPromiseMetadata(e,t,a,n,i,s);this.queue.unshift(o)}enqueue(e,t,a,n,i,s=(()=>[])){const o=this.buildPromiseMetadata(e,t,a,n,i,s);this.queue.push(o)}dequeue(){if(void 0!==this.activePromise)return;const e=this.queue.shift();if(e){e.executionStartTime=Date.now(),this.activePromise=e;try{e.promiseBuilder(this.state).then((t=>{const a=e.conversionFunction(t);"string"!=typeof e.queuedClient&&this.registerShownCampaigns(a,e.queuedClient),e.parentResolve(t),this.closePromise(e),this.logger.logSuccessEvent(e,this.state)})).catch((t=>{e.parentReject(t),this.closePromise(e),this.logger.logErrorEvent(e,this.state,t)}))}catch(t){e.parentReject(t),this.closePromise(e),this.logger.logErrorEvent(e,this.state,t)}}}closePromise(e){var t;e.finishTime=Date.now(),(null===(t=this.activePromise)||void 0===t?void 0:t.queuedClient)===e.queuedClient&&(this.activePromise=void 0),this.dequeue()}isValidLoadMethod(e){return Ae.includes(e)}}class De{constructor(){}static getInstance(){return null==De.instance&&(De.instance=new Ie),De.instance}static resetInstance(){De.instance=new Ie}}const Le=e=>{for(const t of e)window.clearTimeout(t)},ye=(e,t)=>{const a=[];return e.forEach((e=>{var n,i,o;if(null===(n=null==e?void 0:e.campaign)||void 0===n?void 0:n.delay_in_seconds){l.logDelaySchedulingEvent(e,e.campaign.delay_in_seconds);const n=(i=()=>{s.emitCampaignToSlot(e,t)},o=1e3*e.campaign.delay_in_seconds,window.setTimeout(i,o));a.push(n)}else s.emitCampaignToSlot(e,t)})),a};Error;Error;c.CampaignFormats.BANNER;const Ne=e=>e.map((e=>{const t=e.campaign;return{campaign_id:t.campaign_id,version_id:t.version_id,slot:e.slotId[".tag"],load_method:Oe}})),je=(e={},t,n,c,l)=>a.__awaiter(void 0,void 0,void 0,(function*(){try{if(!e||!e.page)return[];const m=t=>a.__awaiter(void 0,void 0,void 0,(function*(){const a=[],{campaigns_result:l,campaigns_to_slots:m}=yield function(e){if(!e.campaign_properties||0===Object.keys(e.campaign_properties).length)throw new Error("campaign_properties cannot be empty");let t=new s.NoAuthApiV2Client;const a=s.getActiveUser();return void 0!==a&&(t=new s.DefaultUserApiV2Client(a)),t.ns("campaigns_toolkit").rpc("get_best_campaigns_for_user",e,{}).catch((t=>(o.reportException({err:t,tags:["fetchCampaigns","campaigns"],severity:r.SEVERITY.NONCRITICAL,exc_extra:{args:e}}),{campaigns:[],campaigns_to_slots:{}})))}({campaign_properties:e,event_context:{file_extension:(null==n?void 0:n.file_extension)&&n.file_extension,file_name:(null==n?void 0:n.file_name)&&n.file_name,upload_error_type:(null==n?void 0:n.upload_error_type)&&n.upload_error_type,file_path:(null==n?void 0:n.file_path)&&n.file_path,file_extensions_in_directory:(null==n?void 0:n.file_extensions_in_directory)&&n.file_extensions_in_directory,page_path:null==n?void 0:n.page_path,overwrote:null==n?void 0:n.overwrote,is_video_editing_eligible:null==n?void 0:n.is_video_editing_eligible,pathway:null==n?void 0:n.pathway},locale:i.getPageLocale(),load_method:c,orchestration_state:t});return null==l||l.campaigns.forEach((e=>{var t,n;a.push({campaign:e,requestId:null==l?void 0:l.request_id,slotId:null!==(t=null==m?void 0:m[e.version_id])&&void 0!==t?t:{".tag":"other"},currentSequenceStep:null===(n=e.sequence)||void 0===n?void 0:n.root})})),a}));return yield t.enqueueFetch(Oe,m,Ne,l,e)}catch(t){o.reportException({err:t,tags:["fetchCampaigns","campaigns"],severity:r.SEVERITY.NONCRITICAL,exc_extra:{args:e}})}return[]})),Re=e=>{const t={};return e.forEach((e=>{e.currentSequenceStep&&(t[e.campaign.campaign_id]=e.currentSequenceStep)})),t},xe=[c.CampaignEvents.DOWNLOAD_BUTTON_CLICKED,c.CampaignEvents.FILE_SHARE_SUCCESS,c.CampaignEvents.FILE_UPLOAD_FAILURE,c.CampaignEvents.SHARE_MODAL_CLOSED,c.CampaignEvents.PAGE_LOAD,c.CampaignEvents.FILE_UPLOAD_SUCCESS,c.CampaignEvents.DELETE_SUCCESS,c.CampaignEvents.SEGMENTATION_QUIZ_COMPLETE];t.CampaignsToolkit=({emitter:e=s.campaignsEmitter,loadMethod:t,shouldExpectPromptToLoad:i})=>{const[{campaigns:o,page:r,context:c,sequenceMap:u,selectiveCampaign:p,delayCampaignTimeouts:_,campaignsDisabled:v,isPreview:f},h]=n.useState({campaigns:[],page:"",context:void 0,sequenceMap:{},selectiveCampaign:void 0,delayCampaignTimeouts:[],campaignsDisabled:!1,isPreview:!1,lastSeenPreviewState:!1}),E=s.useInRouterContext()?s.useLocation():n.useMemo((()=>window.location),[]),C=E.pathname,S=E.search,P=De.getInstance();n.useEffect((()=>{var e;const t=new URLSearchParams(S),a=!!t.get("preview")||!1,n=null!==(e=t.get("_spec_campaign"))&&void 0!==e?e:void 0;h((e=>Object.assign(Object.assign({},e),{isPreview:a,selectiveCampaign:n})))}),[S,h]),n.useEffect((()=>{let e="";e=f?s.CampaignPageName.PREVIEW:((e,t=s.CampaignPathToPageNameTree)=>{const a=e.split("/").slice(1);let n=t,i="",o=-1;for(;n;){o++;const e=a[o];if("string"==typeof n){i=n;break}if(!e||!n[e]){if(n[""]&&!e){n=n[""];continue}if(n["*"]){n=n["*"];continue}break}n=n[e]}return i})(C),g.setPageName(e),h((t=>{let a=!!s.CampaignPagesWaitForLoadEvent[e],n={page_path:C};return t.page===e&&(a=t.campaignsDisabled,t.context&&(n=Object.assign(Object.assign({},t.context),{page_path:C}))),e===s.CampaignPageName.BROWSE&&s._internalEmitRequestBrowseRefreshEvent(),!t.lastSeenPreviewState&&f&&P.stashPromptShownCampaigns(),t.lastSeenPreviewState&&!f&&P.popStashedPromptShownCampaigns(),Object.assign(Object.assign({},t),{page:e,campaignsDisabled:a,context:n,lastSeenPreviewState:f})}))}),[C,f,P,h]),n.useEffect((()=>{const t=({data:{page:e,context:t},disableCampaigns:a})=>{h((n=>Object.assign(Object.assign({},n),{page:e,campaignsDisabled:a,context:t?Object.assign(Object.assign({},t),{page_path:C}):{page_path:C}}))),m.resetHistoryForEvent(s.PAGE_LOADED),g.setPageName(e)};return e.on(s.PAGE_LOADED,t),()=>{e.off(s.PAGE_LOADED,t)}}),[e,C]),n.useEffect((()=>{const t=e=>{var t;const a=[];for(const n of o){const i=null===(t=null==n?void 0:n.campaign)||void 0===t?void 0:t.campaign_id;i&&String(i)!==e?a.push(n):s.clearCampaignInSlot(n)}const n=d.cloneDeep(u);delete n[parseInt(e,10)],h((e=>Object.assign(Object.assign({},e),{campaigns:a,sequenceMap:n})))};return e.on(s.CAMPAIGN_DISMISSED,t),()=>{e.off(s.CAMPAIGN_DISMISSED,t)}}),[o,e,u]),n.useEffect((()=>{const t=({campaignId:e,ctaId:t})=>{var a,n,i;const r=parseInt(e,10),c=o.find((e=>e.campaign.campaign_id===r)),m=null==c?void 0:c.currentSequenceStep,g=null!==(n=null===(a=null==c?void 0:c.campaign.sequence)||void 0===a?void 0:a.nodes)&&void 0!==n?n:{},p={campaign:{campaign_id:r,version_id:-1,prompt_queried_at_ms:-1,campaign_name:"campaignWithOnlyCampaignId"},requestId:"",slotId:{".tag":"other"}};if(!m&&!(null==c?void 0:c.campaign.sequence))return void s.emitCampaignDismissed(e);if(!(c&&m&&t&&m in g))return l.logCampaignSequenceEvent(s.CampaignsToolkitSequenceEvents.MISSING_OR_INVALID_PARAMETERS,null!=c?c:p,m,t),void s.emitCampaignDismissed(e);const _=null===(i=g[m].children)||void 0===i?void 0:i[t];if(!_)return l.logCampaignSequenceEvent(s.CampaignsToolkitSequenceEvents.SEQUENCE_COMPLETED,c,m,t),void s.emitCampaignDismissed(e);const v=Object.assign(Object.assign({},c),{currentSequenceStep:_}),f=o.map((e=>e.campaign.campaign_id===r?v:e)),E=d.cloneDeep(u);E[r]=_,h((e=>Object.assign(Object.assign({},e),{campaigns:f,sequenceMap:E}))),l.logCampaignSequenceEvent(s.CampaignsToolkitSequenceEvents.PROGRESS_SEQUENCE,c,_,t),s.emitCampaignToSlot(v)};return e.on(s.CAMPAIGN_SEQUENCE_ACTION,t),()=>{e.off(s.CAMPAIGN_SEQUENCE_ACTION,t)}}),[o,u,e]);const b=n.useCallback(((e,n,s)=>a.__awaiter(void 0,void 0,void 0,(function*(){return je({page:e,action:s||void 0,selective_campaign:p||void 0,path:C},P,n,t,i)}))),[t,P,p,i,C]);n.useEffect((()=>{const t=({name:e,data:{context:t,loggingParams:n}={}})=>a.__awaiter(void 0,void 0,void 0,(function*(){if(!xe.includes(e))return;Le(_);const a=yield b(r,t,e),n=Re(a);h((e=>e.page!==r?e:Object.assign(Object.assign({},e),{campaigns:d.uniqBy([...e.campaigns,...a].reverse(),s.getSlotFromCampaignFormatProps),sequenceMap:Object.assign(Object.assign({},e.sequenceMap),n),delayCampaignTimeouts:ye(a,t)})))}));return e.on(s.CAMPAIGN_EVENT,t),()=>{e.off(s.CAMPAIGN_EVENT,t)}}),[r,b,_,e]);const[O,w]=n.useState({page:"",campaignsDisabled:!1});return n.useEffect((()=>{if(O.page===r&&O.campaignsDisabled===v)return;if(w({page:r,campaignsDisabled:v}),P.clearToolkitCampaignsFromState(),s.emitClearAllCampaignsFromSlots(),!r||v)return void h((e=>(Le(e.delayCampaignTimeouts),Object.assign(Object.assign({},d.omit(e,"context")),{campaigns:[],sequenceMap:{},delayCampaignTimeouts:[]}))));a.__awaiter(void 0,void 0,void 0,(function*(){const e=yield b(r,c),t=Re(e);h((a=>a.page!==r?a:(Le(a.delayCampaignTimeouts),Object.assign(Object.assign({},d.omit(a,"context")),{campaigns:e,sequenceMap:t,delayCampaignTimeouts:ye(e,c)}))))}))}),[r,v,c,P,b,O]),G.default.createElement(Se,null)},t.fetchCampaigns=je}));
//# sourceMappingURL=c_campaigns_campaigns_toolkit_client.js-vflov0vV6.map
