define(["exports","./c_tslib","./c_core_i18n","react","./e_file_viewer_edison_shmodel_file_async","./c_ui_image","./c_flows_utils_browse_logger","./c_capture_redux_store","./c_browse_tts","./c_flows_redux_reducer","./c_flows_redux_store","./c_flows_redux_actions","./c_workflow_builder_workflow_actions_action_ui_config","./c_flows_redux_selectors","./c_flows_utils_async_modal_launchers","./c_ui-icon_line_automation","react-dom"],(function(e,t,o,n,i,a,s,r,l,c,u,d,_,f,p,g,m){"use strict";function v(e){return e&&e.__esModule?e:{default:e}}function b(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(o){if("default"!==o){var n=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(t,o,n.get?n:{enumerable:!0,get:function(){return e[o]}})}})),t.default=e,Object.freeze(t)}var h=v(n),A=b(m);function k(e,t,o,n){const a={update_adoption_status_arg:{".tag":"update_automated_adoption_status_arg",conversion_type:e,folder_rule_action:t,do_not_show:n}};return(new i.UserApiV2Client).ns("flows").rpc("update_adoption_status",a,{subjectUserId:o})}const y={icon:g.AutomationLine,name:"automate_current_folder",text:o.intl.formatMessage({id:"/Z33r/",defaultMessage:"Yes, automate folder"}),onClick:O((function e(t){C();const{filePath:o,conversionArg:n,userId:a,ns_id:r}=t;if(!n)return;const{conversionType:l,folderRuleAction:_}=n;k(l,_,a,!1);const f=i.parent_dir(o),p=i.parentDirName(o);s.showPendingSnackbar({folderName:p,type:"add"});const g=u.getStoreForAutomations(),m=j(n);if(!m)return void s.showErrorSnackbar({folderName:p,onRetry:()=>{e(t)},type:"generic-add"});c.updateFolderRule({fqPath:f,actions:[{actionType:_,data:m}],enabled:!0,applyToExistingFiles:!1,trigger:c.DEFAULT_CLIENT_FOLDER_TRIGGER}).then((()=>{s.logAutoFolderEvent(i.WebUserActionLogEvent.CONFIRM_ADD_FOLDER_RULES,{user_id:a,file_nsid:r,extra:{rule_type:_,entry_point:"adoption_snackbar"}}),g.dispatch(d.addUserAutomation({actions:[{actionType:_,data:m}],inheritable:!1,fqPath:f,isEnabled:!0,nsId:r,trigger:c.DEFAULT_CLIENT_FOLDER_TRIGGER})),s.showSuccessSnackbar({folderName:p,shouldShowDashboardCta:!0,type:"add"})}),(o=>{var n;s.logAutoFolderEvent(i.WebUserActionLogEvent.CONFIRM_ADD_FOLDER_RULES,{user_id:a,file_nsid:r,extra:{rule_type:_,error:null===(n=o.error)||void 0===n?void 0:n[".tag"],entry_point:"adoption_snackbar"}}),s.showErrorSnackbar({folderName:p,onRetry:()=>{e(t)},type:"generic-add"})}))}),"automate_folder")},w={name:"show_me_how_to_automate",text:o.intl.formatMessage({id:"Y2ppp4",defaultMessage:"Show me"}),onClick:O(T,"show_me")},E={name:"do_not_show_me_this_again",text:o.intl.formatMessage({id:"g74H0b",defaultMessage:"Skip"}),onClick:O(S,"dont_show_again")};function O(e,t){return o=>{const{userId:n,conversionArg:a,ns_id:s}=o;if(!a)return;const{folderRuleAction:r,source:l}=a;i.logAutoFolderAdoptionSnackbar({user_id:n,action_source:"adoption",event_name:i.WebUserActionLogEvent.AUTOMATED_FOLDER_ADOPTION_SNACKBAR_CLICK,file_nsid:s,trigger_rule:r,snackbar_click_option:t,source:l}),e(o)}}function T({userId:e,filePath:t,ns_id:o,conversionArg:n}){if(!n)return;const{conversionType:a,folderRuleAction:s}=n,r=i.parent_dir(t),l=j(n);k(a,s,e,!1),p.asyncLaunchWorkflowBuilder({operation:"add",folderFqPath:r,surface:"browse",entryPoint:"adoption_snackbar",actionElement:"adoption_snackbar",initialActionType:s,initialActionData:l,initialScreen:"settings",initialTriggerType:"file_add"}),C()}function S({userId:e,conversionArg:t}){if(!t)return;const{conversionType:o,folderRuleAction:n}=t;k(o,n,e,!0),C()}function C(){i.Snackbar.close("flows-conversion-snackbar")}function j(e){const{folderRuleAction:t,fileType:o}=e,n=_.loadWorkflowActionUi(t),i=null==n?void 0:n.defaultAction.data;if(i)switch(t){case"image_conversion":case"video_conversion":i.format=o}return i}i.injectInternalStyle("/static/metaserver/static/js/flows/conversions/adoption.module.out-vflavgTy9.css",(e=>"._adoptionTooltipContainer_kztpv_1{background-color:var(--color__core__primary);bottom:0;height:210px;margin-bottom:150px;margin-right:50px;padding:15px 15px 10px;position:fixed;right:0;width:220px;z-index:1000}._additionalButton_kztpv_14{margin-left:var(--spacing__unit--2)}._tooltipCloseButton_kztpv_18{margin-right:var(--spacing__unit--1);margin-top:var(--spacing__unit--1);position:absolute;right:0;top:0}@media only screen and (max-width:640px){._adoptionTooltipContainer_kztpv_1{display:none}}"));const I="_adoptionTooltipContainer_kztpv_1",F="flows_adoption_tooltip";function x(){const e=document.getElementById(F);e&&e.remove()}const M=({outputExt:e,folderRuleAction:t,clickHandlerArgs:n})=>{const a="unzip"===t?o.intl.formatMessage({id:"7bOS9k",defaultMessage:"Automatically unzip compressed files"}):o.intl.formatMessage({id:"W0dLEK",defaultMessage:"Automatically convert files to {outputExt}s"},{outputExt:null==e?void 0:e.toUpperCase()}),s="unzip"===t?o.intl.formatMessage({id:"kLjQYK",defaultMessage:"Set up this folder to automatically unzip compressed files as they are added."}):o.intl.formatMessage({id:"r7sQQK",defaultMessage:"Set up this folder to automatically convert files to {outputExt}s as they are added."},{outputExt:null==e?void 0:e.toUpperCase()});return h.default.createElement(h.default.Fragment,null,h.default.createElement(i.Title,{size:"standard",inverse:!0},a),h.default.createElement(i.IconButton,{variant:"borderless",className:"_tooltipCloseButton_kztpv_18",inverse:!0,onClick:x},h.default.createElement(i.UIIcon,{src:i.CloseLine})),h.default.createElement(i.Text,{inverse:!0,size:"small",tagName:"p"},s),h.default.createElement(i.Button,{onClick:()=>{T(n),x()},variant:"outline",inverse:!0},o.intl.formatMessage({id:"vvt1hU",defaultMessage:"Yes, show me"})),h.default.createElement(i.Button,{className:"_additionalButton_kztpv_14",onClick:()=>{S(n),x()},variant:"transparent",inverse:!0},o.intl.formatMessage({id:"tEEvw9",defaultMessage:"Skip"})))};M.displayName="AdoptionTooltip";const U="flows-conversion-snackbar",R=268435456;function P(e){var o;return t.__awaiter(this,void 0,void 0,(function*(){const{file:t,user:n,shareToken:a,conversionFn:r,loggingFunctions:c,conversionType:d,folderRuleAction:_,getAdoptionSnackbarProps:p,source:g,template:m,outputExt:v,asyncThresholdBytes:b}=e;l.logBrowseTTS("workflows_save_as"),c.logConvert(g);const k=b||R;if(t.bytes>k&&m)return s.updateSnackbar({variant:"sync",title:"Loading"}),void(yield N(t,m,g,a));L(Object.assign(Object.assign({},e),{state:"saving"}));try{const s=yield r(t,n,a);if(s){const a=p?p(s):void 0;let r=!1;if(a&&_){const e=yield function(e,t,o){const n={check_adoption_status_arg:{".tag":"check_automation_adoption_status_arg",conversion_type:e,folder_rule_action:t}};return(new i.UserApiV2Client).ns("flows").rpc("check_adoption_status",n,{subjectUserId:o})}(d,_,n.id);r="show_automation_adoption_tooltips"===(null===(o=e.check_automation_adoption_status_result)||void 0===o?void 0:o[".tag"])&&e.check_automation_adoption_status_result.show_automation_adoption_tooltips.valueOf()}if(r&&"video-home"!==g){(function(){const e=u.getStoreForAutomations().getState(),t=f.getUserExperiments(e).find((e=>e.feature===i.UI_EXPERIMENTS.ADOPTION_UI_VARIANT));return"V3_TOOLTIP"===(null==t?void 0:t.variant)})()?(L(Object.assign(Object.assign({},e),{state:"success",resultPath:s})),function(e,t,o){if(!e&&"unzip"!==t||!t||!o)return;let n=document.getElementById(F);n&&n.remove(),n=document.createElement("div"),n.className=I,n.id=F,document.body.insertBefore(n,document.body.firstChild);const i=h.default.createElement(M,{outputExt:e,folderRuleAction:t,clickHandlerArgs:o});A.render(i,n)}(v,_,null==a?void 0:a.clickHandlerArgs)):(i.logAutoFolderAdoptionSnackbar({user_id:n.id,action_source:"adoption",event_name:i.WebUserActionLogEvent.AUTOMATED_FOLDER_ADOPTION_SNACKBAR_SHOW,file_nsid:t.ns_id,source:g,trigger_rule:_}),L(Object.assign(Object.assign({},e),{state:"successAutomatedAdoption",resultPath:s,adoptionSnackbarProps:a})))}else L(Object.assign(Object.assign({},e),{state:"success",resultPath:s}))}else L(Object.assign(Object.assign({},e),{state:"failGeneric"}));return s}catch(t){const o=i.getConversionStateFromException(t);return void L(Object.assign(Object.assign({},e),{state:o}))}}))}function L(e){const{user:t,getStrings:n,state:a,resultPath:s,loggingFunctions:r,adoptionSnackbarProps:l,source:c}=e,u=Object.assign(Object.assign({},n(s||"",{clickableFileName:!!l,loggingFunctions:r,source:c})),{open:o.intl.formatMessage({id:"+JIEsO",defaultMessage:"Open"}),close:o.intl.formatMessage({id:"In8b64",defaultMessage:"Close"}),retry:o.intl.formatMessage({id:"Y/tkCj",defaultMessage:"Try again"})}),d={closeButtonText:u.close,onCloseClick:()=>r.logConvertClose(c)},_={saving:{variant:"sync",syncProgressLoop:!0},failGeneric:Object.assign({variant:"fail"},d),failOverQuota:Object.assign({variant:"fail"},d),failTooLarge:Object.assign({variant:"fail"},d),failCorrupt:Object.assign({variant:"fail"},d),failPassword:Object.assign({variant:"fail"},d),failPasswordLink:Object.assign({variant:"fail"},d),failRetryable:Object.assign({variant:"fail",onActionClick:()=>{r.logConvertRetry(c),P(e)}},d),successAutomatedAdoption:Object.assign({variant:"complete",onActionClick:()=>D(t,s,r,c),richSnackbarProps:l},d),success:Object.assign({variant:"complete",actionButtonText:u.open,onActionClick:()=>D(t,s,r,c)},d)};i.Snackbar.update(h.default.createElement(i.Snackbar,Object.assign({id:U,title:u[a]},_[a])))}function D(e,t,o,n){o.logConvertOpen(n),i.replace_location(i.preview_uri_for_fq_path(e,t))}function N(e,o,n,a){return t.__awaiter(this,void 0,void 0,(function*(){const t=u.getStoreForAutomations();t.dispatch(d.setShouldSubscribeToBolt(!0));const s=_.mapConversionSourceToWorkflowEntrypoint(n),r=i.getFileIdentifier(e,a);let l;if(r&&r.identifier&&(l="shared_link_url"===r.identifier[".tag"]&&""!==r.identifier.shared_link_url?r.identifier.shared_link_url:void 0),i.isSharedFile(e)){t.dispatch(d.getWorkflowStepsConfig());const n=i.getActiveUser(),{submitFileWorkflow:a}=i.makeMetaserverFlowsClient(new i.DefaultUserApiV2Client(n));a({template:o,file_ids:[e.file_id],shared_link_url:l},60)}else try{yield c.submitFileWorkflow(o,[e.file_id],l),i.PapLogger.logSucceedSubmitManualWorkflow(s,o,1)}catch(e){i.PapLogger.logFailSubmitManualWorkflow(s,o,1,e)}}))}e.convertDocToImage=function(e,t,o,n){const a={file:t,format:o,dest_path:n};return(new i.UserApiV2Client).ns("flows").rpc("convert_doc_to_image",a,{subjectUserId:e})},e.convertFileAndShowSnackbar=P,e.convertImageFormat=function(e,t,o,n){const a={file:t,format:o,dest_path:n};return(new i.UserApiV2Client).ns("flows").rpc("convert_image_format",a,{subjectUserId:e})},e.convertSingleFileAsynchronously=N,e.convertToPdf=function(e,t,o){const n={file:t,dest_path:o};return(new i.UserApiV2Client).ns("flows").rpc("convert_to_pdf",n,{subjectUserId:e})},e.getAdoptionSnackbarProps=function(e){const{user:t,conversionType:n,folderRuleAction:a,resultPath:s,source:l,nsId:c}=e;if(!function(e){const t=!!r.isInsideFlowsEligibleFolder(r.getStoreForBrowse().getState()),o=null!=f.getUserAutomation(i.parent_dir(e))(u.getStoreForAutomations().getState());return t&&!o}(s))return;const d={user:t,conversionType:n,folderRuleAction:a,fileType:"unzip"===a?void 0:e.fileType,source:l},_={userId:t.id,filePath:s||"",ns_id:c,conversionArg:d},p="unzip"===a?o.intl.formatMessage({id:"+Ath7j",defaultMessage:"Want to automatically unzip files by setting up an automated folder?"}):o.intl.formatMessage({id:"+9Utp7",defaultMessage:"Want to automatically save {fileType} copies by setting up an automated folder?"},{fileType:e.fileType.toUpperCase()});return{actions:[y,w,E],helperText:p,clickHandlerArgs:_}},e.mediaRemux=function(e,t,o,n){const a={file:t,dest_path:n,container:o};return(new i.UserApiV2Client).ns("flows").rpc("media_remux",a,{subjectUserId:e})},e.unzip=function(e,t,o){const n={file:t,dest_path:o};return(new i.UserApiV2Client).ns("flows").rpc("unzip",n,{subjectUserId:e})}}));
//# sourceMappingURL=c_flows_conversions_convert.js-vfllHnOwm.map
