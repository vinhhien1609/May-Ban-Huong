define(["exports","./c_tslib","./e_file_viewer_edison_shmodel_file_async","./c_apex-metrics_src_types","./c_src_sink_index","./c_core_i18n","./c_capture_redux_store","metaserver/static/js/modules/constants/web_experience_constants","./e_edison","./c_core_notify","./c_lodash-es_lodash","react","./e_core_exception","./c_tagging_api","./c_tagging_logger","./c_sync_everything_redux_selectors","./c_shared_with_redux_store","./c_structured_tags_redux_action_creators","./c_core_exception_info"],(function(e,t,s,a,i,n,o,r,l,d,c,u,_,p,f,g,h,m,S){"use strict";class y extends a.Message{constructor(e){super(),this.actionSource="",a.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new y).fromBinary(e,t)}static fromJson(e,t){return(new y).fromJson(e,t)}static fromJsonString(e,t){return(new y).fromJsonString(e,t)}static equals(e,t){return a.proto3.util.equals(y,e,t)}}y.runtime=a.proto3,y.typeName="hql_events.WebBrowseSelectRow",y.fields=a.proto3.util.newFieldList((()=>[{no:1,name:"action_source",kind:"scalar",T:9},{no:2,name:"hql_metadata",kind:"message",T:s.HQLMetadata}]));const E="web_file_actions";function T(e){return{class:"folder_modal",action:"create",object:"folder_from_modal",properties:e}}const v=({user:e,name:a,destination:o,checkFsw:r,origin:l,surface:d})=>t.__awaiter(void 0,void 0,void 0,(function*(){const c=i.getMetricsReporter(),u={surface:d},_={latency:c.createTimer({ns:E,name:"create-folder/latency_ms"},u),completed:c.createStats({ns:E,name:"create-folder/completed"},u)};w(l),s.Snackbar.sync(n.intl.formatMessage(s.createFolderSnackbarProgress),!1,"browse-action");const p=yield s.createFolder(o,a,e,r);if(p.isError&&"path"===p.error[".tag"]&&"file_system_warnings"===p.error.path[".tag"]){s.Snackbar.close("browse-action");return(yield function(e){return t.__awaiter(this,void 0,void 0,(function*(){return new Promise((t=>{s.showFileSystemWarningsModal({fsws:e,onFinalAccept:()=>{t(!0)},onAbortAction:()=>{t(!1)},confirmText:n.intl.formatMessage(s.createFolderFswConfirmText)})}))}))}(p.error.path.details))?yield v({user:e,name:a,destination:o,checkFsw:!1,origin:l,surface:d}):(F(l),{type:"cancel"})}return _.latency.record(),p.isError?("path"===p.error[".tag"]&&"malformed_path"===p.error.path[".tag"]?(s.Snackbar.fail(n.intl.formatMessage(s.createFolderErrorMalformedPath),"browse-action"),_.completed.record(1)):(s.Snackbar.fail(n.intl.formatMessage(s.createFolderErrorGeneric),"browse-action"),_.completed.record(0)),function(e,t,a){s.logWebUserAction({event_name:s.WebUserActionLogEvent.CREATE_FOLDER_ERROR,extra:{error_summary:e||null,error:t||null,origin:a||null}}),s.UDCL.logEvent(T({eventState:"failed"}))}(p.error_summary,p.error[".tag"],l),{type:"error",summary:p.error_summary,error:p.error[".tag"]}):(s.Snackbar.complete(n.intl.formatMessage(s.createFolderSnackbarSuccess),"browse-action",void 0),A(l),_.completed.record(1),{type:"success",folder:p.result.metadata})}));function F(e){s.logWebUserAction({event_name:s.WebUserActionLogEvent.CREATE_FOLDER_CANCEL,extra:{origin:e||null}}),s.UDCL.logEvent(T({eventState:"canceled"}))}function w(e){s.logWebUserAction({event_name:s.WebUserActionLogEvent.CREATE_FOLDER_PENDING,extra:{origin:e||null}}),s.UDCL.logEvent({class:"navigation",action:"select",object:"create_folder_action",properties:{contentAction:"create_folder_pending",actionSurface:"browse_screen"}})}function A(e){s.logWebUserAction({event_name:s.WebUserActionLogEvent.CREATE_FOLDER_SUCCESS,extra:{origin:e||null}}),s.UserSurvey.trackEvent("create_item","browse"),s.UDCL.logEvent(T({eventState:"success"}))}n.intl.formatMessage({id:"A5Lqjf",defaultMessage:"Add a few details about this folder here."}),n.intl.formatMessage({id:"ssdefa",defaultMessage:"Can’t save changes. Paste text elsewhere to save, then click Refresh."}),n.intl.formatMessage({id:"5dt0hu",defaultMessage:"Can’t save changes. Reload the page and try again."}),n.intl.formatMessage({id:"PM6K+P",defaultMessage:"Can’t save changes."}),n.intl.formatMessage({id:"9C/lc5",defaultMessage:"Can’t @mention someone in your Personal Dropbox."}),n.intl.formatMessage({id:"+dhj1b",defaultMessage:"Can’t @mention someone in your member folder."}),n.intl.formatMessage({id:"b7//2e",defaultMessage:"You don’t have permission to share this folder."}),s.defineMessage({id:"mjXnuX",defaultMessage:"Pinned to {folderName}"}),s.defineMessage({id:"A1Fokf",defaultMessage:"Unpinned from {folderName}"}),s.defineMessage({id:"Ww9LPX",defaultMessage:"Close"}),s.defineMessage({id:"8msMyU",defaultMessage:"Show"});n.intl.formatMessage({id:"HRXOjw",defaultMessage:"opt"}),n.intl.formatMessage({id:"RIxWSs",defaultMessage:"alt"}),n.intl.formatMessage({id:"FL9yea",defaultMessage:"ctrl"}),n.intl.formatMessage({id:"NWv/3R",defaultMessage:"⌘"}),n.intl.formatMessage({id:"Kud10T",defaultMessage:"Everyone in this folder can see notes, tasks, and pinned items"}),s.defineMessage({id:"xkXFjI",defaultMessage:"Hi {user_name}, I @mentioned you in this folder. Take a look."}),s.defineMessage({id:"YzaJIx",defaultMessage:"Hi {user_name}, I @mentioned you in the {folder_name} folder. Take a look."}),n.intl.formatMessage({id:"sl5Fj7",defaultMessage:"I @mentioned you in this folder. Take a look."}),s.defineMessage({id:"erm7J0",defaultMessage:"I @mentioned you in the {folder_name} folder. Take a look."}),s.defineMessage({id:"kh62rs",defaultMessage:"Pin “{name}” to..."}),s.defineMessage({id:"oU0z79",defaultMessage:"Pin {num} items to..."}),s.defineMessage({id:"BGyZpk",defaultMessage:"You do not have permission to pin to {path}"}),s.defineMessage({id:"UD2+LM",defaultMessage:"Can't pin files or folders to a read-only folder"}),s.defineMessage({id:"PX5Hq1",defaultMessage:"Deleted {time_ago} by you"}),s.defineMessage({id:"7V5b6j",defaultMessage:"Deleted {time_ago} by {name}"}),s.defineMessage({id:"oA46AW",defaultMessage:"Updated {time_ago} by you"}),s.defineMessage({id:"MP7zas",defaultMessage:"Updated {time_ago} by {name}"}),s.defineMessage({id:"PHRYz8",defaultMessage:"Your changes weren’t saved because you and {user} are editing at the same time."}),n.intl.formatMessage({id:"tc/4YZ",defaultMessage:"Your changes weren’t saved because you are editing this description elsewhere."}),n.intl.formatMessage({id:"4aEgv5",defaultMessage:"Please wait until they’re done before making changes."}),n.intl.formatMessage({id:"oYSO1Z",defaultMessage:"Please save your other changes before making them here."}),n.intl.formatMessage({id:"nOO9Qi",defaultMessage:"OK"});const M=[],b=e=>s.getStateAtNamespace(e,s.FOLDER_OVERVIEW_NAMESPACE_KEY)||s.defaultFolderOverviewState,C=(e,t)=>(e=>b(e).fileIdCache)(e)[s.normalizePath(t.path)],L=(e,t)=>(e=>b(e).componentDataCache)(e)[t.componentNamespace],O=(e,t)=>{const s=C(e,t);return(e=>b(e).folderDataCache)(e)[s]};s.createSelector(O,(e=>e?e.descriptionFormatVersion:void 0));const I=s.createSelector(O,(e=>{if(e&&e.description)try{return JSON.parse(e.description)}catch(e){return}})),N=s.createSelector(O,(e=>{if(void 0!==e&&void 0!==e.contentReferences)return 0===e.contentReferences.length?M:s.convertContentReferencesToSortedFiles(e.contentReferences)}));s.createSelector(I,s.isEmptyDescription);s.createSelector((e=>e.BROWSE&&e.BROWSE.user||s.mkUser(e.SEARCH.user)),s.convertDbxUserToIUser);s.createSelector(L,(e=>!(!e||0===e.requiredComponents.length)&&0===e.requiredComponents.filter((t=>!e.loadedComponents.includes(t))).length)),s.createSelector(L,(e=>!!e&&e.hasFailedToLoad)),s.createSelector(C,(e=>e)),s.createSelector(O,(e=>e?e.loggingFileId:void 0)),s.createSelector(N,(e=>e));const P=e=>o.browseLoadingState(e)===s.LoadingState.LOADED?o.sortedFiles(e).count():o.getBrowseState(e).paginatedTotalNumFiles;s.createSelector(o.context,P,((e,t)=>e.isInsideVaultFolder&&null!=e.currentNSPath&&s.paths_are_equal(e.currentNSPath,"")&&0===t)),s.createSelector(o.context,P,o.experiments,((e,t,a)=>e.isInFamilySharedFolder&&null!=e.currentNSPath&&s.paths_are_equal(e.currentNSPath,"")&&0===t));const R=(e,a,i,n,o)=>t.__awaiter(void 0,void 0,void 0,(function*(){const t=s.previewThumbnailsToLoad(a()),r=s.selectViewType(a(),{instanceId:o});try{if(t.length>0){const a=new s.UserApiV2Client,o=yield a.ns("previews").rpc("get_preview_data_batch",{files:t},{subjectUserId:i}),d=[];o.results.forEach((e=>{var t;const s=null===(t=e.preview)||void 0===t?void 0:t.content,a=e.file.file_id;a&&s&&(s.hasOwnProperty("thumbnail_url_tmpl")?d.push({file_id:a,preview_url:s.thumbnail_url_tmpl}):s.hasOwnProperty("placeholder_image_url")&&d.push({file_id:a,preview_url:s.placeholder_image_url}))})),d.length>0&&(e((({preview_thumbnails:e})=>({type:s.ActionTypes$1.PREVIEW_THUMBNAILS_LOADED,payload:{preview_thumbnails:e}}))({preview_thumbnails:d})),l={view_type:r,userId:i,num_files_requested:t.length,num_files_retrieved:d.length,elapsed_ms:Date.now()-n},s.logWebUserAction({user_id:l.userId,event_name:s.WebUserActionLogEvent.PREVIEW_THUMBNAIL_SUCCESS,extra:{view_type:l.view_type,num_files_requested:l.num_files_requested.toString(),num_files_retrieved:l.num_files_retrieved.toString(),elapsed_ms:l.elapsed_ms.toString()}}))}}catch(a){e((({files:e})=>({type:s.ActionTypes$1.PREVIEW_THUMBNAILS_REMOVED,payload:{files:e}}))({files:t})),(e=>{s.logWebUserAction({user_id:e.userId,event_name:s.WebUserActionLogEvent.PREVIEW_THUMBNAIL_ERROR,extra:{view_type:e.view_type,error_summary:e.error_summary||"unknown"}})})({view_type:r,userId:i,error_summary:null==a?void 0:a.toString()})}var l})),U=c.debounce(((e,t,s,a,i)=>{R(e,t,s,a,i)}),300),x=(e,t,a)=>(i,n)=>{const o=s.previewThumbnails(n()),r=e.filter((e=>e.file_id&&!o.hasOwnProperty(e.file_id)));r.length>0&&(i((({files:e})=>({type:s.ActionTypes$1.PREVIEW_THUMBNAILS_LOADING,payload:{files:e}}))({files:r})),U(i,n,t,Date.now(),a))};new s.UserApiV2Client;s.UserApiV2Client;class D extends i.EventEmitter{constructor(){super(),this.setUpdateChannelForType=(e,t)=>{this.signedChannelStates[e]=new s.SignedChannelState(t.appId,t.uniqueId,t.revision,t.token),this.boltClient.update_states(c.values(this.signedChannelStates)),this.boltClient.start()},this.handleUpdate=e=>{const t=[];e.forEach((e=>{const s=c.findKey(this.signedChannelStates,{app_id:e.app_id,unique_id:e.unique_id});s&&!t.includes(s)&&(this.emit("update",{type:s}),t.push(s))}))},this.handleRefresh=()=>{this.boltClient.update_states(c.values(this.signedChannelStates))},this.boltClient=new s.MetaserverBoltClient([],this.handleUpdate,this.handleRefresh),this.signedChannelStates={}}stop(){this.boltClient.unsubscribe()}}new D,new s.HiveLogger;const k=()=>({}),q=function({user:e,files:t,override:a=!1,onSuccess:i}){return(n,o)=>{0!==t.length&&p.tagsApiClient.getTags(e,t).then((e=>{n((({fileToTags:e,override:t})=>({type:s.ActionTypes$2.SET_FILE_TO_TAGS_MAP,payload:{fileToTags:e,override:t}}))({fileToTags:e,override:a})),null==i||i()}))}};function W(e){return{class:"navigation",action:"select",object:"content_tile",properties:e}}const B=h.getStoreForSharedWith(),V=({fqPathsToSelect:e})=>({type:s.ActionTypes.SELECT_FILES_BY_FQ_PATH,payload:{fqPathsToSelect:e}}),j=({filePathsToSelectOnNextUpdate:e})=>({type:s.ActionTypes.SET_FILE_PATHS_TO_SELECT_ON_NEXT_UPDATE,payload:{filePathsToSelectOnNextUpdate:e}}),z=({newFolderCreationState:e})=>({type:s.ActionTypes.SET_NEW_FOLDER_CREATION_STATE,payload:{newFolderCreationState:e}}),H=({actionSource:e,skipLogging:t}={})=>(({selection:e,actionSource:t,skipLogging:a})=>(i,n)=>{var l;if(!a){const a=n(),i=o.selection(a),{event:d,itemId:c}=s.makeSelectionEvent(i,e),u=o.selectFileByFullPath(a,{path:c}),_=s.selectViewType(n(),{instanceId:s.BROWSE_FILES_VIEW_ID});if("ON"===r.CONTENT_TILES&&(_===s.ViewType.Grid||_===s.ViewType.LargeGrid)){const n=o.selectFilesByFullPaths(a,{paths:e.selected,excludeNoAccessSharedFolders:!0}),r=(e=s.createSelection(n.map((e=>e.fq_path)),null!==(l=e.anchor)&&void 0!==l?l:"")).selected.filter((e=>!i.selected.contains(e))),d=i.selected.filter((t=>!e.selected.contains(t))),c={actionElement:s.ActionSurfaceLogValue.CONTENT_TILE,actionSource:t};r.size>0&&s.logEvent(W(Object.assign(Object.assign({},c),{selectType:"select"}))),d.size>0&&s.logEvent(W(Object.assign(Object.assign({},c),{selectType:"deselect"})))}if(u){const{num_files_selected:i,num_folders_selected:n}=s.countFilesAndFolders(o.selectFilesForSelection(a,{selection:e}));if(d===s.WebUserActionLogEvent.SELECT_ROW){let e="";_===s.ViewType.Grid||_===s.ViewType.LargeGrid||_===s.ViewType.SmallGrid?e="content_tile":(_===s.ViewType.List||s.ViewType.CondensedList)&&(e="file_row"),s.UDCL.logEvent({class:"browse",action:"select",object:"item",properties:{actionElement:e,viewType:_}}),s.logEvent$2(new y({actionSource:t}))}s.logBrowseAction({uid:o.user(a).id,action:d,action_source:t,num_files_selected:i,num_folders_selected:n,view_type:_,result:u,extra:{entity_type:u.is_dir?"folder":"file"}})}}i({type:s.ActionTypes.SET_SELECTION,payload:{selection:e,actionSource:t}}),X(i,n,e)})({actionSource:e,skipLogging:t,selection:s.createSelection()}),G=({unsortedFiles:e})=>(a,i)=>t.__awaiter(void 0,void 0,void 0,(function*(){const t=o.user(i());a(Y({unsortedFiles:e})),s.initializeStore(t,e.toArray())})),Y=({unsortedFiles:e})=>({type:s.ActionTypes.SET_UNSORTED_FILES,payload:{unsortedFiles:e}}),X=(e,t,a)=>{if(!a||0===a.selected.count())return;const i=o.unsortedFiles(t()),n=null==i?void 0:i.filter((e=>a.selected.has(e.fq_path)&&!e.thumbnail_url_tmpl)),r=[];if(null==n||n.forEach((e=>{r.push({file_id:e.file_id,sj_id:e.sjid,ns_id:e.ns_id})})),r.length>0){const a=o.user(t()).id;e(x(r,a,s.BROWSE_FILES_VIEW_ID))}},J=e=>(t,a)=>{const i=o.user(a());t({type:s.ActionTypes.SET_RIGHTRAIL_IS_COLLAPSED,payload:{collapsed:e}}),o.setIsCollapsed(i.id,e)},Z=e=>({type:s.ActionTypes.SET_EXPANDED_BLADE,payload:{expandedBlade:e}});e.FILE_ACTIONS_AMP_NAMESPACE=E,e.appendFiles=({path:e,files:t,currentFolderInfo:a})=>(i,n)=>{if(!s.paths_are_equal(e,o.path(n())))return;if(o.selectedFilter(n())!==s.BrowseFilterType.NONE)return;const r=o.unsortedFiles(n()),l=r.size;let d=l;t.forEach((e=>{r.has(e.fq_path)||d++}));const c=r.merge(s.immutableExports.Map(t.map((e=>[e.fq_path,e]))));G({unsortedFiles:c})(i,n,k),(({unsortedFiles:e})=>(t,a)=>{const i=o.filePathsToSelectOnNextUpdate(a()).toArray().map((e=>e.toLowerCase())),n=e.toArray().filter((e=>i.includes(e.fq_path.toLowerCase()))).map((e=>e.fq_path.toLowerCase())),r=i.filter((e=>!n.includes(e.toLowerCase())));0!==n.length&&(t(V({fqPathsToSelect:n})),t(j({filePathsToSelectOnNextUpdate:s.immutableExports.Set(r)})))})({unsortedFiles:c})(i,n,k),o.isFetchTagsOnBrowseEnabled(o.manualTaggingVariant(n()))&&(a=null!=a?a:o.getCurrentFolderInfo(n()),i(q({user:o.user(n()),files:a?[...t,a]:[...t],override:0===l}))),o.user(n()).is_team&&"ON"===o.structuredTaggingVariant(n())&&i(m.fetchStructuredTagsForFiles({files:a?[...t,a]:[...t]})),B.dispatch(h.pathLoaded({path:e})),c.size!==d&&_.reportException({err:new Error("appendFiles ended up with unexpected number of files."),tags:["browse_file_collections_mismatch"],severity:S.SEVERITY.NONCRITICAL,exc_extra:{previous_unsorted_files_size:l,incoming_files_size:t.length,expected_files_size:d,updated_unsorted_files_size:c.size,is_deleted_files_on:o.shouldShowDeletedFiles(n())}})},e.batchContentType=function(e){return e.every((e=>e.is_dir))?"folders":e.every((e=>!e.is_dir))?"files":"mixed"},e.bucketForBatchSize=function(e){return 1===e?"single":e<=10?"small":e<=100?"medium":e<=1e3?"large":"massive"},e.completeFolderSizes=({fetchFolderSizeState:e})=>({type:s.ActionTypes.COMPLETE_FOLDER_SIZES,payload:{fetchFolderSizeState:e}}),e.createFolder=({pathName:e,folderName:a,user:i,checkFSWs:n,showShareModalOnSuccess:r,redirectOnSuccess:l,redirectOnCancel:d,selectCreatedFolder:c=!0,origin:u})=>(_,p)=>t.__awaiter(void 0,void 0,void 0,(function*(){_(z({newFolderCreationState:s.NewFolderCreationState.SAVING_INPUT}));const t=yield v({destination:e,name:a,user:i,checkFsw:n,origin:u,surface:"browse"});if("success"===t.type){const e=(f=t.folder,new s.File({file_id:f.id,fq_path:f.path_display||"",icon:f.icon,is_dir:!0,ns_path:""})),a=o.unsortedFiles(p()).set(e.fq_path,e);_(Y({unsortedFiles:a})),c&&_(V({fqPathsToSelect:[e.fq_path]})),l&&l(e.fq_path),r&&r(e,s.SHARE_ACTION_ORIGIN_TYPE.BROWSE_NEW_FOLDER_MODAL)}else d&&d();var f;_(z({newFolderCreationState:s.NewFolderCreationState.CREATE_FOLDER_INACTIVE}))})),e.fetchAllTagsSuggestions=function({user:e,onSuccess:t}){return(a,i)=>{void 0===s.selectAllTagsSuggestions(i())&&p.tagsApiClient.getAllTags(e).then((e=>{a((({tags:e})=>({type:s.ActionTypes$2.SET_ALL_TAGS,payload:{tags:e}}))({tags:e})),null==t||t()}))}},e.fileFromMetadata=(e,t)=>{if("file"===t[".tag"]){const a=t,i=Object.assign(Object.assign({},e),{fq_path:a.path_display||e.fq_path,icon:a.icon+"_32",revision_id:a.rev,file_id:a.id});return new s.File(i)}return"folder"===t[".tag"]?new s.File(Object.assign(Object.assign({},e),{fq_path:t.path_display||e.fq_path})):e},e.logCreateFolderCancel=F,e.logCreateFolderPending=w,e.logCreateFolderSuccess=A,e.popBoltIgnore=e=>({type:s.ActionTypes.POP_BOLT_IGNORE,payload:e}),e.pushBoltIgnore=e=>({type:s.ActionTypes.PUSH_BOLT_IGNORE,payload:e}),e.recordPathLookupErrors=function(e,t,s){const a={};e.forEach((e=>{if("path_lookup"===e.failure[".tag"]){const t=e.failure.path_lookup[".tag"];a[t]=(a[t]||0)+1}}));for(const e in a)a.hasOwnProperty(e)&&i.getMetricsReporter().createStats({ns:E,name:"common/failure/path_lookup"},Object.assign(Object.assign({},s),{lookupFailureType:e,operation:t})).record(a[e])},e.requestFolderSizes=({fqPath:e})=>({type:s.ActionTypes.REQUEST_FOLDER_SIZES,payload:{fqPath:e}}),e.selectFilesByFqPath=V,e.setFilePathsToSelectOnNextUpdate=j,e.setFolderSizesPending=({fetchFolderSizesResp:e})=>({type:s.ActionTypes.SET_FOLDER_SIZES_PENDING,payload:{fetchFolderSizesResp:e}}),e.setLoadingState=({loadingState:e,path:t})=>({type:s.ActionTypes.SET_LOADING_STATE,payload:{loadingState:e,path:t}}),e.setNewFolderCreationState=z,e.setPaginatedTotalNumFiles=({paginatedTotalNumFiles:e})=>({type:s.ActionTypes.SET_PAGINATED_TOTAL_NUM_FILES,payload:{paginatedTotalNumFiles:e}}),e.setUnsortedFiles=G,e.setUrl=({path:e="",qargs:t,expandedBlade:a="info",forceExpandRightRail:i=!1})=>(n,r)=>{s.DBHistory.push_state(o.urlPrefix(r())+l.URI.encode_parts(e),c.omitBy(Object.assign(Object.assign({},c.pick(s.getQueryArgs(),["d"])),t),c.isUndefined)),n(H({skipLogging:!0})),n(Z(a)),i&&n(J(!1))},e.showRewind=()=>({type:s.ActionTypes.SHOW_TIMELINE,payload:{timestamp:(new Date).getTime()}})}));
//# sourceMappingURL=c_data_action_creators_index.js-vflJNxO-5.map
