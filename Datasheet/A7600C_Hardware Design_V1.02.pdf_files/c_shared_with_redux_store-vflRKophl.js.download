define(["exports","./e_file_viewer_edison_shmodel_file_async","./c_tslib","./c_capture_redux_store","./c_sharing_avatar_info"],(function(e,a,t,r,s){"use strict";const i={sharedFolderDataByTargetNamespaceId:{},hasSharedDataLoadedByParentPath:{},sharedLinkExistsByFileIdOrPath:{},sharedFileDataByFileId:{},integrationData:void 0},n=(e,t,r)=>{return s="/share_ajax/shared_with",i={max_results:r,fq_path_prefix:t,include_inherited:!0,sort_by_name:!0},n=!1,d=e,o=!0,new Promise(((e,t)=>{(n?a.SilentBackgroundRequest$1:a.WebRequest)({url:s,type:"POST",dataType:"json",data:i,subject_user:d,skipNotifyError:o,success:e,error:(e,a,r)=>t(Error(`error: ${r}, status: ${a}`))})}));var s,i,n,d,o};function d(e,a){return["share_ajax:shared_with",e,a.toString()]}const o=e=>r.user(e),l=e=>a=>{a(E.setHasSharedDataLoaded({path:e,isLoaded:!1})),a(_({parentPath:e,abortCurrentRequest:!0}))};let h=null;const _=({parentPath:e,abortCurrentRequest:a=!1})=>(t,s)=>{const i=s();a&&h&&h.abort(),r.isInsideBackupFolder(i)?t(u({parentPath:e})):t(c({parentPath:e}))},u=({parentPath:e})=>(t,s)=>{const i=s(),n=o(i),d=r.mountPoints(i),l={};d&&d.forEach(((e,t)=>l[t]={memberCount:1,joinedMembers:[Object.assign(Object.assign({},n),{access_type:"owner",user_id:n.id,photo_url:n.photo_url,initials:a.getInitials(n.display_name)})]})),t(E.setNamespaceSharedWithData({parentPath:e,sharedFolderData:l}))},c=a.createAsyncThunk(`${a.BROWSE_SHARED_WITH_NAMESPACE_KEY}/fetchSharedWithData`,(({parentPath:e},{getState:r})=>t.__awaiter(void 0,void 0,void 0,(function*(){const s=r(),i=o(s);return yield a.queryClient.fetchQuery(d(e,5),(()=>t.__awaiter(void 0,void 0,void 0,(function*(){return yield n(i,e,5).then((a=>{const t=(e=>{const a={};for(const t of e)a[t.ns_id]={numUndisplayableUsersAndInvites:t.num_avatars_not_shown,groups:t.groups,invitations:t.invitations,joinedMembers:t.joined_members,audienceDescription:t.audience_description,memberCount:t.num_users_and_invites,accessTextData:{total_groups_and_users:t.total_groups_and_users,total_unique_inherited_members:t.total_unique_inherited_members,total_unique_users:t.total_unique_users,users_outside_team:t.users_outside_team,is_confidential:t.is_confidential,isParentTmr:t.is_parent_tmr,is_parent_tsd:t.is_parent_tsd,is_parent_namespace:t.is_parent_namespace,has_team_group:t.has_team_group,has_group:t.has_group}};return a})(a);return{sharedFolderData:t,parentPath:e}})).finally((()=>h=null))}))))})))),p=()=>e=>{e(E.clearSharedFileDataByFileId(null)),e(S())},S=()=>(e,t)=>{const s=t(),n=(e=>a.getStateAtNamespace(e,a.BROWSE_SHARED_WITH_NAMESPACE_KEY)||i)(s),d=r.sortedFiles(s).reduce(((e,a)=>((e=>!(e.is_dir||e.isDeleted))(a)&&!(a.file_id in n.sharedFileDataByFileId)&&e.push(a.file_id),e)),[]);e(m(d))},m=a.createAsyncThunk(`${a.BROWSE_SHARED_WITH_NAMESPACE_KEY}/fetchSharedFileDataForFiles`,((e,{getState:r,dispatch:i,rejectWithValue:n})=>t.__awaiter(void 0,void 0,void 0,(function*(){const t=r(),d=o(t);if(!d.is_email_verified)return n("User's email is not verified.");const l=e.slice(0,100),h=e.slice(100);return yield((e,t,r)=>new a.FileShareApiClient({userId:r.id}).listMembersBatch({contentIds:e,limit:t}))(l,5,d).then((e=>{const a={};return e.forEach(((e,t)=>{a[t]={numUndisplayableUsersAndInvites:0,groups:e.groups.valueSeq().map(s.apiGroupMemberToAvatarInfo).toArray(),invitations:e.invitees.valueSeq().map(s.apiInviteeMemberToAvatarInfo).toArray(),joinedMembers:e.users.valueSeq().map(s.apiUserMemberToAvatarInfo).toArray()}})),(null==h?void 0:h.length)&&i(m(h)),{sharedFileData:a}}))})))),y=a.createAsyncThunk(`${a.BROWSE_SHARED_WITH_NAMESPACE_KEY}/fetchSharedLinkExists`,((e,{getState:s})=>t.__awaiter(void 0,void 0,void 0,(function*(){const t=s(),i=r.user(t);return yield((e,t)=>new a.FileShareApiClient({userId:t.id}).sharedLinkInfo({fileIdOrPath:e}))(e,i).then((a=>({fileIdOrPath:e,sharedLinkExists:(null==a?void 0:a.length)>0})))})))),f=a.createSlice({name:a.BROWSE_SHARED_WITH_NAMESPACE_KEY,initialState:i,reducers:{clear:(e,a)=>i,clearSharedFileDataByFileId:(e,a)=>{e.sharedFileDataByFileId={}},clearSharedLinkExistsCache:(e,a)=>{e.sharedLinkExistsByFileIdOrPath={}},setHasSharedDataLoaded:(e,a)=>{const{payload:t}=a;e.hasSharedDataLoadedByParentPath[t.parentPath]=t.isLoaded},setNamespaceSharedWithData:(e,a)=>{const{payload:t}=a;e.hasSharedDataLoadedByParentPath[t.parentPath]=!0,e.sharedFolderDataByTargetNamespaceId=t.sharedFolderData}},extraReducers:e=>{e.addCase(c.fulfilled,((e,{payload:a})=>{const t=Object.assign({},e.hasSharedDataLoadedByParentPath);return t[a.parentPath]=!0,Object.assign(Object.assign({},e),{hasSharedDataLoadedByParentPath:t,sharedFolderDataByTargetNamespaceId:a.sharedFolderData})})).addCase(m.fulfilled,((e,{payload:a})=>Object.assign(Object.assign({},e),{sharedFileDataByFileId:Object.assign(Object.assign({},e.sharedFileDataByFileId),a.sharedFileData)}))).addCase(y.fulfilled,((e,a)=>{e.sharedLinkExistsByFileIdOrPath[a.payload.fileIdOrPath]=a.payload.sharedLinkExists}))}}),{reducer:D}=f,E=f.actions;let P;e.getStoreForSharedWith=()=>(P||(P=a.getStoreAndRegisterReducers({[a.BROWSE_SHARED_WITH_NAMESPACE_KEY]:D})),r.getStoreForBrowse(),P),e.pathLoaded=({path:e})=>a=>{a(y(e)),a(l(e)),a(p())},e.sharedFileDataOutOfDate=e=>a=>{a(m(e))},e.sharedFolderDataOutOfDate=e=>(t,s)=>{if(!e){const a=s();e=r.path(a)}a.queryClient.invalidateQueries(d(e,5)),t(_({parentPath:e}))},e.sharedLinkDataOutOfDate=e=>a=>{e&&a(y(e))}}));
//# sourceMappingURL=c_shared_with_redux_store.js-vfl-HiXpD.map
