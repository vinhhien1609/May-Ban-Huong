define(["require","exports","./c_tslib","./c_src_sink_index","./c_apex-metrics_src_types","./e_file_viewer_edison_shmodel_file_async","./e_core_exception","./e_edison"],(function(e,o,t,r,i,n,d,c){"use strict";function s(e){const o=(new n.UserApiV2Client).ns("cloud_docs");let t;e.hasOwnProperty("docPathOrId")&&e.docPathOrId&&(t={".tag":"path_or_id",path_or_id:e.docPathOrId});const r=e.data&&e.data.webOpenId,i=e.data&&e.data.origDest,d=e.data&&e.data.routingDest;o.rpc("log_user_action",{action:e.actionEvent,doc_id:t,source:e.actionSource,open_id:r,orig_dest:i,routing_dest:d,extra_info:e.extra},{subjectUserId:e.userId})}let l;const _=[{id:"word",icon:"word",name:"Word for the web",exts:["odt","docm","docx"],sizeLimitBytes:104857600,editor:n.MicrosoftEditors.WORD},{id:"excel",icon:"excel",name:"Excel for the web",exts:["ods","xlsb","xlsm","xlsx"],sizeLimitBytes:104857600,editor:n.MicrosoftEditors.EXCEL},{id:"powerpoint",icon:"powerpoint",name:"PowerPoint for the web",exts:["odp","ppsx","pptx"],sizeLimitBytes:2147483648,editor:n.MicrosoftEditors.POWERPOINT}];class a{static initClass(){this.PRELOAD_URLS={},l=["com.adobe.Reader","Acrord32.exe","com.adobe.Acrobat","Acrobat.exe"]}static is_adobe_app(e){return Array.from(l).includes(e)}static getWopiOpenWithButtonInfo(e){let o;o=e.fq_path?e.fq_path:e.filename?e.filename:"";const t=n.file_extension(o);for(const e of _)if(-1!==e.exts.indexOf(t))return e;return null}}a.initClass();let u;const p=(o,r)=>t.__awaiter(void 0,void 0,void 0,(function*(){return(yield function(){return t.__awaiter(this,void 0,void 0,(function*(){const{UserApiV2Client:o}=yield new Promise((function(o,t){e(["./e_file_viewer_edison_shmodel_file_async"],o,t)})).then((function(e){return e.user_client_esnext}));return(new o).ns("cloud_docs")}))}()).rpc("get_cloud_editor_url",{file_id:r},{subjectUserId:o})}));function f(e){!function(e){if(void 0!==e&&void 0!==e.error&&void 0!==e.error[".tag"])e.error[".tag"]}(e)}function O(e,o,t,r,i,d,l){const _=n.generateUUID("web_open_id"),a=c.URI.parse(e.cloud_editor_url).updateQuery({cloud_editor:i,web_open_id:_});d&&a.updateQuery({ignore_lock:"1"});const u=a.toString();u&&(void 0===l&&(l=n.UserActionSourceType.WEB),s({actionEvent:n.UserActionEventType.PRE_OPEN,userId:r,docPathOrId:t,actionSource:l,data:{webOpenId:_}}),null!=o?n.redirect(u,o):n.open_tab(u))}const E=e=>({fileId:e.file_id,openToUrl:e.open_to_url}),S=({fileId:e,openToUrl:o},d,c,s,l)=>t.__awaiter(void 0,void 0,void 0,(function*(){try{const _=performance.now(),a=r.getMetricsReporter(),E={};try{E.editor=c,l&&(E.source=l[".tag"]);const r=(()=>{let e=!1;if(i.edge||i.msie||i.edgeChromium())try{e=window.self!==window.top}catch(o){e=!0}return e})();if(E.isInEdgeIframe=String(r),o&&o.startsWith("https://www.dropbox.com/scl/fi/")){E.usedOpenToURLFromFile="true";O({cloud_editor_url:o},null,e,d,c,s,l)}else{E.usedOpenToURLFromFile="false";const o=r?null:n.open_tab(n.LOADING_PAGE_URL,!0);O(r?yield((e,o)=>t.__awaiter(void 0,void 0,void 0,(function*(){return u||(u=p(e,o)),u})))(d,e):yield p(d,e),o,e,d,c,s,l)}E.error="false"}catch(e){E.error="true",f(e)}finally{a.createStats({ns:n.CLOUD_DOCS_AMP_NAMESPACE,name:"web/openWithCloudEditor"},E).recordDuration(performance.now()-_,i.TimeUnit.MILLISECONDS)}}catch(e){f(e)}}));var h;o.OpenWithCloudDocProvider=void 0,(h=o.OpenWithCloudDocProvider||(o.OpenWithCloudDocProvider={})).OfficeOnline="OfficeOnline",h.GoogleDSS="GoogleDSS";const g=(e,t,r)=>{const i=function(e,o){const t=n.getFileExt(e);for(const e of Object.keys(n.DSS_TYPE_TO_SUPPORTED_EXTS)){const o=e;if(n.DSS_TYPE_TO_SUPPORTED_EXTS[o].indexOf(t)>=0)return o}switch(t){case".gdoc":return n.GoogleFileTypes.GOOGLE_DSS_DOC;case".gsheet":return n.GoogleFileTypes.GOOGLE_DSS_SHEET;case".gslides":return n.GoogleFileTypes.GOOGLE_DSS_SLIDES}return null}(e);return i?{text:n.DSS_TYPE_TO_TEXT[i],iconUrl:n.DSS_TYPE_TO_OPEN_WITH_ICONS[i],handler:()=>S(E(e),t.id,i,!1,r),provider:o.OpenWithCloudDocProvider.GoogleDSS}:null},w=(e,t,r)=>{const i=a.getWopiOpenWithButtonInfo(e);return i?{text:i.name,spriteName:i.icon,handler:()=>S(E(e),t.id,i.editor,!1,r),provider:o.OpenWithCloudDocProvider.OfficeOnline}:null};o.OpenWith=a,o.fileToOpenWithParams=E,o.getActionSourceFromSurface=e=>"search"===e?n.UserActionSourceType.WEB_SEARCH:"previews"===e?n.UserActionSourceType.WEB_PREVIEW:"home_recent"===e||"home_starred"===e?n.UserActionSourceType.WEB_HOME:"browse"===e||"sidebar"===e?n.UserActionSourceType.WEB_BROWSE:n.UserActionSourceType.WEB,o.getCloudEditorUrl=p,o.getOpenWithCloudEditorInfo=(e,o,t,r)=>{const i=[],n=w(e,o,r);n&&t.wopi&&i.push(n);const d=g(e,o,r);return d&&t.gdd&&i.push(d),i},o.handleError=f,o.isCloudBasedDoc=function(e){return!!function(e){return[".gdoc",".gsheet",".gslides"].indexOf(n.getFileExt(e))>=0}(e)||!!function(e){return".web"===n.getFileExt(e)}(e)},o.logUserAction=s,o.openCloudEditorUrl=O,o.openWithCloudEditor=S}));
//# sourceMappingURL=c_cloud_docs_open_with_utils.js-vflbu53U7.map
