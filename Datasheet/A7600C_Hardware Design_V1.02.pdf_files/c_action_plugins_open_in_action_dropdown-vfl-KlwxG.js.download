define(["require","exports","react","./e_file_viewer_edison_shmodel_file_async","./c_tslib","./c_spectrum_tooltip","./c_extensions_extensions_utils","./c_cloud_docs_open_with_utils","./c_apex-metrics_src_types","./c_ui-icon_line_folder-show","./e_edison","./c_core_i18n","./c_ui-icon_line_add-circle","./c_lodash-es_lodash","./e_core_exception","./c_core_exception_info","./c_core_notify","react-dom","metaserver/static/js/modules/constants/env","./c_src_sink_index","metaserver/static/js/modules/constants/viewer","./c_core_xhr","./c_csrf","./c_init_data_runtime","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/file_viewer_configuration","metaserver/static/js/modules/constants/file_viewer_feature_experiments","metaserver/static/js/modules/constants/fingerprintjs_constants","metaserver/static/js/modules/constants/sharing","./c_security_util","metaserver/static/js/modules/constants/login_and_register","metaserver/static/js/modules/constants/pdf_editing","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/contacts","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/unity","metaserver/static/js/modules/constants/files_spa","./c_spectrum_modal_utility_modal","./c_spectrum_button","./c_icon_templates_actionable_index","./c_spectrum_icon_form_index","./c_ui_image","./c_account_email","./c_account_email_verify_reasons","./c_form","./c_ui_input_dig","./c_styled-components","./c_ui-icon_fill_fail","metaserver/static/js/langpack"],(function(e,t,n,o,i,s,a,r,l,c,p,u,d,m,h,f,g,_,y,A,E,w,I,O,v,C,x,b,S,k,T,F,B,M,D,N,U,L,P,j,H,W,R,V,q,$,G,J,z,K,X,Y){"use strict";function Q(e){return e&&e.__esModule?e:{default:e}}var Z=Q(n);const ee=(t,n)=>{if(o.isBrowseFile(t)&&o.isLiveFile(t)&&!o.isInsideVaultFolder(t)&&o.UnityFeatures.isUnitySupported()&&"ns_path"in t&&(null===o.UnityCheckFileCache||void 0===o.UnityCheckFileCache?void 0:o.UnityCheckFileCache.is_cached_and_locally_available(t.ns_id,t.ns_path)))return()=>i.__awaiter(void 0,void 0,void 0,(function*(){const{openInDesktopAction:o}=yield new Promise((function(t,n){e(["./c_sdk_file_viewer_action_plugins_file_actions"],t,n)}));o(t,n)}))};class te extends Z.default.Component{constructor(e){super(e),this.handleMouseOver=()=>{clearTimeout(this.timer),this.timer=setTimeout((()=>{this.props.bylines&&(this.setState({show:!0}),this.props.onDidShow())}),this.props.delay)},this.handleMouseOut=()=>{this.setState({show:!1}),clearTimeout(this.timer)},this.triggerRef=Z.default.createRef(),this.state={show:!1}}componentWillUnmount(){clearTimeout(this.timer)}render(){const{children:e,bylines:t,isInActionBar:n}=this.props,i=Z.default.Children.only(e);return t?Z.default.createElement(Z.default.Fragment,null,Z.default.createElement(o.Tooltip.Control,{triggerRef:this.triggerRef,open:this.state.show,placement:n?"right":"left"},(e=>{if(e)return e.length>1?Z.default.createElement("ul",{className:"extensions-byline-list"},e.map((e=>Z.default.createElement("li",{key:e,className:"extensions-byline-list-item"},e)))):Z.default.createElement("div",{className:"extensions-byline"},e[0])})(t)),Z.default.cloneElement(i,{onMouseOver:this.handleMouseOver,onMouseOut:this.handleMouseOut,ref:this.triggerRef})):i}}te.defaultProps={delay:500},te.displayName="ExtensionsBylineTooltip";class ne extends Z.default.Component{render(){const{unityOptions:e,legacyCloudEditorOptions:t,cloudEditorAppActions:n,bylines:i,currentSession:s,previewOption:r,openInReplayOption:p,openInDesktopOption:u,isInActionBar:d,goToFolderOption:m,wrapValuesForActionBar:h,openInNewTabOption:f}=this.props,g=e=>h?a.toActionBarValue(e):e,_=t.map((e=>{const{type:t}=e,n=t===o.OpenButtonAction.OPEN_WITH_CLOUD_DOC?"cloud_doc":"wopi";return Z.default.createElement(o.Menu.ActionItem,{key:e.text,value:g(e),withLeftAccessory:e.spriteName?Z.default.createElement(o.Sprite,{group:"web",name:e.spriteName,alt:""}):Z.default.createElement("img",{alt:"",src:e.iconUrl,width:24,height:24})},Z.default.createElement(te,{isInActionBar:d,bylines:i[n],onDidShow:o.handleShowByline(n,s),key:e.text},Z.default.createElement("span",null,e.text)))})),y=e.map((e=>Z.default.createElement(o.Menu.ActionItem,{key:e.text,value:g(e),withLeftAccessory:function(e){return"ow_desktop"===e.spriteName&&e.type===o.OpenButtonAction.UNITY_FILE?-1!==e.text.indexOf("Dropbox")?Z.default.createElement(o.UIIcon,{src:o.DropboxLine}):Z.default.createElement(o.UIIcon,{src:o.OpenLine}):Z.default.createElement(o.Sprite,{group:"web",name:e.spriteName||"",alt:""})}(e)},e.text)));let A=!1;const E=n.map((e=>{A||(A=a.isWopiAction(e.appAction));const t=e.appAction.handler.editor_name;return Z.default.createElement(o.Menu.ActionItem,{key:e.appAction.description,value:g(e),withLeftAccessory:Z.default.createElement("img",{alt:"",src:e.appAction.icon.url,width:24,height:24})},Z.default.createElement(te,{isInActionBar:d,bylines:i[t],onDidShow:o.handleShowByline(t,s),key:e.appAction.description},Z.default.createElement("span",null,e.appAction.description)))})),w=r&&Z.default.createElement(o.Menu.ActionItem,{key:r.text,value:g(r),withLeftAccessory:Z.default.createElement(o.UIIcon,{src:o.ShowLine})},r.text),I=p&&Z.default.createElement(o.Menu.ActionItem,{key:p.text,value:g(p),withLeftAccessory:Z.default.createElement(o.UIIcon,{src:c.DropboxReplayLine})},p.text),O=u&&Z.default.createElement(o.Menu.ActionItem,{key:u.text,value:g(u),withLeftAccessory:Z.default.createElement(o.UIIcon,{src:l.mac?c.FinderLine:c.FileExplorerLine})},u.text),v=f&&Z.default.createElement(o.Menu.ActionItem,{key:f.text,value:g(f),withLeftAccessory:Z.default.createElement(o.UIIcon,{src:o.GlobeLine})},f.text),C=m&&Z.default.createElement(o.Menu.ActionItem,{key:m.text,value:g(m),withLeftAccessory:Z.default.createElement(o.UIIcon,{src:c.FolderShowLine})},m.text),x=y.length>0||_.length>0||E.length>0||!!v||!!w||!!I||!!O||!!C;return A?x&&Z.default.createElement(o.Menu.Segment,{key:"open-options"},v,C,E,y,_,w,I,O):x&&Z.default.createElement(o.Menu.Segment,{key:"open-options"},v,C,y,_,E,w,I,O)}}ne.displayName="UnityAndCloudEditorsComponent";const oe=o.requireCssWithComponent(ne,["/static/metaserver/static/css/app_actions/index-vflS9Xtlh.css","/static/metaserver/static/css/dig-components/index.web-vfleuI413.css"]);class ie extends Z.default.Component{constructor(e){super(e),this.createActionClickHandler=e=>()=>{if("cloud_editor"===e.handler[".tag"]){const t=a.isWopiAction(e)?o.OpenButtonAction.OPEN_WITH:o.OpenButtonAction.OPEN_WITH_CLOUD_DOC;o.logEvent$1(this.props.currentSession,"select_legacy_action",{type:t});const n=o.UserActionSourceType.WEB_PREVIEW,i=a.cloudEditorNameToParams(e.handler.editor_name);r.openWithCloudEditor(r.fileToOpenWithParams(this.props.file),this.props.user.id,i,!1,n)}}}render(){if(0===this.props.openOptions.length&&0===this.props.cloudEditorAppActions.length)return null;const e=this.props.cloudEditorAppActions.map((e=>({appAction:e,handler:this.createActionClickHandler(e),userAction:o.OpenInUserAction.OpenWithAppAction,actionName:e.description})));return Z.default.createElement(oe,{unityOptions:[],legacyCloudEditorOptions:this.props.openOptions,cloudEditorAppActions:e,bylines:{},wrapValuesForActionBar:!!this.props.isInActionBar})}}ie.displayName="SharedFilePopoverContentComponent";const se=o.requireCssWithComponent(ie,["/static/metaserver/static/css/app_actions/index-vflS9Xtlh.css"]);class ae extends Z.default.Component{constructor(e){super(e),this.createAppActionClickHandler=e=>()=>{var t,n;const{file:i,user:s,featureFlags:r,telemetryContext:l,updateLinkState:c}=this.props;if(a.redirectToActionOrShowAuth(s,[i],e,r,l,c),"redirect"===e.handler[".tag"]){const t=o.getAppActionExtras(e);o.logEvent$1(this.props.currentSession,"select_action",Object.assign({menu_version:2},t))}else if("cloud_editor"===e.handler[".tag"]){const t=a.isWopiAction(e)?o.OpenButtonAction.OPEN_WITH:o.OpenButtonAction.OPEN_WITH_CLOUD_DOC;o.logEvent$1(this.props.currentSession,"select_legacy_action",{type:t})}null===(n=(t=this.props).onExtensionClick)||void 0===n||n.call(t,e.id)},this.wrapperForAction=e=>({appAction:e,handler:this.createAppActionClickHandler(e),userAction:o.OpenInUserAction.OpenWithAppAction,actionName:e.description}),this.renderActionRow=e=>{const t=e.icon;let n;n=t.is_static?p.static_url("/static/metaserver/static/images/generic_app_icon-vflIPYT1H.png"):t.url;const i=e.description,s=this.props.isInActionBar?a.toActionBarValue(this.wrapperForAction(e)):this.wrapperForAction(e);return Z.default.createElement(o.Menu.ActionItem,{key:e.id,value:s,withLeftAccessory:Z.default.createElement("img",{alt:"",src:n,width:24,height:24})},i)},this.renderUnpromotedActions=(e,t)=>{const{user:n,file:i,categoryIdToInfos:s,featureFlags:r,currentSession:l,telemetryContext:c,updateLinkState:p,isInActionBar:m}=this.props,h=e.length>0,f={handler:()=>{const d=[...e,...t];a.showExtensionsMiniDirectoryModal(u.intl.formatMessage({id:"KVD2SP",defaultMessage:"Open or edit with these apps"}),n,i,d,s,r,p,c,l),o.logEvent$1(l,h?"select_show_more":"select_add_app",{surface:c&&c.surface})}},g=m?a.toActionBarValue(f):f;return Z.default.createElement(o.Menu.ActionItem,{key:u.intl.formatMessage({id:"R/67N/",defaultMessage:"Show more"}),value:g,withLeftAccessory:h&&!m?null:Z.default.createElement(o.UIIcon,{src:d.AddCircleLine})},h?u.intl.formatMessage({id:"Gevpqz",defaultMessage:"Connect more apps"}):u.intl.formatMessage({id:"XFA09U",defaultMessage:"Connect apps"}))}}render(){const{appActions:e,openOptions:t,bylines:n,currentSession:i,isInActionBar:s}=this.props,a=o.getOpenOptionsWithLogging(t,i),{unityOptions:r,cloudEditorOptions:l,previewOption:c,openInReplayOption:p,openInDesktopOption:u,goToFolderOption:d,openInNewTabOption:m}=o.partitionOptions(a),{cloudEditors:h,installedActions:f,unpromotedActions:g}=o.partitionActions(e),_=f.length>0,y=g.length>0;return Z.default.createElement(Z.default.Fragment,null,Z.default.createElement(oe,{isInActionBar:s,unityOptions:r,legacyCloudEditorOptions:l,cloudEditorAppActions:h.map((e=>this.wrapperForAction(e))),bylines:n,currentSession:i,previewOption:c,openInReplayOption:p,openInNewTabOption:m,openInDesktopOption:u,goToFolderOption:d,wrapValuesForActionBar:!!s}),s&&(_||y)&&Z.default.createElement(o.Menu.Segment,null,f.map((e=>this.renderActionRow(e))),this.renderUnpromotedActions(f,g)),!s&&_&&Z.default.createElement(o.Menu.Segment,{key:"installed-actions"},f.map((e=>this.renderActionRow(e)))),!s&&y&&Z.default.createElement(o.Menu.Segment,null,this.renderUnpromotedActions(f,g)))}}ae.displayName="ExtensionsPopoverV2Component";const re=o.requireCssWithComponent(ae,["/static/metaserver/static/css/app_actions/index-vflS9Xtlh.css"]);class le extends Z.default.Component{constructor(e){super(e),this.handleButtonClick=e=>{e.preventDefault(),e.stopPropagation()},this.handleMenuClick=e=>{e.preventDefault(),e.stopPropagation()},this.handleHover=()=>{this.currentSession&&this.currentSession.event("trigger_hover")},this.setBigTooltip=e=>i.__awaiter(this,void 0,void 0,(function*(){const{file:t,appActions:n,featureFlags:i}=this.props,s=o.getFileExt$1(t)||"",a=n.length>0;if(a){const t=yield o.getTooltipHistory(e,["open_with_edu"]),n=o.allowedTooltips(a,s,i).find((e=>void 0!==t[e]&&!t[e]));this.setState({bigTooltipName:n})}})),this.markBigTooltipViewed=()=>{let e=!1;const t=[];this.state.bigTooltipName&&(t.push(o.markTooltipViewed(this.props.user.id,this.state.bigTooltipName)),e=!0),e&&(Promise.all(t).then((()=>{this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)})),this.setState({bigTooltipName:void 0}))},this.handleSelectAction=(e,t)=>{t.preventDefault(),e.handler(),this.props.onExtensionClick&&this.props.onExtensionClick(e.actionName||e.userAction),t.stopPropagation()},this.renderTrigger=e=>{const{triggerType:t}=this.props,n=Object.assign({onMouseDown:this.markBigTooltipViewed,onMouseEnter:this.handleHover},e),i="app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",a=u.intl.formatMessage({id:"z5t3Bh",defaultMessage:"Open"}),r=m.uniqueId("app-action-open-with-menu-");return t===o.TriggerType.OpacityButton?Z.default.createElement(o.Button,Object.assign({id:r,variant:"opacity",withDropdownIcon:!0},n,{"aria-labelledby":o.cx(r,this.props.arialabelledby)}),a):t===o.TriggerType.CollapsedButton?Z.default.createElement(s.Tooltip,{positionOffset:8,positioning:"left",tooltipContent:u.intl.formatMessage({id:"KEegJt",defaultMessage:"Open With"})},Z.default.createElement(o.IconButton,Object.assign({id:r,variant:"transparent",className:i,"aria-label":a,"aria-labelledby":o.cx(r,this.props.arialabelledby)},n),Z.default.createElement(o.UIIcon,{src:o.OpenLine}))):Z.default.createElement(o.Button,Object.assign({id:r,className:i,variant:t&&t!==o.TriggerType.SecondaryButton?"primary":"opacity","aria-label":a,"aria-labelledby":o.cx(r,this.props.arialabelledby)},n),Z.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},Z.default.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},`${a} ▾`)))},this.renderMenu=()=>Z.default.createElement(o.Menu.Wrapper,{className:"app-actions__unportaled-menu",onSelection:this.handleSelectAction,onToggle:this.onPopoverToggle,isPortaled:!0},(({getContentProps:e,getTriggerProps:t})=>Z.default.createElement(Z.default.Fragment,null,this.renderTrigger(t({onClick:this.handleButtonClick})),Z.default.createElement(o.Menu.Content,Object.assign({},e({}),{onClick:this.handleMenuClick,className:"app-actions-open-with-menu",placement:"bottom-end"}),Z.default.createElement(de,{user:this.props.user,file:this.props.file,extraOptions:this.props.extraOptions,currentSession:this.currentSession,telemetryContext:this.props.telemetryContext}))))),this.onPopoverToggle=({isOpen:e})=>{e&&this.props.onDropdownOpen?this.props.onDropdownOpen():!e&&this.props.onDropdownClose&&this.props.onDropdownClose(),this.currentSession&&this.currentSession.event(e?"open_popover":"close_popover")},this.onDownloadClick=e=>t=>{t.preventDefault(),t.stopPropagation(),e.handler()},this.state={},this.telemetryClient=o.createTelemetryClient({component:"menu_v2"})}componentDidMount(){this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)}render(){const{file:e,appActions:t,featureFlags:n,telemetryContext:i,triggerType:s,showAsButtonIfDownloadOnly:r,unityInfo:l,extraOptions:c,user:p,cloudDocsInfo:d}=this.props;if(!e.file_id)return null;i?this.currentSession=this.telemetryClient.session({surface:i.surface,ext:o.getPiiSafeExtension(o.getFileExt$1(e)||""),feature_flags:n}):delete this.currentSession;const h=a.getOpenOptionsForFile({file:e,unityInfo:l,extraOptions:c,user:p,isCloudEditorDisabled:!0,cloudDocsInfo:d,surface:null==i?void 0:i.surface}),f=s===o.TriggerType.CollapsedButton;let g=h.length>0,_=!1;if(g&&1===h.length&&(_=h[0].type===o.OpenButtonAction.DOWNLOAD,g=!_),!g&&(0===t.length||o.isSharedFile(e)&&0===o.partitionActions(t).cloudEditors.length)){if(r&&_){const e={className:o.cx("app-actions-download-button",{"app-actions-download-button--collapsed":f}),onClick:this.onDownloadClick(h[0])},t=m.uniqueId("app-actions-download-button-");return f?Z.default.createElement(o.IconButton,Object.assign({id:t,variant:"transparent","aria-labelledby":o.cx(t,this.props.arialabelledby)},e),Z.default.createElement(o.UIIcon,{name:"download-file",src:o.DownloadLine,"aria-label":u.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"})})):Z.default.createElement(o.Button,Object.assign({id:t,variant:"opacity","aria-labelledby":o.cx(t,this.props.arialabelledby)},e),u.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"}))}return null}return this.renderMenu()}}le.displayName="ExtensionsMenuV2Component";const ce=e=>{const t=o.useUnity(e.file,e.user);return Z.default.createElement(le,Object.assign({},e,{unityInfo:t}))};ce.displayName="ExtensionsMenuV2WithUnityComponent";const pe={updateLinkState:(e,t)=>o.updateLinkState({actionId:e,linkState:t})},ue=o.connect(((e,t)=>({appActions:o.getOpenActionsForFile(e,t.file),bylines:o.getBylines(e),categoryInfos:o.getCategoryInfos(e),featureFlags:o.getFeatureFlags(e),cloudDocsInfo:o.getCloudDocInfo(e)})),pe)(ce);o.requireCssWithComponent(ue,["/static/metaserver/static/css/app_actions/index-vflS9Xtlh.css","/static/metaserver/static/css/dig-components/index.web-vfleuI413.css"]);const de=e=>{const{file:t,user:n,telemetryContext:i,extraOptions:s,isInActionBar:r,previewActionHandler:l,openDesktopActionHandler:c,goToFolderActionHandler:p,replayActionHandler:u,openInNewTabActionHandler:d,onExtensionClick:m}=e,h=o.useSelector((t=>o.getOpenActionsForFile(t,e.file))),f=o.useSelector((e=>o.getBylines(e))),g=o.useSelector((e=>o.getCategoryInfos(e))),_=o.useSelector((e=>o.getFeatureFlags(e))),y=o.useSelector((e=>o.getCloudDocInfo(e))),A=o.useDispatch(),E=Z.default.useCallback(((e,t)=>A(o.updateLinkState({actionId:e,linkState:t}))),[A]),w=o.useUnity(t,n),I=a.getCategoryIdToInfos(g),O=a.getOpenOptionsForFile({file:t,unityInfo:w,extraOptions:s,user:n,isCloudEditorDisabled:!0,cloudDocsInfo:y,surface:null==i?void 0:i.surface,isInActionBar:r,previewActionHandler:l,openDesktopActionHandler:c,goToFolderActionHandler:p,replayActionHandler:u,openInNewTabActionHandler:d}),v=i&&(e.currentSession||o.createTelemetryClient({component:"menu_v2"}).session({surface:i.surface,ext:o.getPiiSafeExtension(o.getFileExt$1(t)||""),feature_flags:_}));if(o.isBrowseFile(t)&&(h.length>0||O.length>0))return Z.default.createElement(re,{file:t,user:n,openOptions:O,appActions:h,bylines:f,categoryIdToInfos:I,featureFlags:_,updateLinkState:E,telemetryContext:i,currentSession:v,isInActionBar:r,onExtensionClick:m});if(o.isSharedFile(t)){const{cloudEditors:e}=o.partitionActions(h);return Z.default.createElement(se,{openOptions:O,cloudEditorAppActions:e,file:t,user:n,currentSession:v,isInActionBar:r})}return null};de.displayName="ExtensionsPopoverContent";const me={[o.OpenInUserAction.OpenInUnityFolder]:"desktop_folder",[o.OpenInUserAction.OpenInUnity]:"desktop_preview",[o.OpenInUserAction.OpenInReplay]:"replay_preview",[o.OpenInUserAction.PreviewFile]:"web_preview"},he={surface:"previews"},fe=({actionContext:e,file:t,user:n})=>{const{logUserAction:i,pluginContext:s,fileViewerId:a}=o.useFileViewerContext(),r=o.useReplayActionHandler(t,s),l=Z.default.useMemo((()=>({sessionId:a,event:(t,n)=>{var s;const a="string"==typeof(null==n?void 0:n.userAction)?n.userAction:"",r=null!==(s=me[a])&&void 0!==s?s:"third_party_app";i(o.UserAction.OpenIn,e,{destination_surface:r})}})),[e,a,i]);return Z.default.createElement(de,{key:"open-in-action-btn",file:t,user:n,isInActionBar:!0,openDesktopActionHandler:ee(t,n),replayActionHandler:r,currentSession:l,telemetryContext:he})};fe.displayName="OpenInMenuContent";const ge=o.withActionCondition(o.openInActionConditions,((e,t)=>t?{icon:o.OpenLine,label:o.OPEN_IN_ACTION_STRING,disabled:{disabled:!1},userAction:o.UserAction.OpenIn,action:{type:"menu",menu:Z.default.createElement(o.Provider,{store:o.getStore()},Z.default.createElement(fe,{user:e.user,file:e.file,actionContext:o.UserActionContext.FileMenu}))}}:void 0),void 0);t.OpenInMenuContent=fe,t.makeOpenInAction=ge}));
//# sourceMappingURL=c_action_plugins_open_in_action_dropdown.js-vflFQshlI.map
